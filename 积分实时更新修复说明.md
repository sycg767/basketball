# 积分实时更新修复说明

## 问题描述

在预订创建页面，用户的可用积分不能及时更新。当用户在其他地方使用了积分后，返回预订页面时仍然显示旧的积分数量。

## 问题原因

`fetchUserPoints` 函数只在页面加载时（`onMounted`）调用一次，之后不会自动刷新。如果用户积分发生变化，页面不会感知到。

## 修复方案

### 1. 强制刷新积分

**修改位置**：`basketball-web/src/views/booking/Create.vue:390-401`

**修改前**：
```javascript
const fetchUserPoints = async () => {
  try {
    // 先尝试从store获取
    userPoints.value = userStore.points || 0;

    // 如果store中没有，重新获取用户信息
    if (userPoints.value === 0) {
      await userStore.getUserInfo();
      userPoints.value = userStore.points || 0;
    }
  } catch (error) {
    console.error('获取用户积分失败:', error);
    userPoints.value = 0;
  }
};
```

**修改后**：
```javascript
const fetchUserPoints = async () => {
  try {
    // 每次都重新获取最新的用户信息，确保积分是最新的
    await userStore.getUserInfo();
    userPoints.value = userStore.points || 0;

    console.log('用户积分:', userPoints.value);
  } catch (error) {
    console.error('获取用户积分失败:', error);
    userPoints.value = 0;
  }
};
```

### 2. 监听页面可见性

**修改位置**：`basketball-web/src/views/booking/Create.vue:466-479`

**新增代码**：
```javascript
// 监听页面可见性，当页面重新可见时刷新积分
onMounted(() => {
  const handleVisibilityChange = () => {
    if (document.visibilityState === 'visible') {
      fetchUserPoints();
    }
  };
  document.addEventListener('visibilitychange', handleVisibilityChange);

  // 组件卸载时移除监听
  onUnmounted(() => {
    document.removeEventListener('visibilitychange', handleVisibilityChange);
  });
});
```

### 3. 添加必要的导入

**修改位置**：`basketball-web/src/views/booking/Create.vue:198`

```javascript
import { ref, reactive, computed, onMounted, onUnmounted } from 'vue';
```

## 工作原理

1. **强制刷新**：每次调用 `fetchUserPoints` 时，都从后端重新获取最新的用户信息，而不是依赖缓存
2. **页面可见性监听**：当用户切换回预订页面时（比如从其他标签页返回），自动刷新积分
3. **内存清理**：组件卸载时移除事件监听，避免内存泄漏

## 触发场景

积分会在以下情况自动刷新：
- ✅ 页面首次加载
- ✅ 用户从其他标签页切换回来
- ✅ 用户最小化浏览器后恢复

## 用户体验改进

- 用户在其他页面使用积分后，返回预订页面时会看到最新的积分余额
- 无需手动刷新页面
- 积分信息始终保持最新

## 修改文件

- `basketball-web/src/views/booking/Create.vue`

## 总结

通过强制刷新和页面可见性监听，确保用户在预订页面看到的积分始终是最新的，提升了用户体验。
