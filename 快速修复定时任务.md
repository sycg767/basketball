# 快速修复定时任务失败问题

## 🚨 问题描述

定时任务一直执行失败，错误信息：
```
com.basketball.common.exception.BusinessException: 通知模板不存在或已禁用
```

## ⚡ 快速修复步骤（5分钟）

### 步骤1：执行数据库脚本（1分钟）

打开 MySQL 命令行或 Navicat，执行以下 SQL：

```sql
-- 添加缺失的预订开始提醒模板
INSERT INTO `notification_template`
(`template_code`, `template_name`, `template_type`, `scene`, `title`, `content`, `variables`, `priority`, `status`, `remark`)
VALUES
('BOOKING_START_REMINDER', '预订开始提醒', 'system', 'booking_remind', '预订即将开始',
'您的场地预订将在1小时后开始，请准时到场', '[]', 3, 1, '预订开始提醒');

-- 验证是否插入成功
SELECT * FROM notification_template WHERE template_code = 'BOOKING_START_REMINDER';
```

### 步骤2：重新编译项目（2分钟）

```bash
cd c:\Users\X\Desktop\basketball\basketball-system
mvn clean compile
```

### 步骤3：重启应用（2分钟）

1. 停止当前运行的 Spring Boot 应用
2. 重新启动：
   ```bash
   mvn spring-boot:run
   ```

### 步骤4：验证修复（1分钟）

查看应用日志，确认定时任务执行成功，不再出现错误信息。

---

## ✅ 验证成功标志

日志中应该看到类似信息：
```
2025-10-22 18:00:00 [scheduling-1] INFO  c.b.service.impl.ScheduledReminderServiceImpl - 定时提醒执行成功: reminderId=77, userId=4
```

而不是：
```
2025-10-22 18:00:00 [scheduling-1] ERROR c.b.service.impl.ScheduledReminderServiceImpl - 定时提醒执行失败: reminderId=77
com.basketball.common.exception.BusinessException: 通知模板不存在或已禁用
```

---

## 📋 已修复的问题

1. ✅ 修复了 `ScheduledReminderServiceImpl` 中的模板编码映射
   - `member_expire_7` → `MEMBER_EXPIRE_7DAYS`
   - `member_expire_3` → `MEMBER_EXPIRE_3DAYS`
   - `course_start` → `COURSE_START_REMIND`
   - `booking_start` → `BOOKING_START_REMINDER`

2. ✅ 添加了缺失的 `BOOKING_START_REMINDER` 模板

3. ✅ 新增了完整的通知模板管理功能（详见《通知模板管理功能使用指南.md》）

---

## 🔍 问题根源分析

### 代码中使用的模板编码
```java
case "course_start":
    return "COURSE_START_REMINDER";  // ❌ 数据库中不存在
case "booking_start":
    return "BOOKING_START_REMINDER"; // ❌ 数据库中不存在
case "member_expire_7":
    return "MEMBER_EXPIRE_REMINDER"; // ❌ 数据库中不存在
```

### 数据库中实际的模板编码
```sql
SELECT template_code FROM notification_template;
-- 结果：
-- MEMBER_EXPIRE_7DAYS     ✅ 存在
-- MEMBER_EXPIRE_3DAYS     ✅ 存在
-- COURSE_START_REMIND     ✅ 存在
-- BOOKING_START_REMINDER  ❌ 不存在（需要添加）
```

### 修复后的代码
```java
case "member_expire_7":
    return "MEMBER_EXPIRE_7DAYS";    // ✅ 匹配数据库
case "member_expire_3":
    return "MEMBER_EXPIRE_3DAYS";    // ✅ 匹配数据库
case "course_start":
    return "COURSE_START_REMIND";    // ✅ 匹配数据库
case "booking_start":
    return "BOOKING_START_REMINDER"; // ✅ 已添加到数据库
```

---

## 🎯 后续建议

1. **使用通知模板管理功能**
   - 访问：`http://localhost:5173/admin/notification-templates`
   - 可视化管理所有通知模板
   - 避免模板编码不一致问题

2. **定期检查定时任务日志**
   - 位置：`basketball-system/logs/`
   - 关注 ERROR 级别日志

3. **新增模板时的注意事项**
   - 模板编码必须与代码中使用的一致
   - 建议先在管理页面创建模板，再在代码中使用

---

## 📞 如果问题仍未解决

### 检查清单

1. **数据库检查**
   ```sql
   -- 检查模板是否存在
   SELECT * FROM notification_template
   WHERE template_code IN (
     'MEMBER_EXPIRE_7DAYS',
     'MEMBER_EXPIRE_3DAYS',
     'COURSE_START_REMIND',
     'BOOKING_START_REMINDER'
   );

   -- 检查模板状态是否启用
   SELECT template_code, status FROM notification_template
   WHERE status = 0;  -- 0表示禁用
   ```

2. **代码检查**
   - 确认 `ScheduledReminderServiceImpl.java` 已修改
   - 确认项目已重新编译
   - 确认应用已重启

3. **日志检查**
   ```bash
   # 查看最新日志
   tail -f basketball-system/logs/spring.log

   # 搜索错误信息
   grep "通知模板不存在" basketball-system/logs/spring.log
   ```

4. **定时任务检查**
   ```sql
   -- 查看待执行的提醒
   SELECT * FROM scheduled_reminder
   WHERE status = 0
   ORDER BY remind_time DESC
   LIMIT 10;
   ```

---

**修复完成时间：** 2025-10-22
**预计修复时间：** 5分钟
**难度等级：** ⭐ 简单
