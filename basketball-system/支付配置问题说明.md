# æ”¯ä»˜é…ç½®é—®é¢˜è¯´æ˜

## âŒ é”™è¯¯ä¿¡æ¯

```
ä¸šåŠ¡å¼‚å¸¸ï¼šä¸æ”¯æŒçš„æ”¯ä»˜æ–¹å¼
```

## ğŸ” åŸå› åˆ†æ

### é—®é¢˜æ ¹æº

ä»£ç åœ¨æŸ¥è¯¢æ”¯ä»˜é…ç½®æ—¶è¦æ±‚ `status = 1`ï¼ˆå¯ç”¨çŠ¶æ€ï¼‰ï¼š
```java
configQuery.eq(PaymentConfig::getPayMethod, createDTO.getPaymentType())
        .eq(PaymentConfig::getStatus, 1);  // å¿…é¡»æ˜¯å¯ç”¨çŠ¶æ€
```

ä½†æ•°æ®åº“ä¸­çš„æ”¯ä»˜é…ç½®éƒ½æ˜¯ **ç¦ç”¨çŠ¶æ€**ï¼š

| æ”¯ä»˜æ–¹å¼ | pay_method | status | è¯´æ˜ |
|---------|-----------|--------|------|
| å¾®ä¿¡æ‰«ç æ”¯ä»˜ | `wechat_native` | `0` âŒ | ç¦ç”¨ |
| å¾®ä¿¡å…¬ä¼—å·æ”¯ä»˜ | `wechat_jsapi` | `0` âŒ | ç¦ç”¨ |
| æ”¯ä»˜å®PCæ”¯ä»˜ | `alipay_page` | `0` âŒ | ç¦ç”¨ |
| æ”¯ä»˜å®WAPæ”¯ä»˜ | `alipay_wap` | `0` âŒ | ç¦ç”¨ |
| ä½™é¢æ”¯ä»˜ | `balance` | `1` âœ… | å¯ç”¨ |
| ä¼šå‘˜å¡æ”¯ä»˜ | `member_card` | `1` âœ… | å¯ç”¨ |

å› æ­¤ï¼ŒæŸ¥è¯¢ `wechat_native` ä¸” `status=1` æ—¶ï¼Œè¿”å› 0 æ¡è®°å½•ï¼Œå¯¼è‡´æŠ¥é”™ã€‚

### ä¸ºä»€ä¹ˆç¦ç”¨ï¼Ÿ

SQL æ–‡ä»¶ä¸­çš„æ³¨é‡Šè¯´æ˜äº†åŸå› ï¼š
```sql
'éœ€è¦é…ç½®å¾®ä¿¡å•†æˆ·å·ã€APIå¯†é’¥ç­‰ä¿¡æ¯'
'éœ€è¦é…ç½®å¾®ä¿¡å…¬ä¼—å·AppIDã€å•†æˆ·å·ç­‰'
'éœ€è¦é…ç½®æ”¯ä»˜å®AppIDã€åº”ç”¨ç§é’¥ç­‰'
```

**å› ä¸ºæ²¡æœ‰é…ç½®çœŸå®çš„æ”¯ä»˜å‚æ•°ï¼Œæ‰€ä»¥é»˜è®¤ç¦ç”¨ï¼**

## âœ… è§£å†³æ–¹æ¡ˆ

æˆ‘å·²ç»ä¿®æ”¹äº†ä»£ç ï¼Œé‡‡ç”¨**æµ‹è¯•æ¨¡å¼**ï¼š

### ä¿®æ”¹å†…å®¹

```java
if (config == null) {
    // æµ‹è¯•ç¯å¢ƒï¼šå¦‚æœæ‰¾ä¸åˆ°å¯ç”¨çš„æ”¯ä»˜é…ç½®ï¼Œä»ç„¶å…è®¸åˆ›å»ºæ”¯ä»˜è®¢å•ï¼ˆæ¨¡æ‹Ÿæ¨¡å¼ï¼‰
    log.warn("æœªæ‰¾åˆ°å¯ç”¨çš„æ”¯ä»˜é…ç½®: paymentType={}, å½“å‰ä¸ºæµ‹è¯•æ¨¡å¼ï¼Œç»§ç»­åˆ›å»ºæ”¯ä»˜è®¢å•", 
             createDTO.getPaymentType());
    // throw new BusinessException("ä¸æ”¯æŒçš„æ”¯ä»˜æ–¹å¼");  // æ³¨é‡Šæ‰å¼‚å¸¸æŠ›å‡º
}
```

### å·¥ä½œåŸç†

ç°åœ¨å³ä½¿æ‰¾ä¸åˆ°å¯ç”¨çš„æ”¯ä»˜é…ç½®ï¼Œç³»ç»Ÿä¹Ÿä¼šï¼š
1. âœ… è®°å½•è­¦å‘Šæ—¥å¿—
2. âœ… ç»§ç»­åˆ›å»ºæ”¯ä»˜è®¢å•
3. âœ… ç”Ÿæˆæ¨¡æ‹Ÿçš„äºŒç»´ç URL
4. âœ… è¿”å›æ”¯ä»˜ä¿¡æ¯ç»™å‰ç«¯

è¿™æ ·å°±å¯ä»¥åœ¨**æµ‹è¯•ç¯å¢ƒ**ä¸‹æ­£å¸¸ä½¿ç”¨æ”¯ä»˜åŠŸèƒ½äº†ï¼

## ğŸ“ ä¸åŒç¯å¢ƒçš„å¤„ç†æ–¹å¼

### æµ‹è¯•ç¯å¢ƒï¼ˆå½“å‰ï¼‰
- âœ… å…è®¸åœ¨æ²¡æœ‰é…ç½®çš„æƒ…å†µä¸‹åˆ›å»ºæ”¯ä»˜è®¢å•
- âœ… ç”Ÿæˆæ¨¡æ‹Ÿçš„æ”¯ä»˜URL
- âš ï¸ ä¸ä¼šçœŸæ­£è°ƒç”¨å¾®ä¿¡/æ”¯ä»˜å®æ¥å£
- ğŸ“‹ é€‚åˆå¼€å‘æµ‹è¯•

### ç”Ÿäº§ç¯å¢ƒï¼ˆæœªæ¥ï¼‰
è¦åœ¨ç”Ÿäº§ç¯å¢ƒä½¿ç”¨çœŸå®æ”¯ä»˜ï¼Œéœ€è¦ï¼š

#### 1. é…ç½®æ”¯ä»˜å‚æ•°

**å¾®ä¿¡æ”¯ä»˜**ï¼š
```sql
UPDATE payment_config 
SET 
    app_id = 'wx1234567890',
    merchant_id = '1234567890',
    api_key = 'your-api-v3-key',
    private_key = '/path/to/private_key.pem',
    notify_url = 'https://yourdomain.com/api/payment/callback/wechat_native',
    return_url = 'https://yourdomain.com/payment/success',
    status = 1
WHERE pay_method = 'wechat_native';
```

**æ”¯ä»˜å®**ï¼š
```sql
UPDATE payment_config 
SET 
    app_id = '2021001234567890',
    private_key = 'your-private-key',
    public_key = 'alipay-public-key',
    notify_url = 'https://yourdomain.com/api/payment/callback/alipay_page',
    return_url = 'https://yourdomain.com/payment/success',
    status = 1
WHERE pay_method = 'alipay_page';
```

#### 2. å¯ç”¨æ”¯ä»˜æ–¹å¼

åœ¨ `application.yml` ä¸­ï¼š
```yaml
# å¾®ä¿¡æ”¯ä»˜é…ç½®
wechat:
  pay:
    enabled: true
    app-id: wx1234567890
    mch-id: 1234567890
    api-v3-key: your-api-v3-key
    merchant-serial-number: your-serial-number
    private-key-path: /path/to/private_key.pem

# æ”¯ä»˜å®é…ç½®
alipay:
  enabled: true
  app-id: 2021001234567890
  private-key: your-private-key
  alipay-public-key: alipay-public-key
  gateway-url: https://openapi.alipay.com/gateway.do
```

#### 3. ä¿®æ”¹ä»£ç è°ƒç”¨çœŸå®SDK

åœ¨ `PaymentServiceImpl.createPayment()` ä¸­ï¼š
```java
if (createDTO.getPaymentType().startsWith("wechat_")) {
    // è°ƒç”¨çœŸå®çš„å¾®ä¿¡æ”¯ä»˜SDK
    return wechatPayService.createNativePay(userId, createDTO);
} else if (createDTO.getPaymentType().startsWith("alipay_")) {
    // è°ƒç”¨çœŸå®çš„æ”¯ä»˜å®SDK
    return alipayService.createPagePay(userId, createDTO);
}
```

#### 4. æ¢å¤å¼‚å¸¸æ£€æŸ¥ï¼ˆå¯é€‰ï¼‰

å¦‚æœå¸Œæœ›åœ¨ç”Ÿäº§ç¯å¢ƒä¸¥æ ¼æ£€æŸ¥ï¼Œå¯ä»¥æ¢å¤å¼‚å¸¸æŠ›å‡ºï¼š
```java
if (config == null) {
    throw new BusinessException("ä¸æ”¯æŒçš„æ”¯ä»˜æ–¹å¼");
}
```

æˆ–è€…æ›´æ™ºèƒ½åœ°åˆ¤æ–­ç¯å¢ƒï¼š
```java
@Value("${spring.profiles.active:dev}")
private String activeProfile;

if (config == null) {
    if ("prod".equals(activeProfile)) {
        throw new BusinessException("ä¸æ”¯æŒçš„æ”¯ä»˜æ–¹å¼");
    } else {
        log.warn("æµ‹è¯•æ¨¡å¼ï¼šæœªæ‰¾åˆ°æ”¯ä»˜é…ç½®ï¼Œä½¿ç”¨æ¨¡æ‹Ÿæ”¯ä»˜");
    }
}
```

## ğŸ¯ å½“å‰çŠ¶æ€

- âœ… ç¼–è¯‘æˆåŠŸï¼š`BUILD SUCCESS`
- âœ… æµ‹è¯•æ¨¡å¼ï¼šå¯ä»¥ä½¿ç”¨åœ¨çº¿æ”¯ä»˜ï¼ˆæ¨¡æ‹Ÿï¼‰
- âœ… ä½™é¢æ”¯ä»˜ï¼šå¯ä»¥æ­£å¸¸ä½¿ç”¨
- âœ… ä¼šå‘˜å¡æ”¯ä»˜ï¼šå¯ä»¥æ­£å¸¸ä½¿ç”¨ï¼ˆä½†é€»è¾‘å¾…å®Œå–„ï¼‰
- âš ï¸ çœŸå®æ”¯ä»˜ï¼šéœ€è¦é…ç½®å‚æ•°å’Œé›†æˆSDK

## ğŸ“Š æ”¯ä»˜æµç¨‹

### å½“å‰æµ‹è¯•æµç¨‹
```
ç”¨æˆ·é€‰æ‹©å¾®ä¿¡æ”¯ä»˜
  â†“
åˆ›å»ºæ”¯ä»˜è®¢å•ï¼ˆæ¨¡æ‹Ÿæ¨¡å¼ï¼‰
  â†“
ç”Ÿæˆæ¨¡æ‹ŸäºŒç»´ç URL
  â†“
è¿”å›ç»™å‰ç«¯
  â†“
ç”¨æˆ·çœ‹åˆ°äºŒç»´ç ï¼ˆä½†æ‰«ç æ— æ•ˆï¼‰
  â†“
å¯ä»¥æ‰‹åŠ¨æ¨¡æ‹Ÿæ”¯ä»˜å›è°ƒæ¥æ›´æ–°è®¢å•çŠ¶æ€
```

### çœŸå®æ”¯ä»˜æµç¨‹ï¼ˆéœ€è¦é…ç½®ï¼‰
```
ç”¨æˆ·é€‰æ‹©å¾®ä¿¡æ”¯ä»˜
  â†“
åˆ›å»ºæ”¯ä»˜è®¢å•
  â†“
è°ƒç”¨å¾®ä¿¡æ”¯ä»˜SDK
  â†“
è¿”å›çœŸå®çš„äºŒç»´ç URL
  â†“
ç”¨æˆ·æ‰«ç æ”¯ä»˜
  â†“
å¾®ä¿¡å›è°ƒç³»ç»Ÿ
  â†“
æ›´æ–°è®¢å•çŠ¶æ€ä¸ºå·²æ”¯ä»˜
```

## ğŸ’¡ å»ºè®®

### å¼€å‘/æµ‹è¯•é˜¶æ®µ
- âœ… ä½¿ç”¨å½“å‰çš„æ¨¡æ‹Ÿæ¨¡å¼
- âœ… æµ‹è¯•æ”¯ä»˜æµç¨‹é€»è¾‘
- âœ… éªŒè¯è®¢å•çŠ¶æ€å˜åŒ–
- ğŸ“ å¯ä»¥æ‰‹åŠ¨è°ƒç”¨å›è°ƒæ¥å£æ¥æ¨¡æ‹Ÿæ”¯ä»˜æˆåŠŸ

### ä¸Šçº¿å‰å‡†å¤‡
1. ç”³è¯·å¾®ä¿¡/æ”¯ä»˜å®å•†æˆ·è´¦å·
2. è·å–æ”¯ä»˜é…ç½®å‚æ•°
3. é…ç½®åˆ°æ•°æ®åº“å’Œé…ç½®æ–‡ä»¶
4. é›†æˆçœŸå®çš„æ”¯ä»˜SDK
5. åœ¨æ²™ç®±ç¯å¢ƒæµ‹è¯•
6. éƒ¨ç½²åˆ°ç”Ÿäº§ç¯å¢ƒ

---

**è¯´æ˜æ—¶é—´**: 2025-10-18
**ç¼–è¯‘çŠ¶æ€**: âœ… BUILD SUCCESS
**å½“å‰æ¨¡å¼**: æµ‹è¯•æ¨¡å¼ï¼ˆæ¨¡æ‹Ÿæ”¯ä»˜ï¼‰

