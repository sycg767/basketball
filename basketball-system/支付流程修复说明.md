# 支付流程修复说明

## 问题描述

您之前发现在线支付时，系统直接就标记为"支付成功"，没有真正调用支付宝/微信支付接口。这是因为原实现为了测试方便，直接跳过了真实的支付流程。

## 修复内容

### 1. 修改文件列表

- ✅ `IBookingService.java` - 修改支付方法返回类型
- ✅ `BookingServiceImpl.java` - 实现真实的支付流程调用
- ✅ `BookingController.java` - 返回支付结果给前端

### 2. 支付流程说明

#### 修复前（测试模式）
```
用户点击支付 → 直接标记订单为"已支付" ✅ 完成
```

#### 修复后（正确流程）

##### (1) 在线支付（微信/支付宝）- paymentMethod = 1
```
用户点击支付 
  ↓
调用 PaymentService.createPayment()
  ↓
创建支付订单（生成二维码URL或跳转URL）
  ↓
返回支付信息给前端（qrCodeUrl/paymentUrl）
  ↓
前端展示二维码 或 跳转支付页面
  ↓
用户扫码/完成支付
  ↓
第三方支付回调 PaymentService.handleCallback()
  ↓
更新订单状态为"已支付" ✅ 完成
```

**重要**：在线支付是异步的，订单创建后保持"待支付"状态，只有收到支付回调后才更新为"已支付"。

##### (2) 余额支付 - paymentMethod = 2
```
用户点击支付 
  ↓
检查用户余额是否充足
  ↓
扣除用户余额
  ↓
直接标记订单为"已支付" ✅ 完成
```

##### (3) 会员卡支付 - paymentMethod = 3
```
当前为测试模式，直接标记为已支付
TODO: 待实现真实会员卡支付逻辑
```

##### (4) 现场支付 - paymentMethod = 4
```
用户选择现场支付 
  ↓
更新订单支付方式
  ↓
订单保持"待支付"状态
  ↓
用户到现场付款后，管理员手动确认 ✅ 完成
```

### 3. API 响应变化

#### 修复前
```json
{
  "code": 200,
  "message": "操作成功",
  "data": null
}
```

#### 修复后（在线支付时）
```json
{
  "code": 200,
  "message": "操作成功",
  "data": {
    "paymentNo": "PAY202510170001",
    "businessNo": "BOOK202510170001",
    "businessType": "booking",
    "paymentType": "wechat_native",
    "amount": 100.00,
    "status": 0,
    "qrCodeUrl": "https://api.mch.weixin.qq.com/pay/qrcode?data=mock_PAY202510170001",
    "expireTime": "2025-10-17 12:30:00"
  }
}
```

#### 修复后（余额支付等其他方式）
```json
{
  "code": 200,
  "message": "操作成功",
  "data": null
}
```

### 4. 前端对接建议

```javascript
// 前端调用支付接口
async function payBooking(bookingId, paymentMethod) {
    const response = await axios.put(`/api/booking/${bookingId}/pay`, {
        paymentMethod: paymentMethod
    });
    
    if (response.data.code === 200) {
        const paymentResult = response.data.data;
        
        if (paymentResult) {
            // 在线支付 - 展示二维码或跳转
            if (paymentResult.qrCodeUrl) {
                // 微信扫码支付 - 显示二维码
                showQRCode(paymentResult.qrCodeUrl);
                
                // 轮询查询支付状态
                startPollingPaymentStatus(paymentResult.paymentNo);
                
            } else if (paymentResult.paymentUrl) {
                // H5/PC支付 - 跳转到支付页面
                window.location.href = paymentResult.paymentUrl;
            }
        } else {
            // 余额支付/现场支付 - 直接完成
            showSuccess('支付成功');
        }
    }
}

// 轮询查询支付状态
function startPollingPaymentStatus(paymentNo) {
    const timer = setInterval(async () => {
        const status = await queryPaymentStatus(paymentNo);
        
        if (status === 2) { // 支付成功
            clearInterval(timer);
            showSuccess('支付成功');
            // 刷新订单列表
            refreshBookingList();
        } else if (status === 3 || status === 4) { // 支付失败或已取消
            clearInterval(timer);
            showError('支付失败');
        }
    }, 3000); // 每3秒查询一次
    
    // 30分钟后停止轮询
    setTimeout(() => clearInterval(timer), 30 * 60 * 1000);
}
```

### 5. 支付回调处理

当用户完成支付后，第三方平台（微信/支付宝）会回调以下接口：

```
POST /api/payment/callback/{paymentType}
```

`PaymentServiceImpl.handleCallback()` 会：
1. 验证回调签名（当前为模拟，生产环境需真实验签）
2. 更新支付订单状态
3. 更新业务订单状态（booking/member_card等）
4. 发送支付成功通知

### 6. 当前实现说明

**注意**：当前 `PaymentServiceImpl` 仍然是**模拟实现**，它：
- ✅ 创建了支付订单记录
- ✅ 返回模拟的二维码URL和跳转URL
- ❌ 但并没有真正调用微信/支付宝SDK

**生产环境部署前需要**：
1. 在 `AlipayServiceImpl` 中实现真实的支付宝支付接口调用
2. 在 `WechatPayServiceImpl` 中实现真实的微信支付接口调用
3. 在 `PaymentServiceImpl.createPayment()` 中调用真实的支付SDK，而不是生成模拟URL
4. 在 `PaymentServiceImpl.handleCallback()` 中实现真实的签名验证

### 7. 支付配置

确保数据库中 `payment_config` 表已配置相应的支付方式：

```sql
INSERT INTO payment_config (payment_type, payment_name, enabled, fee_rate, ...) VALUES
('wechat_native', '微信扫码支付', 1, 0.006, ...),
('wechat_h5', '微信H5支付', 1, 0.006, ...),
('alipay_pc', '支付宝PC支付', 1, 0.006, ...),
('alipay_wap', '支付宝WAP支付', 1, 0.006, ...);
```

### 8. 测试建议

#### 测试场景1：在线支付
1. 创建预订订单
2. 选择在线支付（paymentMethod = 1）
3. 应该返回支付二维码URL
4. 订单状态应该保持为"待支付"（status = 0）
5. 模拟支付回调后，订单才更新为"已支付"（status = 1）

#### 测试场景2：余额支付
1. 确保用户余额充足
2. 选择余额支付（paymentMethod = 2）
3. 应该直接扣款并标记为已支付
4. 用户余额应该减少相应金额

#### 测试场景3：现场支付
1. 选择现场支付（paymentMethod = 4）
2. 订单应该保持"待支付"状态
3. 需要管理员手动确认后才更新为已支付

## 总结

现在支付流程已经修复：
- ✅ 在线支付不再直接标记为已支付，而是创建支付订单并返回支付信息
- ✅ 前端可以获取二维码URL或跳转URL
- ✅ 需要等待支付回调才更新订单状态
- ✅ 余额支付、会员卡支付、现场支付保持同步处理

**下一步**：在生产环境部署前，需要集成真实的微信/支付宝支付SDK。

