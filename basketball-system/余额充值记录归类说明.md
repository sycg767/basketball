# ä½™é¢å……å€¼è®°å½•å½’ç±»è¯´æ˜

## ğŸ“Š å½’ç±»æ–¹æ¡ˆ

ä½™é¢å……å€¼é‡‡ç”¨**åŒé‡è®°å½•**æœºåˆ¶ï¼ŒåŒæ—¶è®°å½•åœ¨ä¸¤ä¸ªè¡¨ä¸­ï¼š

### 1. æ”¯ä»˜è®°å½•è¡¨ (payment_order)
**ç”¨é€”**ï¼šè®°å½•æ”¯ä»˜è¡Œä¸ºæœ¬èº«

**è®°å½•å†…å®¹**ï¼š
- æ”¯ä»˜è®¢å•å· (payment_no)
- ä¸šåŠ¡è®¢å•å· (business_no) - å……å€¼è®¢å•å·
- ä¸šåŠ¡ç±»å‹ (business_type) - `balance_recharge`
- æ”¯ä»˜æ–¹å¼ (payment_type) - `wechat_native` / `alipay_pc` ç­‰
- æ”¯ä»˜é‡‘é¢ (amount)
- æ”¯ä»˜çŠ¶æ€ (status) - 0å¾…æ”¯ä»˜, 1æ”¯ä»˜ä¸­, 2æ”¯ä»˜æˆåŠŸ, 3æ”¯ä»˜å¤±è´¥, 4å·²å–æ¶ˆ, 5å·²é€€æ¬¾
- ç¬¬ä¸‰æ–¹æ”¯ä»˜æµæ°´å· (third_party_trade_no)
- æ”¯ä»˜å®Œæˆæ—¶é—´ (paid_time)

**æŸ¥è¯¢åœºæ™¯**ï¼š
- ç”¨æˆ·æŸ¥çœ‹æ”¯ä»˜å†å²
- å¯¹è´¦å’Œè´¢åŠ¡æ ¸å¯¹
- æ”¯ä»˜çŠ¶æ€è¿½è¸ª
- é€€æ¬¾å¤„ç†

### 2. è´¢åŠ¡æµæ°´è¡¨ (financial_record)
**ç”¨é€”**ï¼šè®°å½•èµ„é‡‘å˜åŠ¨æµæ°´

**è®°å½•å†…å®¹**ï¼š
- æµæ°´å· (record_no)
- æµæ°´ç±»å‹ (record_type) - `1-æ”¶å…¥`
- ä¸šåŠ¡ç±»å‹ (business_type) - `5-ä½™é¢å……å€¼`
- å…³è”è®¢å•å· (order_no) - å…³è”æ”¯ä»˜è®¢å•å·
- ç”¨æˆ·ID (user_id)
- é‡‘é¢ (amount)
- å˜åŠ¨å‰ä½™é¢ (balance_before)
- å˜åŠ¨åä½™é¢ (balance_after)
- æ”¯ä»˜æ–¹å¼ (payment_method) - 1å¾®ä¿¡, 2æ”¯ä»˜å®
- æè¿° (description) - "è´¦æˆ·ä½™é¢å……å€¼"
- åˆ›å»ºæ—¶é—´ (create_time)

**æŸ¥è¯¢åœºæ™¯**ï¼š
- ç”¨æˆ·æŸ¥çœ‹ä½™é¢å˜åŠ¨æ˜ç»†
- è´¢åŠ¡æŠ¥è¡¨ç»Ÿè®¡
- æ”¶å…¥åˆ†æ
- ä½™é¢å¯¹è´¦

## ğŸ”§ å®ç°ç»†èŠ‚

### ä¸šåŠ¡ç±»å‹å®šä¹‰

#### payment_order.business_type (å­—ç¬¦ä¸²)
- `booking` - åœºåœ°é¢„è®¢
- `member_card` - ä¼šå‘˜å¡è´­ä¹°
- `course` - è¯¾ç¨‹æŠ¥å
- `balance_recharge` - **ä½™é¢å……å€¼** âœ¨

#### financial_record.business_type (æ•°å­—)
- `1` - åœºåœ°
- `2` - è¯¾ç¨‹
- `3` - ä¼šå‘˜å¡
- `4` - å…¶ä»–
- `5` - **ä½™é¢å……å€¼** âœ¨

#### financial_record.record_type (æ•°å­—)
- `1` - æ”¶å…¥
- `2` - æ”¯å‡º
- `3` - é€€æ¬¾

#### financial_record.payment_method (æ•°å­—)
- `0` - å…¶ä»–
- `1` - å¾®ä¿¡æ”¯ä»˜
- `2` - æ”¯ä»˜å®

### æ ¸å¿ƒä»£ç å®ç°

**ä½ç½®**ï¼š`PaymentServiceImpl.java`

```java
/**
 * å¤„ç†ä½™é¢å……å€¼
 */
private void handleBalanceRecharge(PaymentOrder order) {
    // 1. æ›´æ–°ç”¨æˆ·ä½™é¢
    User user = userMapper.selectById(order.getUserId());
    BigDecimal balanceBefore = user.getBalance() != null ? user.getBalance() : BigDecimal.ZERO;
    BigDecimal balanceAfter = balanceBefore.add(order.getActualAmount());
    user.setBalance(balanceAfter);
    userMapper.updateById(user);

    // 2. åˆ›å»ºè´¢åŠ¡æµæ°´è®°å½•
    FinancialRecord record = new FinancialRecord();
    record.setRecordNo(generateRecordNo());
    record.setRecordType(1); // æ”¶å…¥
    record.setBusinessType(5); // ä½™é¢å……å€¼
    record.setOrderNo(order.getPaymentNo());
    record.setUserId(order.getUserId());
    record.setAmount(order.getActualAmount());
    record.setBalanceBefore(balanceBefore);
    record.setBalanceAfter(balanceAfter);
    record.setPaymentMethod(getPaymentMethodCode(order.getPaymentType()));
    record.setDescription("è´¦æˆ·ä½™é¢å……å€¼");
    financialRecordMapper.insert(record);
}
```

### è§¦å‘æ—¶æœº

åœ¨æ”¯ä»˜å›è°ƒæˆåŠŸæ—¶è‡ªåŠ¨è§¦å‘ï¼š

```java
// PaymentServiceImpl.handleCallback()
if ("balance_recharge".equals(order.getBusinessType())) {
    handleBalanceRecharge(order);
}
```

## ğŸ“ˆ æ•°æ®æµç¨‹

```
ç”¨æˆ·å‘èµ·å……å€¼
    â†“
åˆ›å»ºæ”¯ä»˜è®¢å• (payment_order)
    â†“
ç”¨æˆ·å®Œæˆæ”¯ä»˜
    â†“
æ”¯ä»˜å›è°ƒæˆåŠŸ
    â†“
æ›´æ–°æ”¯ä»˜è®¢å•çŠ¶æ€ (payment_order.status = 2)
    â†“
æ›´æ–°ç”¨æˆ·ä½™é¢ (user.balance += amount)
    â†“
åˆ›å»ºè´¢åŠ¡æµæ°´ (financial_record) âœ¨
    â†“
å‘é€æ”¯ä»˜æˆåŠŸé€šçŸ¥
```

## ğŸ¯ æŸ¥è¯¢ç¤ºä¾‹

### æŸ¥è¯¢ç”¨æˆ·çš„å……å€¼è®°å½•ï¼ˆæ”¯ä»˜ç»´åº¦ï¼‰
```sql
SELECT * FROM payment_order
WHERE user_id = ?
  AND business_type = 'balance_recharge'
  AND status = 2
ORDER BY paid_time DESC;
```

### æŸ¥è¯¢ç”¨æˆ·çš„ä½™é¢å˜åŠ¨ï¼ˆè´¢åŠ¡ç»´åº¦ï¼‰
```sql
SELECT * FROM financial_record
WHERE user_id = ?
  AND business_type = 5
  AND record_type = 1
ORDER BY create_time DESC;
```

### ç»Ÿè®¡å……å€¼æ€»é¢
```sql
SELECT
    COUNT(*) as total_count,
    SUM(amount) as total_amount
FROM financial_record
WHERE business_type = 5
  AND record_type = 1
  AND DATE(create_time) = CURDATE();
```

## ğŸ”„ æ•°æ®åº“æ›´æ–°

æ‰§è¡Œä»¥ä¸‹SQLæ›´æ–°è¡¨æ³¨é‡Šï¼š

```sql
-- æ›´æ–°è´¢åŠ¡æµæ°´è¡¨çš„ä¸šåŠ¡ç±»å‹æ³¨é‡Š
ALTER TABLE `financial_record`
MODIFY COLUMN `business_type` tinyint NULL DEFAULT NULL
COMMENT 'ä¸šåŠ¡ç±»å‹: 1-åœºåœ°, 2-è¯¾ç¨‹, 3-ä¼šå‘˜å¡, 4-å…¶ä»–, 5-ä½™é¢å……å€¼';

-- æ›´æ–°æ”¯ä»˜æ–¹å¼æ³¨é‡Š
ALTER TABLE `financial_record`
MODIFY COLUMN `payment_method` tinyint NULL DEFAULT NULL
COMMENT 'æ”¯ä»˜æ–¹å¼: 0-å…¶ä»–, 1-å¾®ä¿¡æ”¯ä»˜, 2-æ”¯ä»˜å®';
```

## âœ… ä¼˜åŠ¿

1. **æ•°æ®å®Œæ•´æ€§**ï¼šæ”¯ä»˜å’Œè´¢åŠ¡ä¸¤ä¸ªç»´åº¦éƒ½æœ‰å®Œæ•´è®°å½•
2. **ä¾¿äºå¯¹è´¦**ï¼šæ”¯ä»˜è®°å½•å¯ä¸ç¬¬ä¸‰æ–¹å¹³å°å¯¹è´¦
3. **è´¢åŠ¡æ¸…æ™°**ï¼šè´¢åŠ¡æµæ°´æ¸…æ™°è®°å½•èµ„é‡‘å˜åŠ¨
4. **æŸ¥è¯¢çµæ´»**ï¼šå¯ä»ä¸åŒç»´åº¦æŸ¥è¯¢å……å€¼è®°å½•
5. **å®¡è®¡å‹å¥½**ï¼šå®Œæ•´çš„å®¡è®¡è¿½è¸ªé“¾è·¯

## ğŸ“ æ³¨æ„äº‹é¡¹

1. å……å€¼æˆåŠŸåä¼šåŒæ—¶åˆ›å»ºä¸¤æ¡è®°å½•ï¼ˆpayment_order + financial_recordï¼‰
2. financial_record.order_no å…³è”çš„æ˜¯ payment_order.payment_no
3. ä½™é¢å……å€¼ä¸èµ é€ç§¯åˆ†ï¼ˆä»…æ¶ˆè´¹èµ é€ç§¯åˆ†ï¼‰
4. æ”¯ä»˜å¤±è´¥æˆ–å–æ¶ˆä¸ä¼šåˆ›å»ºè´¢åŠ¡æµæ°´è®°å½•
5. é€€æ¬¾æ—¶éœ€è¦åŒæ—¶å¤„ç†æ”¯ä»˜è®¢å•å’Œè´¢åŠ¡æµæ°´
