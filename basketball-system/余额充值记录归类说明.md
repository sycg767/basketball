# 余额充值记录归类说明

## 📊 归类方案

余额充值采用**双重记录**机制，同时记录在两个表中：

### 1. 支付记录表 (payment_order)
**用途**：记录支付行为本身

**记录内容**：
- 支付订单号 (payment_no)
- 业务订单号 (business_no) - 充值订单号
- 业务类型 (business_type) - `balance_recharge`
- 支付方式 (payment_type) - `wechat_native` / `alipay_pc` 等
- 支付金额 (amount)
- 支付状态 (status) - 0待支付, 1支付中, 2支付成功, 3支付失败, 4已取消, 5已退款
- 第三方支付流水号 (third_party_trade_no)
- 支付完成时间 (paid_time)

**查询场景**：
- 用户查看支付历史
- 对账和财务核对
- 支付状态追踪
- 退款处理

### 2. 财务流水表 (financial_record)
**用途**：记录资金变动流水

**记录内容**：
- 流水号 (record_no)
- 流水类型 (record_type) - `1-收入`
- 业务类型 (business_type) - `5-余额充值`
- 关联订单号 (order_no) - 关联支付订单号
- 用户ID (user_id)
- 金额 (amount)
- 变动前余额 (balance_before)
- 变动后余额 (balance_after)
- 支付方式 (payment_method) - 1微信, 2支付宝
- 描述 (description) - "账户余额充值"
- 创建时间 (create_time)

**查询场景**：
- 用户查看余额变动明细
- 财务报表统计
- 收入分析
- 余额对账

## 🔧 实现细节

### 业务类型定义

#### payment_order.business_type (字符串)
- `booking` - 场地预订
- `member_card` - 会员卡购买
- `course` - 课程报名
- `balance_recharge` - **余额充值** ✨

#### financial_record.business_type (数字)
- `1` - 场地
- `2` - 课程
- `3` - 会员卡
- `4` - 其他
- `5` - **余额充值** ✨

#### financial_record.record_type (数字)
- `1` - 收入
- `2` - 支出
- `3` - 退款

#### financial_record.payment_method (数字)
- `0` - 其他
- `1` - 微信支付
- `2` - 支付宝

### 核心代码实现

**位置**：`PaymentServiceImpl.java`

```java
/**
 * 处理余额充值
 */
private void handleBalanceRecharge(PaymentOrder order) {
    // 1. 更新用户余额
    User user = userMapper.selectById(order.getUserId());
    BigDecimal balanceBefore = user.getBalance() != null ? user.getBalance() : BigDecimal.ZERO;
    BigDecimal balanceAfter = balanceBefore.add(order.getActualAmount());
    user.setBalance(balanceAfter);
    userMapper.updateById(user);

    // 2. 创建财务流水记录
    FinancialRecord record = new FinancialRecord();
    record.setRecordNo(generateRecordNo());
    record.setRecordType(1); // 收入
    record.setBusinessType(5); // 余额充值
    record.setOrderNo(order.getPaymentNo());
    record.setUserId(order.getUserId());
    record.setAmount(order.getActualAmount());
    record.setBalanceBefore(balanceBefore);
    record.setBalanceAfter(balanceAfter);
    record.setPaymentMethod(getPaymentMethodCode(order.getPaymentType()));
    record.setDescription("账户余额充值");
    financialRecordMapper.insert(record);
}
```

### 触发时机

在支付回调成功时自动触发：

```java
// PaymentServiceImpl.handleCallback()
if ("balance_recharge".equals(order.getBusinessType())) {
    handleBalanceRecharge(order);
}
```

## 📈 数据流程

```
用户发起充值
    ↓
创建支付订单 (payment_order)
    ↓
用户完成支付
    ↓
支付回调成功
    ↓
更新支付订单状态 (payment_order.status = 2)
    ↓
更新用户余额 (user.balance += amount)
    ↓
创建财务流水 (financial_record) ✨
    ↓
发送支付成功通知
```

## 🎯 查询示例

### 查询用户的充值记录（支付维度）
```sql
SELECT * FROM payment_order
WHERE user_id = ?
  AND business_type = 'balance_recharge'
  AND status = 2
ORDER BY paid_time DESC;
```

### 查询用户的余额变动（财务维度）
```sql
SELECT * FROM financial_record
WHERE user_id = ?
  AND business_type = 5
  AND record_type = 1
ORDER BY create_time DESC;
```

### 统计充值总额
```sql
SELECT
    COUNT(*) as total_count,
    SUM(amount) as total_amount
FROM financial_record
WHERE business_type = 5
  AND record_type = 1
  AND DATE(create_time) = CURDATE();
```

## 🔄 数据库更新

执行以下SQL更新表注释：

```sql
-- 更新财务流水表的业务类型注释
ALTER TABLE `financial_record`
MODIFY COLUMN `business_type` tinyint NULL DEFAULT NULL
COMMENT '业务类型: 1-场地, 2-课程, 3-会员卡, 4-其他, 5-余额充值';

-- 更新支付方式注释
ALTER TABLE `financial_record`
MODIFY COLUMN `payment_method` tinyint NULL DEFAULT NULL
COMMENT '支付方式: 0-其他, 1-微信支付, 2-支付宝';
```

## ✅ 优势

1. **数据完整性**：支付和财务两个维度都有完整记录
2. **便于对账**：支付记录可与第三方平台对账
3. **财务清晰**：财务流水清晰记录资金变动
4. **查询灵活**：可从不同维度查询充值记录
5. **审计友好**：完整的审计追踪链路

## 📝 注意事项

1. 充值成功后会同时创建两条记录（payment_order + financial_record）
2. financial_record.order_no 关联的是 payment_order.payment_no
3. 余额充值不赠送积分（仅消费赠送积分）
4. 支付失败或取消不会创建财务流水记录
5. 退款时需要同时处理支付订单和财务流水
