# 价格系统修复说明

## 问题描述

数据库表`venue_price`和`course`中存在`member_price`字段，导致系统直接使用固定的会员价格，而不是根据用户会员等级动态计算折扣价格。这导致非会员用户也能享受会员价格。

## 修复方案

### 核心改动

**价格计算逻辑**：从使用固定的`member_price`字段改为根据**用户会员等级**和**标准价格**动态计算折扣价格。

### 会员等级折扣规则

```
会员等级1：9.5折 (0.95)
会员等级2：9.0折 (0.90)
会员等级3：8.5折 (0.85)
会员等级4：8.0折 (0.80)
会员等级5：7.5折 (0.75)
非会员：无折扣 (1.0)
```

## 修改文件清单

### 后端修改 (3个文件)

#### 1. BookingServiceImpl.java
- **位置**：`basketball-system/src/main/java/com/basketball/service/impl/BookingServiceImpl.java`
- **修改内容**：
  - 修改`getVenuePrice()`方法：移除直接使用`memberPrice`字段的逻辑
  - 新增`getMemberDiscount()`方法：根据会员等级返回折扣系数
  - 价格计算：`实际价格 = 标准价格 × 会员折扣系数`

#### 2. CourseEnrollmentServiceImpl.java
- **位置**：`basketball-system/src/main/java/com/basketball/service/impl/CourseEnrollmentServiceImpl.java`
- **修改内容**：
  - 添加`BigDecimal`导入
  - 修改`createEnrollment()`方法：移除直接使用`course.getMemberPrice()`的逻辑
  - 新增`getMemberDiscount()`方法：根据会员等级返回折扣系数
  - 价格计算：`报名价格 = 课程标准价格 × 会员折扣系数`

#### 3. VenueServiceImpl.java
- **位置**：`basketball-system/src/main/java/com/basketball/service/impl/VenueServiceImpl.java`
- **修改内容**：
  - 修改`calculatePrice()`方法：移除直接使用`memberPrice`字段的逻辑
  - 新增`getMemberDiscount()`方法：根据会员等级返回折扣系数
  - 价格计算：`小时价格 = 标准价格 × 会员折扣系数`

### 前端修改 (4个文件)

#### 1. VenueManage.vue (场地管理)
- **位置**：`basketball-web/src/views/admin/VenueManage.vue`
- **修改内容**：
  - 移除价格表单中的"会员价格"输入框
  - 移除`priceForm`中的`memberPrice`字段
  - 添加会员折扣说明提示框

#### 2. CourseManage.vue (课程管理)
- **位置**：`basketball-web/src/views/admin/CourseManage.vue`
- **修改内容**：
  - 移除课程表格中的会员价格显示
  - 移除课程表单中的"会员价"输入框
  - 移除`form`对象中的`memberPrice`字段
  - 添加会员折扣说明提示框

#### 3. CourseList.vue (课程列表)
- **位置**：`basketball-web/src/views/course/CourseList.vue`
- **修改内容**：
  - 移除课程卡片中的会员价格显示
  - 只显示标准价格

#### 4. CourseDetail.vue (课程详情)
- **位置**：`basketball-web/src/views/course/CourseDetail.vue`
- **修改内容**：
  - 移除"会员价格"显示，改为显示"会员折扣"
  - 修改`enrollPrice`计算逻辑：根据用户会员等级动态计算折扣价格
  - 新增`getMemberDiscount()`和`getMemberDiscountValue()`方法

## 数据库字段说明

### 保留但不使用的字段

- `venue_price.member_price`：保留字段但不再使用
- `course.member_price`：保留字段但不再使用

**注意**：这些字段保留在数据库中是为了避免数据迁移风险，但系统已不再读取或使用这些字段的值。

## 测试验证

### 测试场景

1. **非会员用户预订场地**
   - 应显示标准价格
   - 实际支付金额 = 标准价格

2. **会员用户预订场地**
   - 应显示标准价格
   - 实际支付金额 = 标准价格 × 对应等级折扣

3. **课程报名**
   - 非会员：支付标准价格
   - 会员：支付折扣后价格

### 验证步骤

```bash
# 1. 编译后端
cd basketball-system
mvn clean compile -DskipTests

# 2. 启动后端服务
mvn spring-boot:run

# 3. 启动前端服务
cd ../basketball-web
npm run dev

# 4. 测试场景
- 使用非会员账号登录，预订场地，检查价格
- 使用不同等级会员账号登录，预订场地，检查折扣
- 报名课程，检查价格计算是否正确
```

## 影响范围

### 功能影响
- ✅ 场地预订价格计算
- ✅ 课程报名价格计算
- ✅ 价格显示（前端）
- ✅ 管理后台价格配置

### 不影响的功能
- ❌ 会员卡折扣（时间卡、次卡、储值卡）
- ❌ 积分系统
- ❌ 支付流程
- ❌ 订单管理

## 编译结果

```
[INFO] BUILD SUCCESS
[INFO] Total time:  17.173 s
```

后端编译成功，所有修改已生效。

## 总结

本次修复彻底解决了价格系统中的逻辑错误，确保：
1. 非会员用户按标准价格支付
2. 会员用户根据等级享受对应折扣
3. 价格计算逻辑统一且可维护
4. 前端显示清晰明了

修复后的系统更加合理，符合业务逻辑要求。
