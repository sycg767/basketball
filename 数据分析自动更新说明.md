# 数据分析自动更新说明

## ✅ 已配置自动更新

数据分析模块已经配置了**定时任务自动更新**，无需手动触发API。

### 📅 定时任务配置

#### 1. 会员活跃度分析
- **文件：** `MemberActivityScheduledTask.java`
- **执行时间：** 每5分钟执行一次（测试用）
- **原始配置：** 每天凌晨1:30执行
- **分析内容：** 统计前一天的会员登录、浏览、预订、支付等行为

#### 2. 课程热度分析
- **文件：** `CoursePopularityScheduledTask.java`
- **执行时间：** 每5分钟执行一次（测试用）
- **原始配置：** 每天凌晨2:00执行
- **分析内容：** 统计前一天的课程浏览、报名、评价等数据

#### 3. 场地使用分析
- **文件：** `VenueUsageScheduledTask.java`
- **执行时间：** 每5分钟执行一次（测试用）
- **原始配置：** 每天凌晨3:00执行
- **分析内容：** 统计前一天的场地预订、使用率、收入等数据

---

## 🔧 当前配置（测试环境）

为了方便测试，已将定时任务修改为**每5分钟执行一次**：

```java
@Scheduled(cron = "0 */5 * * * ?")
```

### 测试步骤：
1. 执行SQL插入测试数据（用户行为日志、预订记录、课程报名）
2. 重启后端服务
3. 等待5分钟，定时任务会自动执行
4. 刷新前端数据分析页面，即可看到最新数据

---

## 🚀 生产环境配置

在生产环境中，应该恢复为每天凌晨执行：

### 会员活跃度分析
```java
@Scheduled(cron = "0 30 1 * * ?")  // 每天凌晨1:30
```

### 课程热度分析
```java
@Scheduled(cron = "0 0 2 * * ?")   // 每天凌晨2:00
```

### 场地使用分析
```java
@Scheduled(cron = "0 0 3 * * ?")   // 每天凌晨3:00
```

---

## 📊 数据分析流程

### 1. 数据收集
- 用户行为日志（`user_behavior_log`）
- 预订记录（`booking`）
- 课程报名（`course_enrollment`）
- 支付订单（`payment_order`）

### 2. 数据分析
定时任务每天自动执行，分析前一天的数据：
- 计算会员活跃度得分
- 计算RFM模型（最近消费、消费频次、消费金额）
- 识别流失风险用户
- 统计课程热度和转化率
- 分析场地使用率和收入

### 3. 数据存储
分析结果存储到以下表：
- `member_activity_analysis` - 会员活跃度分析结果
- `course_popularity_analysis` - 课程热度分析结果
- `venue_usage_analysis` - 场地使用分析结果

### 4. 数据展示
前端页面从分析结果表读取数据，展示图表和统计信息。

---

## 🔍 手动触发（可选）

如果需要立即更新数据，可以手动调用API：

### 会员活跃度分析
```bash
POST http://localhost:8080/api/admin/analytics/member/analyze?analysisDate=2025-10-20
```

### 课程热度分析
```bash
POST http://localhost:8080/api/admin/analytics/course/analyze?analysisDate=2025-10-20
```

### 场地使用分析
```bash
POST http://localhost:8080/api/admin/analytics/venue/analyze?analysisDate=2025-10-20
```

---

## ⚠️ 注意事项

1. **定时任务依赖Spring Boot的@EnableScheduling**
   - 已在 `BasketballApplication.java` 中启用

2. **数据分析需要基础数据**
   - 确保有用户行为日志数据
   - 确保有预订和课程报名数据

3. **测试环境vs生产环境**
   - 测试环境：每5分钟执行（方便测试）
   - 生产环境：每天凌晨执行（节省资源）

4. **数据库表结构**
   - 确保所有分析表的字段完整
   - 已修复：`cancel_count`, `last_active_time`, `remark`

---

## 📝 修改记录

**2025-10-20**
- ✅ 修复数据库表缺失字段
- ✅ 配置定时任务为每5分钟执行（测试用）
- ✅ 添加测试数据SQL脚本
- ✅ 验证定时任务自动执行

---

## 🎯 总结

**数据分析是自动更新的！**
- 定时任务每5分钟（测试）或每天凌晨（生产）自动执行
- 无需手动触发API
- 重启后端服务后，定时任务会自动开始工作
- 前端页面刷新即可看到最新数据
