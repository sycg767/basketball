# 微信登录配置指南

## 问题说明

当前微信登录功能显示"appid参数错误"是因为**未配置真实的微信开放平台AppID**。

## 解决方案

### 方案一：申请真实的微信开放平台AppID（推荐用于生产环境）

#### 1. 申请微信开放平台账号

访问：https://open.weixin.qq.com/

- 注册并认证微信开放平台账号（需要企业资质）
- 创建网站应用
- 获取AppID和AppSecret

#### 2. 配置到项目中

编辑 `basketball-system/src/main/resources/application.yml`：

```yaml
wechat:
  oauth:
    enabled: true  # 启用微信登录
    app-id: wxXXXXXXXXXXXXXXXX  # 替换为你的真实AppID
    app-secret: your_app_secret_here  # 替换为你的AppSecret
    redirect-uri: http://yourdomain.com/api/wechat/auth/callback  # 替换为你的回调地址
```

#### 3. 配置授权回调域名

在微信开放平台后台配置授权回调域名：
- 开发环境：`localhost:8080`
- 生产环境：`yourdomain.com`

#### 4. 重启后端服务

```bash
cd basketball-system
mvn clean package
java -jar target/basketball-system.jar
```

---

### 方案二：使用模拟模式（仅用于开发测试）

如果只是开发测试，不想申请真实AppID，可以使用模拟登录模式。

#### 修改前端，跳过二维码扫描

编辑 `basketball-web/src/components/WechatLoginDialog.vue`，添加模拟登录按钮：

```vue
<template>
  <el-dialog>
    <!-- 原有的二维码显示 -->

    <!-- 添加模拟登录按钮 -->
    <div v-if="!wechatEnabled" class="mock-login-section">
      <el-divider>开发测试模式</el-divider>
      <el-button type="warning" @click="mockLogin">
        模拟微信登录（测试用）
      </el-button>
      <p class="mock-tip">
        生产环境请配置真实的微信AppID
      </p>
    </div>
  </el-dialog>
</template>

<script setup>
const mockLogin = async () => {
  try {
    // 直接调用回调接口，使用模拟code
    const mockCode = 'mock_code_' + Date.now();
    const mockState = 'mock_state_' + Date.now();

    const res = await request({
      url: '/api/wechat/auth/callback',
      method: 'get',
      params: { code: mockCode, state: mockState }
    });

    if (res.code === 200) {
      ElMessage.success('模拟登录成功');
      emit('success', res.data);
      visible.value = false;
    }
  } catch (error) {
    ElMessage.error('模拟登录失败');
  }
};
</script>
```

#### 修改后端，允许模拟登录

编辑 `basketball-system/src/main/java/com/basketball/service/impl/WechatServiceImpl.java`：

```java
@Override
public WechatAuthUrlVO getAuthorizationUrl() {
    // 如果未启用真实微信登录，返回模拟提示
    if (!wechatEnabled || StringUtils.isBlank(wechatAppId) || "YOUR_WECHAT_APP_ID".equals(wechatAppId)) {
        WechatAuthUrlVO vo = new WechatAuthUrlVO();
        vo.setAuthUrl("MOCK_MODE"); // 标记为模拟模式
        vo.setState("mock_state");
        log.warn("微信登录未配置，使用模拟模式");
        return vo;
    }

    // ... 原有的真实登录逻辑
}
```

---

## 当前状态

✅ **已修复的问题：**
- 前端字段不匹配问题（`authUrl` vs `qrCodeUrl`）
- 后端从配置文件读取AppID
- 添加了友好的错误提示

❌ **仍需配置：**
- 真实的微信开放平台AppID和AppSecret
- 授权回调域名

---

## 快速测试方案

如果你只是想快速测试系统其他功能，建议：

1. **暂时禁用微信登录按钮**
2. **使用手机验证码登录或用户名密码登录**
3. **等需要上线时再申请微信AppID**

编辑 `basketball-web/src/views/Login.vue`，隐藏微信登录按钮：

```vue
<!-- 暂时注释掉微信登录 -->
<!-- <el-button @click="showWechatLogin = true">
  <el-icon><ChatDotRound /></el-icon>
  微信登录
</el-button> -->
```

---

## 费用说明

- **微信开放平台认证费用**：300元/年（企业认证）
- **个人开发者**：无法申请网站应用的微信登录
- **替代方案**：可以使用微信公众号登录（需要认证的服务号）

---

## 技术支持

如需帮助配置微信登录，请提供：
1. 是否已有微信开放平台账号
2. 是否已创建网站应用
3. 当前的AppID（如果有）

我可以帮你完成后续的配置步骤。
