# 通知模板管理功能使用指南

## 📋 问题修复总结

### 原始问题
定时任务执行失败，错误信息：
```
com.basketball.common.exception.BusinessException: 通知模板不存在或已禁用
```

### 根本原因
代码中使用的模板编码与数据库中实际的模板编码不匹配：
- 代码使用：`COURSE_START_REMINDER`、`BOOKING_START_REMINDER`、`MEMBER_EXPIRE_REMINDER`
- 数据库实际：`COURSE_START_REMIND`、`MEMBER_EXPIRE_7DAYS`、`MEMBER_EXPIRE_3DAYS`

### 解决方案
1. ✅ 修复了代码中的模板编码映射
2. ✅ 添加了缺失的预订开始提醒模板
3. ✅ 新增了完整的通知模板管理功能

---

## 🚀 快速开始

### 第一步：执行数据库脚本

在 MySQL 中执行以下脚本添加缺失的模板：

```bash
mysql -u root -p basketball_system < add_booking_start_reminder_template.sql
```

或者手动执行 SQL：
```sql
INSERT INTO `notification_template`
(`template_code`, `template_name`, `template_type`, `scene`, `title`, `content`, `variables`, `priority`, `status`, `remark`)
VALUES
('BOOKING_START_REMINDER', '预订开始提醒', 'system', 'booking_remind', '预订即将开始',
'您的场地预订将在1小时后开始，请准时到场', '[]', 3, 1, '预订开始提醒');
```

### 第二步：重新编译后端

```bash
cd basketball-system
mvn clean compile
```

### 第三步：重启应用

```bash
# 停止当前运行的应用
# 然后重新启动
mvn spring-boot:run
```

### 第四步：访问通知模板管理

1. 登录管理后台：`http://localhost:5173/admin/login`
2. 在左侧菜单找到 **"通知模板"** 菜单项
3. 点击进入通知模板管理页面

---

## 📁 新增文件清单

### 后端文件（Java）

1. **Service 接口**
   - `basketball-system/src/main/java/com/basketball/service/INotificationTemplateService.java`
   - 定义通知模板服务接口

2. **Service 实现**
   - `basketball-system/src/main/java/com/basketball/service/impl/NotificationTemplateServiceImpl.java`
   - 实现模板的 CRUD 操作

3. **Controller**
   - `basketball-system/src/main/java/com/basketball/controller/AdminNotificationTemplateController.java`
   - 提供管理端 API 接口

### 前端文件（Vue）

1. **API 接口**
   - `basketball-web/src/api/admin/notificationTemplate.js`
   - 封装后端 API 调用

2. **管理页面**
   - `basketball-web/src/views/admin/notification/TemplateManage.vue`
   - 通知模板管理界面

### 数据库脚本

1. **模板补充脚本**
   - `add_booking_start_reminder_template.sql`
   - 添加缺失的预订开始提醒模板

### 修改的文件

1. **定时任务服务**
   - `basketball-system/src/main/java/com/basketball/service/impl/ScheduledReminderServiceImpl.java`
   - 修复模板编码映射

2. **路由配置**
   - `basketball-web/src/router/index.js`
   - 添加通知模板管理路由

3. **管理后台布局**
   - `basketball-web/src/views/admin/Layout.vue`
   - 添加通知模板菜单项

---

## 🎯 功能特性

### 1. 模板列表管理
- ✅ 分页展示所有通知模板
- ✅ 按类型、场景筛选
- ✅ 关键词搜索（模板名称/编码/标题）
- ✅ 实时启用/禁用切换

### 2. 模板编辑
- ✅ 新增模板
- ✅ 编辑模板
- ✅ 删除模板
- ✅ 查看模板详情

### 3. 模板字段
- **模板编码**：唯一标识，如 `BOOKING_SUCCESS`
- **模板名称**：显示名称
- **模板类型**：system/sms/email/wechat
- **场景**：业务场景标识
- **标题**：通知标题
- **内容**：通知内容，支持变量 `{{变量名}}`
- **变量列表**：JSON 数组格式
- **优先级**：1-10，数字越大优先级越高
- **状态**：启用/禁用
- **备注**：补充说明

### 4. 权限控制
- ✅ 仅管理员可访问
- ✅ 操作日志记录

---

## 📊 API 接口文档

### 1. 分页查询模板
```
GET /api/admin/notification-template/page
参数：
  - page: 页码（默认1）
  - size: 每页大小（默认10）
  - templateType: 模板类型（可选）
  - scene: 场景（可选）
  - keyword: 关键词（可选）
```

### 2. 查询模板详情
```
GET /api/admin/notification-template/{id}
```

### 3. 新增模板
```
POST /api/admin/notification-template
Body: NotificationTemplate 对象
```

### 4. 更新模板
```
PUT /api/admin/notification-template/{id}
Body: NotificationTemplate 对象
```

### 5. 删除模板
```
DELETE /api/admin/notification-template/{id}
```

### 6. 切换状态
```
PUT /api/admin/notification-template/{id}/status
参数：
  - status: 状态值（0-禁用，1-启用）
```

---

## 🔧 使用示例

### 新增一个课程取消通知模板

1. 点击 **"新增模板"** 按钮
2. 填写表单：
   - 模板编码：`COURSE_CANCEL_NOTIFY`
   - 模板名称：`课程取消通知`
   - 模板类型：`系统通知`
   - 场景：`course_cancel`
   - 标题：`课程取消通知`
   - 内容：`抱歉，【{{courseName}}】因{{reason}}已取消，费用将原路退回。`
   - 变量列表：`["courseName","reason"]`
   - 优先级：`3`
   - 状态：`启用`
3. 点击 **"确定"** 保存

### 修改现有模板

1. 在列表中找到要修改的模板
2. 点击 **"编辑"** 按钮
3. 修改需要的字段
4. 点击 **"确定"** 保存

### 启用/禁用模板

直接点击列表中的状态开关即可切换

---

## ⚠️ 注意事项

### 1. 模板编码规范
- 使用大写字母和下划线
- 保持唯一性
- 建议格式：`业务_动作_类型`
- 示例：`BOOKING_SUCCESS`、`COURSE_START_REMIND`

### 2. 变量使用
- 在内容中使用 `{{变量名}}` 格式
- 变量列表必须是有效的 JSON 数组
- 示例：`["userName","expireDate"]`

### 3. 模板删除
- 删除前请确认该模板未被使用
- 建议先禁用测试，确认无影响后再删除

### 4. 优先级设置
- 1-10 的数字，越大优先级越高
- 紧急通知建议设置为 8-10
- 普通通知设置为 1-3

---

## 🐛 故障排查

### 问题1：定时任务仍然失败
**检查步骤：**
1. 确认数据库脚本已执行
2. 确认应用已重启
3. 查看日志中的模板编码是否正确
4. 在管理页面检查对应模板是否存在且已启用

### 问题2：管理页面无法访问
**检查步骤：**
1. 确认已使用管理员账号登录
2. 检查路由配置是否正确
3. 检查浏览器控制台是否有错误

### 问题3：模板保存失败
**检查步骤：**
1. 检查模板编码是否重复
2. 检查必填字段是否完整
3. 检查变量列表格式是否正确

---

## 📈 后续优化建议

1. **模板版本管理**
   - 记录模板修改历史
   - 支持版本回滚

2. **模板预览功能**
   - 实时预览渲染效果
   - 支持测试数据填充

3. **使用统计**
   - 记录模板使用次数
   - 分析模板效果

4. **批量操作**
   - 批量启用/禁用
   - 批量导入/导出

5. **模板分组**
   - 按业务模块分组
   - 支持文件夹管理

---

## 📞 技术支持

如有问题，请查看：
1. 应用日志：`basketball-system/logs/`
2. 浏览器控制台错误信息
3. 数据库连接状态

---

## ✅ 验证清单

部署完成后，请验证以下功能：

- [ ] 数据库脚本执行成功
- [ ] 应用重启无错误
- [ ] 定时任务执行成功（查看日志）
- [ ] 管理后台可以访问通知模板页面
- [ ] 可以查看模板列表
- [ ] 可以新增模板
- [ ] 可以编辑模板
- [ ] 可以删除模板
- [ ] 可以切换模板状态
- [ ] 搜索和筛选功能正常
- [ ] 分页功能正常

---

**完成时间：** 2025-10-22
**版本：** v1.0.0
