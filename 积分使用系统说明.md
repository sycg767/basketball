# 篮球馆积分使用系统说明

## 📋 系统概述

本系统实现了完整的积分获取、使用和管理功能，为用户提供更多优惠和权益。

---

## 🎯 一、积分获取规则

### 1.1 消费赠送
- **规则**：消费1元 = 获得1积分
- **适用场景**：
  - 场地预订支付
  - 课程报名支付
  - 会员卡购买
- **有效期**：积分有效期1年

### 1.2 会员卡赠送
- **银卡会员**：每月赠送200积分
- **金卡会员**：每月赠送500积分
- **铂金会员**：每月赠送1000积分
- **VIP会员**：每月赠送2000积分

---

## 💰 二、积分使用规则

### 2.1 积分抵扣支付（已实现）

#### 兑换比例
```
100积分 = 1元
```

#### 使用限制
1. **最低使用门槛**：100积分起
2. **最高抵扣比例**：单笔订单最多使用50%积分抵扣
3. **适用场景**：
   - ✅ 场地预订支付
   - ✅ 课程报名支付
   - ✅ 会员卡购买

#### 使用示例
```
订单金额：200元
可用积分：10000积分
最多可用：10000积分（抵扣100元，但受50%限制）
实际抵扣：100元（订单的50%）
实付金额：100元
```

---

## 🔧 三、技术实现

### 3.1 后端API接口

#### 1. 计算积分抵扣
```http
GET /api/points/calculate-deduct
参数：
  - pointsToUse: 要使用的积分数量
  - orderAmount: 订单金额

返回：
{
  "originalAmount": 200.00,
  "pointsUsed": 10000,
  "deductAmount": 100.00,
  "finalAmount": 100.00,
  "remainingPoints": 5000,
  "available": true,
  "message": "成功使用10000积分抵扣100元"
}
```

#### 2. 使用积分抵扣
```http
POST /api/points/use-deduct
Body:
{
  "pointsToUse": 1000,
  "orderAmount": 100.00,
  "orderNo": "BK1234567890"
}
```

#### 3. 获取用户积分信息
```http
GET /api/points/info

返回：
{
  "totalPoints": 15000,
  "availablePoints": 15000,
  "pointsValue": 150.00,
  "memberLevel": 2,
  "expiringPoints": 500
}
```

#### 4. 获取积分记录
```http
GET /api/points/records?page=1&pageSize=10
```

#### 5. 获取积分使用规则
```http
GET /api/points/rules
```

### 3.2 支付集成

在预订支付时，支持积分抵扣：

```java
// BookingPayDTO 新增字段
private Integer pointsToUse; // 使用积分数量

// 支付流程
1. 用户选择使用积分
2. 系统计算抵扣金额
3. 扣除用户积分
4. 创建积分使用记录
5. 使用抵扣后的金额进行支付
```

### 3.3 数据库记录

#### 积分记录表 (points_record)
```sql
- id: 记录ID
- user_id: 用户ID
- points: 积分变动（正数=获得，负数=消费）
- type: 类型（1-消费赠送, 2-兑换商品, 3-签到, 4-活动, 5-过期扣除, 6-管理员调整）
- related_order: 关联订单号
- points_before: 变动前积分
- points_after: 变动后积分
- expire_date: 过期日期
- remark: 备注
- create_time: 创建时间
```

---

## 📱 四、前端实现建议

### 4.1 支付页面集成

```vue
<template>
  <div class="payment-page">
    <!-- 订单信息 -->
    <div class="order-info">
      <div class="amount">订单金额：¥{{ orderAmount }}</div>
    </div>

    <!-- 积分抵扣 -->
    <div class="points-deduct">
      <el-checkbox v-model="usePoints">使用积分抵扣</el-checkbox>
      <div v-if="usePoints" class="points-input">
        <span>可用积分：{{ userPoints }}</span>
        <el-slider
          v-model="pointsToUse"
          :min="100"
          :max="maxPointsCanUse"
          :step="100"
          @change="calculateDeduct"
        />
        <div class="deduct-info">
          使用 {{ pointsToUse }} 积分，抵扣 ¥{{ deductAmount }}
        </div>
      </div>
    </div>

    <!-- 实付金额 -->
    <div class="final-amount">
      实付金额：<span class="price">¥{{ finalAmount }}</span>
    </div>
  </div>
</template>

<script setup>
import { ref, computed } from 'vue';
import { calculatePointsDeduct } from '@/api/points';

const orderAmount = ref(200);
const userPoints = ref(15000);
const usePoints = ref(false);
const pointsToUse = ref(100);
const deductAmount = ref(0);

const maxPointsCanUse = computed(() => {
  // 最多抵扣50%
  const maxDeduct = orderAmount.value * 0.5;
  const maxPoints = maxDeduct * 100;
  return Math.min(maxPoints, userPoints.value);
});

const finalAmount = computed(() => {
  return orderAmount.value - deductAmount.value;
});

const calculateDeduct = async () => {
  const res = await calculatePointsDeduct({
    pointsToUse: pointsToUse.value,
    orderAmount: orderAmount.value
  });
  if (res.data.available) {
    deductAmount.value = res.data.deductAmount;
  }
};
</script>
```

### 4.2 积分中心页面

```vue
<template>
  <div class="points-center">
    <!-- 积分概览 -->
    <el-card class="points-overview">
      <div class="total-points">{{ pointsInfo.totalPoints }}</div>
      <div class="points-value">≈ ¥{{ pointsInfo.pointsValue }}</div>
      <div class="expiring-tip" v-if="pointsInfo.expiringPoints > 0">
        {{ pointsInfo.expiringPoints }}积分即将过期
      </div>
    </el-card>

    <!-- 积分规则 -->
    <el-card class="points-rules">
      <h3>积分规则</h3>
      <ul>
        <li v-for="rule in rules" :key="rule">{{ rule }}</li>
      </ul>
    </el-card>

    <!-- 积分记录 -->
    <el-card class="points-records">
      <h3>积分明细</h3>
      <el-table :data="records">
        <el-table-column prop="points" label="积分变动">
          <template #default="{ row }">
            <span :class="row.points > 0 ? 'income' : 'expense'">
              {{ row.points > 0 ? '+' : '' }}{{ row.points }}
            </span>
          </template>
        </el-table-column>
        <el-table-column prop="remark" label="说明" />
        <el-table-column prop="createTime" label="时间" />
      </el-table>
    </el-card>
  </div>
</template>
```

---

## 🚀 五、扩展功能（待实现）

### 5.1 积分兑换优惠券
```
- 银卡优惠券: 2000积分 → 9.5折券
- 金卡优惠券: 5000积分 → 9折券
- 铂金优惠券: 10000积分 → 8.5折券
- VIP优惠券: 20000积分 → 8折券
```

### 5.2 积分兑换次卡
```
- 单次体验卡: 500积分
- 3次体验卡: 1200积分
- 5次体验卡: 1800积分
```

### 5.3 积分商城
```
- 实物礼品：运动装备、服饰等
- 虚拟权益：优先预订权、免费课程等
```

### 5.4 积分签到
```
- 每日签到：+10积分
- 连续签到7天：额外+50积分
- 连续签到30天：额外+200积分
```

---

## 📊 六、数据统计

### 6.1 用户积分分析
- 积分获取来源统计
- 积分使用去向统计
- 积分过期预警

### 6.2 运营指标
- 积分发放总量
- 积分使用率
- 积分抵扣金额
- 用户活跃度提升

---

## ✅ 七、已完成功能清单

- [x] 积分获取（消费赠送）
- [x] 积分抵扣支付
- [x] 积分查询接口
- [x] 积分记录查询
- [x] 积分规则说明
- [x] 退款积分扣除
- [x] 支付流程集成

---

## 📝 八、使用示例

### 示例1：用户预订场地使用积分

```
1. 用户选择场地，生成订单：200元
2. 用户当前积分：15000积分
3. 用户选择使用10000积分抵扣
4. 系统计算：
   - 10000积分 = 100元
   - 最多抵扣50% = 100元
   - 实际抵扣：100元
5. 实付金额：100元
6. 剩余积分：5000积分
7. 支付完成后获得：100积分（实付金额的1%）
```

### 示例2：积分不足时的处理

```
1. 订单金额：200元
2. 用户积分：500积分
3. 用户尝试使用500积分
4. 系统计算：
   - 500积分 = 5元
   - 可以使用（超过100积分门槛）
5. 实付金额：195元
6. 剩余积分：0积分
```

---

## 🔒 九、安全性考虑

1. **积分防刷**：
   - 订单支付成功后才赠送积分
   - 退款时扣除已赠送的积分
   - 积分使用有最低门槛

2. **事务保证**：
   - 积分扣除和订单支付在同一事务中
   - 失败时自动回滚

3. **数据一致性**：
   - 每次积分变动都有详细记录
   - 记录变动前后的积分余额
   - 关联订单号便于追溯

---

## 📞 十、技术支持

如有问题，请联系开发团队。

**文档版本**：v1.0
**更新日期**：2025-10-22
**作者**：Basketball Team
