import{_ as E,r as k,w as M,M as F,f as q,d as m,o as c,e as i,b as a,a as u,u as x,l as Q,v as b,g as v,a8 as W,am as j,c as I,h as A,i as S,k as G,t as H,a7 as J,E as r,m as K,D as R}from"./index-DqRIPXSt.js";import{c as L,P as O,q as D,m as X}from"./PaymentStatusPoller-BsWzaYTW.js";const Y={class:"qrcode-container"},Z={key:0,class:"qrcode-loading"},ee={key:1,class:"qrcode-content"},te={class:"qrcode-box"},se=["src","alt"],oe={class:"qrcode-info"},ae={key:0,class:"qrcode-title"},ne={key:1,class:"qrcode-description"},re={key:2,class:"qrcode-timer"},le={key:0,class:"qrcode-footer"},ce={key:2,class:"qrcode-error"},ie={__name:"QrCodeDisplay",props:{qrCodeUrl:{type:String,default:""},title:{type:String,default:"扫码支付"},description:{type:String,default:""},loading:{type:Boolean,default:!1},loadingText:{type:String,default:"正在生成二维码..."},errorText:{type:String,default:"二维码加载失败"},showTimer:{type:Boolean,default:!1},timeout:{type:Number,default:300},showRetry:{type:Boolean,default:!0}},emits:["timeout","retry"],setup(n,{expose:B,emit:_}){const d=n,h=_,s=k(0);let y=null;M(()=>d.qrCodeUrl,l=>{l&&d.showTimer?o():f()}),M(()=>d.showTimer,l=>{l&&d.qrCodeUrl?o():f()});const o=()=>{s.value=d.timeout,y=setInterval(()=>{s.value--,s.value<=0&&(f(),h("timeout"))},1e3)},f=()=>{y&&(clearInterval(y),y=null),s.value=0},T=l=>{const g=Math.floor(l/60),p=l%60;return`${g.toString().padStart(2,"0")}:${p.toString().padStart(2,"0")}`},C=()=>{h("retry")};return F(()=>{f()}),B({startCountdown:o,stopCountdown:f}),(l,g)=>{const p=q("el-icon"),w=q("el-button");return c(),m("div",Y,[n.loading?(c(),m("div",Z,[i(p,{class:"is-loading"},{default:u(()=>[i(x(Q))]),_:1}),a("p",null,b(n.loadingText),1)])):n.qrCodeUrl?(c(),m("div",ee,[a("div",te,[a("img",{src:n.qrCodeUrl,alt:n.title,class:"qrcode-image"},null,8,se)]),a("div",oe,[n.title?(c(),m("h3",ae,b(n.title),1)):v("",!0),n.description?(c(),m("p",ne,b(n.description),1)):v("",!0),n.showTimer&&s.value>0?(c(),m("div",re,[i(p,null,{default:u(()=>[i(x(W))]),_:1}),a("span",null,"剩余时间: "+b(T(s.value)),1)])):v("",!0)]),l.$slots.footer?(c(),m("div",le,[j(l.$slots,"footer",{},void 0,!0)])):v("",!0)])):(c(),m("div",ce,[i(p,{color:"#F56C6C"},{default:u(()=>[i(x(A))]),_:1}),a("p",null,b(n.errorText),1),n.showRetry?(c(),I(w,{key:0,type:"primary",onClick:C},{default:u(()=>[...g[0]||(g[0]=[S(" 重新加载 ",-1)])]),_:1})):v("",!0)]))])}}},ue=E(ie,[["__scopeId","data-v-73b784bb"]]),de={class:"wechat-pay-container"},me={class:"payment-header"},ye={class:"amount"},fe={class:"value"},pe={class:"payment-tips"},ve={class:"payment-actions"},_e={__name:"WechatPay",setup(n){const B=J(),_=K(),d=k(!1),h=k(""),s=k(""),y=k(null),o=G({businessNo:"",businessType:"",businessName:"",amount:"0.00"});H(()=>{f(),T()});const f=()=>{const{businessNo:e,businessType:t,businessName:$,amount:N}=B.query;if(!e||!N){r.error("支付信息不完整"),_.back();return}o.businessNo=e,o.businessType=t||"booking",o.businessName=$||"篮球馆服务",o.amount=N},T=async()=>{d.value=!0,h.value="",s.value="";try{const e=await L({businessNo:o.businessNo,businessType:o.businessType,paymentType:"wechat_native",amount:parseFloat(o.amount),description:o.businessName});e.code===200?(h.value=e.data.qrCodeUrl||e.data.codeUrl,s.value=e.data.paymentNo,r.success("支付二维码已生成")):r.error(e.message||"创建支付失败")}catch(e){console.error("创建微信支付失败:",e),r.error("创建支付失败,请重试")}finally{d.value=!1}},C=e=>{r.success("支付成功"),_.replace({path:"/payment/result",query:{status:"success",paymentNo:s.value,amount:o.amount,businessName:o.businessName,type:o.businessType}})},l=e=>{r.error("支付失败"),_.replace({path:"/payment/result",query:{status:"failed",paymentNo:s.value,amount:o.amount,type:o.businessType}})},g=()=>{R.confirm("二维码已过期,是否重新生成?","提示",{confirmButtonText:"重新生成",cancelButtonText:"取消支付",type:"warning"}).then(()=>{T()}).catch(()=>{P()})},p=()=>{R.confirm("支付超时,请确认是否已完成支付","支付超时",{confirmButtonText:"已完成支付",cancelButtonText:"取消支付",type:"warning"}).then(()=>{w()}).catch(()=>{P()})},w=async()=>{if(!s.value){r.warning("支付订单不存在");return}try{const e=await D(s.value);if(e.code===200){const t=e.data.status;t===2?C(e.data):t===3||t===4||t===5?l(e.data):r.info("支付尚未完成,请继续扫码支付")}}catch(e){console.error("查询支付状态失败:",e),r.error("查询失败,请稍后重试")}},P=async()=>{try{await R.confirm("确定要取消支付吗?","取消支付",{confirmButtonText:"确定",cancelButtonText:"继续支付",type:"warning"}),_.back()}catch{}},V=async()=>{if(!s.value){r.warning("支付订单不存在");return}try{const e=await X(s.value);e.code===200?(r.success("模拟支付成功"),setTimeout(()=>{w()},500)):r.error(e.message||"模拟支付失败")}catch(e){console.error("模拟支付失败:",e),r.error("模拟支付失败")}};return F(()=>{var e;(e=y.value)==null||e.stopCountdown()}),(e,t)=>{const $=q("el-divider"),N=q("el-alert"),U=q("el-button"),z=q("el-card");return c(),m("div",de,[i(z,{class:"payment-card"},{default:u(()=>[a("div",me,[t[1]||(t[1]=a("h2",null,"微信扫码支付",-1)),a("div",ye,[t[0]||(t[0]=a("span",{class:"label"},"支付金额:",-1)),a("span",fe,"¥"+b(o.amount),1)])]),i($),i(ue,{ref_key:"qrCodeRef",ref:y,"qr-code-url":h.value,loading:d.value,"show-timer":!0,timeout:300,title:"请使用微信扫码支付",description:"打开微信，扫描二维码完成支付","loading-text":"正在生成支付二维码...",onTimeout:g,onRetry:T},{footer:u(()=>[a("div",pe,[i(N,{type:"info",closable:!1,"show-icon":""},{title:u(()=>[...t[2]||(t[2]=[a("div",{class:"tips-content"},[a("p",null,"• 请在5分钟内完成支付"),a("p",null,"• 支付完成后会自动跳转")],-1)])]),_:1})])]),_:1},8,["qr-code-url","loading"]),s.value?(c(),I(O,{key:0,"payment-no":s.value,"query-fn":x(D),interval:2e3,"max-attempts":150,"auto-start":!0,onSuccess:C,onFailed:l,onTimeout:p},null,8,["payment-no","query-fn"])):v("",!0),a("div",ve,[i(U,{size:"large",onClick:P},{default:u(()=>[...t[3]||(t[3]=[S("取消支付",-1)])]),_:1}),i(U,{type:"primary",size:"large",onClick:w},{default:u(()=>[...t[4]||(t[4]=[S(" 支付遇到问题? ",-1)])]),_:1}),s.value?(c(),I(U,{key:0,type:"success",size:"large",onClick:V},{default:u(()=>[...t[5]||(t[5]=[S(" 模拟支付成功 ",-1)])]),_:1})):v("",!0)])]),_:1})])}}},be=E(_e,[["__scopeId","data-v-bf8a810e"]]);export{be as default};
