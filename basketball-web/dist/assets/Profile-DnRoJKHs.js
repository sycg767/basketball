import{X,_ as J,r as g,k as $,w as G,c as y,a as l,e as o,f as m,b as t,u as K,i as f,E as p,o as c,j as se,t as te,d as B,g as re,v as L,Y as de,Z as ie,$ as ue,D as H}from"./index-DqRIPXSt.js";import{v as O,c as me,a as pe}from"./validate-CbFD6edE.js";import{S as fe,s as ce}from"./SmsCountdown-CEoZrlBO.js";function we(E){return X({url:"/api/user/bind/phone",method:"post",data:E})}function _e(){return X({url:"/api/user/bind/phone",method:"delete"})}function ve(){return X({url:"/api/wechat/unbind",method:"delete"})}const ge={class:"code-input-wrapper"},be={class:"dialog-footer"},ye={__name:"BindPhoneDialog",props:{modelValue:{type:Boolean,default:!1}},emits:["update:modelValue","success"],setup(E,{emit:N}){const I=E,x=N,b=g(!1),P=g(!1),h=g(!1),k=g(null),C=g(null),i=$({phone:"",code:""});G(()=>I.modelValue,r=>{b.value=r,r||T()}),G(b,r=>{x("update:modelValue",r)});const Y={phone:[{validator:(r,n,v)=>{n?O(n)?v():v(new Error("请输入正确的手机号")):v(new Error("请输入手机号"))},trigger:"blur"}],code:[{validator:(r,n,v)=>{n?/^\d{6}$/.test(n)?v():v(new Error("请输入6位数字验证码")):v(new Error("请输入验证码"))},trigger:"blur"}]},D=async()=>{var r;if(!i.phone){p.warning("请输入手机号");return}if(!O(i.phone)){p.warning("请输入正确的手机号");return}h.value=!0;try{const n=await ce({phone:i.phone,type:"bind"});n.code===200?(p.success("验证码已发送"),(r=C.value)==null||r.startCountdown()):p.error(n.message||"发送验证码失败")}catch(n){console.error("发送验证码失败:",n),p.error("发送验证码失败")}finally{h.value=!1}},Z=()=>{k.value.validate(async r=>{if(r){P.value=!0;try{const n=await we({phone:i.phone,code:i.code});n.code===200?(p.success("手机号绑定成功"),x("success"),b.value=!1):p.error(n.message||"绑定失败")}catch(n){console.error("绑定手机号失败:",n),p.error("绑定失败")}finally{P.value=!1}}})},T=()=>{var r,n;i.phone="",i.code="",(r=k.value)==null||r.clearValidate(),(n=C.value)==null||n.stopCountdown()},M=()=>{T()};return(r,n)=>{const v=m("el-input"),S=m("el-form-item"),z=m("el-form"),F=m("el-button"),W=m("el-dialog");return c(),y(W,{modelValue:b.value,"onUpdate:modelValue":n[3]||(n[3]=V=>b.value=V),title:"绑定手机号",width:"450px","close-on-click-modal":!1,class:"bind-phone-dialog",onClose:M},{footer:l(()=>[t("div",be,[o(F,{onClick:n[2]||(n[2]=V=>b.value=!1),class:"cancel-btn"},{default:l(()=>[...n[4]||(n[4]=[f("取消",-1)])]),_:1}),o(F,{type:"primary",loading:P.value,onClick:Z,class:"confirm-btn"},{default:l(()=>[...n[5]||(n[5]=[f(" 确认绑定 ",-1)])]),_:1},8,["loading"])])]),default:l(()=>[o(z,{ref_key:"formRef",ref:k,model:i,rules:Y,"label-width":"0"},{default:l(()=>[o(S,{prop:"phone"},{default:l(()=>[o(v,{modelValue:i.phone,"onUpdate:modelValue":n[0]||(n[0]=V=>i.phone=V),placeholder:"请输入手机号",size:"large","prefix-icon":"Iphone",maxlength:"11"},null,8,["modelValue"])]),_:1}),o(S,{prop:"code"},{default:l(()=>[t("div",ge,[o(v,{modelValue:i.code,"onUpdate:modelValue":n[1]||(n[1]=V=>i.code=V),placeholder:"请输入验证码",size:"large","prefix-icon":"Message",maxlength:"6"},null,8,["modelValue"]),o(fe,{ref_key:"smsCountdownRef",ref:C,disabled:!i.phone||!K(O)(i.phone),loading:h.value,text:"获取验证码",class:"send-code-btn",onSend:D},null,8,["disabled","loading"])])]),_:1})]),_:1},8,["model"])]),_:1},8,["modelValue"])}}},Ve=J(ye,[["__scopeId","data-v-80f597d0"]]),Pe={class:"profile-container"},he={class:"binding-section"},ke={class:"binding-item"},Ce={class:"binding-info"},Ue={class:"binding-icon"},xe={class:"binding-content"},Re={key:0,class:"binding-value"},Be={key:1,class:"binding-placeholder"},Ee={class:"binding-action"},Ne={class:"binding-item"},Ie={class:"binding-info"},Se={class:"binding-content"},Fe={key:0,class:"binding-value"},Le={key:1,class:"binding-placeholder"},$e={class:"binding-action"},De={__name:"Profile",setup(E){const N=se(),I=g("info"),x=g(null),b=g(null),P=g(!1),h=g(!1),k=g(!1),C=g(!1),i=$({nickname:"",avatar:""}),a=$({username:"",realName:"",phone:"",email:"",gender:0,memberLevel:0,points:0,balance:0}),w=$({oldPassword:"",newPassword:"",confirmPassword:""}),D={email:[{validator:(s,e,u)=>{e&&!me(e)?u(new Error("请输入正确的邮箱格式")):u()},trigger:"blur"}]},M={oldPassword:[{required:!0,message:"请输入原密码",trigger:"blur"}],newPassword:[{validator:(s,e,u)=>{e?pe(e)?u():u(new Error("密码长度为6-20位")):u(new Error("请输入新密码"))},trigger:"blur"}],confirmPassword:[{validator:(s,e,u)=>{e?e!==w.newPassword?u(new Error("两次输入的密码不一致")):u():u(new Error("请确认密码"))},trigger:"blur"}]},r=async()=>{try{await N.getUserInfo(),Object.assign(a,N.userInfo)}catch(s){console.error("获取用户信息失败",s)}},n=()=>{x.value.validate(async s=>{if(s){P.value=!0;try{await ie({realName:a.realName,email:a.email,gender:a.gender}),p.success("保存成功"),await r()}catch(e){console.error("保存失败",e)}finally{P.value=!1}}})},v=()=>{b.value.validate(async s=>{if(s){h.value=!0;try{await ue({oldPassword:w.oldPassword,newPassword:w.newPassword}),p.success("密码修改成功"),w.oldPassword="",w.newPassword="",w.confirmPassword="",b.value.resetFields()}catch(e){console.error("密码修改失败",e)}finally{h.value=!1}}})},S=s=>s?s.replace(/(\d{3})\d{4}(\d{4})/,"$1****$2"):"",z=()=>{k.value=!0},F=()=>{r()},W=async()=>{try{await H.confirm("解绑后将无法使用手机号登录,确定要解绑吗?","确认解绑",{confirmButtonText:"确定",cancelButtonText:"取消",type:"warning"});const s=await _e();s.code===200?(p.success("手机号解绑成功"),await r()):p.error(s.message||"解绑失败")}catch(s){s!=="cancel"&&(console.error("解绑手机号失败:",s),p.error("解绑失败,请稍后重试"))}},V=()=>{p.info("微信绑定功能开发中")},Q=async()=>{try{await H.confirm("确定要解绑微信账号吗?","确认解绑",{confirmButtonText:"确定",cancelButtonText:"取消",type:"warning"});const s=await ve();s.code===200?(p.success("微信解绑成功"),C.value=!1,i.nickname="",i.avatar=""):p.error(s.message||"解绑失败")}catch(s){s!=="cancel"&&(console.error("解绑微信失败:",s),p.error("解绑失败,请稍后重试"))}};return te(()=>{r()}),(s,e)=>{const u=m("el-input"),_=m("el-form-item"),j=m("el-radio"),ee=m("el-radio-group"),R=m("el-tag"),U=m("el-button"),A=m("el-form"),q=m("el-tab-pane"),oe=m("el-icon"),le=m("el-divider"),ne=m("el-tabs"),ae=m("el-card");return c(),B("div",Pe,[e[27]||(e[27]=t("div",{class:"profile-header"},[t("h2",null,"个人中心")],-1)),o(ae,{class:"profile-card"},{default:l(()=>[o(ne,{modelValue:I.value,"onUpdate:modelValue":e[8]||(e[8]=d=>I.value=d)},{default:l(()=>[o(q,{label:"基本信息",name:"info"},{default:l(()=>[o(A,{ref_key:"infoFormRef",ref:x,model:a,rules:D,"label-width":"100px"},{default:l(()=>[o(_,{label:"用户名"},{default:l(()=>[o(u,{modelValue:a.username,"onUpdate:modelValue":e[0]||(e[0]=d=>a.username=d),disabled:""},null,8,["modelValue"])]),_:1}),o(_,{label:"真实姓名",prop:"realName"},{default:l(()=>[o(u,{modelValue:a.realName,"onUpdate:modelValue":e[1]||(e[1]=d=>a.realName=d),placeholder:"请输入真实姓名"},null,8,["modelValue"])]),_:1}),o(_,{label:"手机号"},{default:l(()=>[o(u,{modelValue:a.phone,"onUpdate:modelValue":e[2]||(e[2]=d=>a.phone=d),disabled:""},null,8,["modelValue"])]),_:1}),o(_,{label:"邮箱",prop:"email"},{default:l(()=>[o(u,{modelValue:a.email,"onUpdate:modelValue":e[3]||(e[3]=d=>a.email=d),placeholder:"请输入邮箱"},null,8,["modelValue"])]),_:1}),o(_,{label:"性别"},{default:l(()=>[o(ee,{modelValue:a.gender,"onUpdate:modelValue":e[4]||(e[4]=d=>a.gender=d)},{default:l(()=>[o(j,{label:0},{default:l(()=>[...e[10]||(e[10]=[f("未知",-1)])]),_:1}),o(j,{label:1},{default:l(()=>[...e[11]||(e[11]=[f("男",-1)])]),_:1}),o(j,{label:2},{default:l(()=>[...e[12]||(e[12]=[f("女",-1)])]),_:1})]),_:1},8,["modelValue"])]),_:1}),o(_,{label:"会员等级"},{default:l(()=>[a.memberLevel===0?(c(),y(R,{key:0},{default:l(()=>[...e[13]||(e[13]=[f("普通用户",-1)])]),_:1})):a.memberLevel===1?(c(),y(R,{key:1,type:"info"},{default:l(()=>[...e[14]||(e[14]=[f("银卡会员",-1)])]),_:1})):a.memberLevel===2?(c(),y(R,{key:2,type:"warning"},{default:l(()=>[...e[15]||(e[15]=[f("金卡会员",-1)])]),_:1})):a.memberLevel===3?(c(),y(R,{key:3,type:"primary"},{default:l(()=>[...e[16]||(e[16]=[f("铂金会员",-1)])]),_:1})):a.memberLevel===4?(c(),y(R,{key:4,type:"danger"},{default:l(()=>[...e[17]||(e[17]=[f("VIP会员",-1)])]),_:1})):re("",!0)]),_:1}),o(_,{label:"积分"},{default:l(()=>[t("span",null,L(a.points||0),1)]),_:1}),o(_,{label:"余额"},{default:l(()=>[t("span",null,"¥"+L(a.balance||0),1)]),_:1}),o(_,null,{default:l(()=>[o(U,{type:"primary",loading:P.value,onClick:n},{default:l(()=>[...e[18]||(e[18]=[f(" 保存修改 ",-1)])]),_:1},8,["loading"])]),_:1})]),_:1},8,["model"])]),_:1}),o(q,{label:"修改密码",name:"password"},{default:l(()=>[o(A,{ref_key:"passwordFormRef",ref:b,model:w,rules:M,"label-width":"100px"},{default:l(()=>[o(_,{label:"原密码",prop:"oldPassword"},{default:l(()=>[o(u,{modelValue:w.oldPassword,"onUpdate:modelValue":e[5]||(e[5]=d=>w.oldPassword=d),type:"password",placeholder:"请输入原密码","show-password":""},null,8,["modelValue"])]),_:1}),o(_,{label:"新密码",prop:"newPassword"},{default:l(()=>[o(u,{modelValue:w.newPassword,"onUpdate:modelValue":e[6]||(e[6]=d=>w.newPassword=d),type:"password",placeholder:"请输入新密码（6-20位）","show-password":""},null,8,["modelValue"])]),_:1}),o(_,{label:"确认密码",prop:"confirmPassword"},{default:l(()=>[o(u,{modelValue:w.confirmPassword,"onUpdate:modelValue":e[7]||(e[7]=d=>w.confirmPassword=d),type:"password",placeholder:"请再次输入新密码","show-password":""},null,8,["modelValue"])]),_:1}),o(_,null,{default:l(()=>[o(U,{type:"primary",loading:h.value,onClick:v},{default:l(()=>[...e[19]||(e[19]=[f(" 修改密码 ",-1)])]),_:1},8,["loading"])]),_:1})]),_:1},8,["model"])]),_:1}),o(q,{label:"账号绑定",name:"binding"},{default:l(()=>[t("div",he,[t("div",ke,[t("div",Ce,[t("div",Ue,[o(oe,{size:24},{default:l(()=>[o(K(de))]),_:1})]),t("div",xe,[e[20]||(e[20]=t("h4",null,"手机号",-1)),a.phone?(c(),B("p",Re,L(S(a.phone)),1)):(c(),B("p",Be,"未绑定"))])]),t("div",Ee,[a.phone?(c(),y(U,{key:0,type:"danger",plain:"",onClick:W},{default:l(()=>[...e[21]||(e[21]=[f(" 解绑 ",-1)])]),_:1})):(c(),y(U,{key:1,type:"primary",onClick:z},{default:l(()=>[...e[22]||(e[22]=[f(" 绑定 ",-1)])]),_:1}))])]),o(le),t("div",Ne,[t("div",Ie,[e[24]||(e[24]=t("div",{class:"binding-icon wechat"},[t("svg",{class:"icon","aria-hidden":"true"},[t("use",{"xlink:href":"#icon-wechat"})])],-1)),t("div",Se,[e[23]||(e[23]=t("h4",null,"微信账号",-1)),C.value?(c(),B("p",Fe,L(i.nickname||"已绑定"),1)):(c(),B("p",Le,"未绑定"))])]),t("div",$e,[C.value?(c(),y(U,{key:0,type:"danger",plain:"",onClick:Q},{default:l(()=>[...e[25]||(e[25]=[f(" 解绑 ",-1)])]),_:1})):(c(),y(U,{key:1,type:"success",onClick:V},{default:l(()=>[...e[26]||(e[26]=[f(" 绑定 ",-1)])]),_:1}))])])])]),_:1})]),_:1},8,["modelValue"])]),_:1}),o(Ve,{modelValue:k.value,"onUpdate:modelValue":e[9]||(e[9]=d=>k.value=d),onSuccess:F},null,8,["modelValue"])])}}},We=J(De,[["__scopeId","data-v-7725a850"]]);export{We as default};
