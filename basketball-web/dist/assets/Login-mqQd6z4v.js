import{_ as A,r as p,w as W,c as J,o as V,a as s,b as t,d as C,e as o,u as E,l as O,f,g as X,s as Y,h as Z,i as b,E as u,j as N,k as ee,m as T}from"./index-DfALJeeI.js";import{u as oe}from"./user-6l3YhxiV.js";import{v as P,a as le,b as se}from"./validate-CbFD6edE.js";import{g as ne,S as te,l as ae,s as re}from"./SmsCountdown-nzEWJ3w-.js";import"./user-D_OnkJXJ.js";import"./request-CZtBzr0V.js";const de={class:"wechat-login-content"},ie={key:0,class:"loading-box"},ue={key:1,class:"qrcode-box"},ce=["src"],pe={key:0,class:"scan-status"},me={key:2,class:"error-box"},fe={__name:"WechatLoginDialog",props:{modelValue:{type:Boolean,default:!1}},emits:["update:modelValue","success"],setup($,{emit:h}){const _=$,x=h,i=p(!1),w=p(!1),m=p(""),y=p("");W(()=>_.modelValue,r=>{i.value=r,r&&g()}),W(i,r=>{x("update:modelValue",r)});const g=async()=>{w.value=!0,y.value="";try{const r=await ne();r.code===200?(m.value=r.data.qrCodeUrl,R()):(u.error(r.message||"获取二维码失败"),m.value="")}catch(r){console.error("获取微信授权URL失败:",r),u.error("获取二维码失败,请重试"),m.value=""}finally{w.value=!1}},R=()=>{},a=()=>{m.value="",y.value=""};return(r,n)=>{const k=f("el-icon"),U=f("el-button"),z=f("el-dialog");return V(),J(z,{modelValue:i.value,"onUpdate:modelValue":n[1]||(n[1]=L=>i.value=L),title:"微信扫码登录",width:"400px","close-on-click-modal":!1,onClose:a},{footer:s(()=>[o(U,{onClick:n[0]||(n[0]=L=>i.value=!1)},{default:s(()=>[...n[7]||(n[7]=[b("取消",-1)])]),_:1})]),default:s(()=>[t("div",de,[w.value?(V(),C("div",ie,[o(k,{class:"is-loading"},{default:s(()=>[o(E(O))]),_:1}),n[2]||(n[2]=t("p",null,"正在加载二维码...",-1))])):m.value?(V(),C("div",ue,[t("img",{src:m.value,alt:"微信扫码登录",class:"qrcode-image"},null,8,ce),n[4]||(n[4]=t("p",{class:"qrcode-tip"},"请使用微信扫描二维码登录",-1)),y.value==="scanned"?(V(),C("div",pe,[o(k,{color:"#67C23A"},{default:s(()=>[o(E(Y))]),_:1}),n[3]||(n[3]=t("p",null,"扫码成功,请在手机上确认登录",-1))])):X("",!0)])):(V(),C("div",me,[o(k,{color:"#F56C6C"},{default:s(()=>[o(E(Z))]),_:1}),n[6]||(n[6]=t("p",null,"二维码加载失败",-1)),o(U,{type:"primary",onClick:g},{default:s(()=>[...n[5]||(n[5]=[b("重新加载",-1)])]),_:1})]))])]),_:1},8,["modelValue"])}}},ge=A(fe,[["__scopeId","data-v-fdceec11"]]),ve={class:"login-container"},_e={class:"login-box"},we={class:"code-input-wrapper"},he={class:"oauth-login"},ye={class:"oauth-buttons"},Ve={class:"login-footer"},Ce={__name:"Login",setup($){const h=ee(),_=oe(),x=p("account"),i=p(!1),w=p(!1),m=p(!1),y=p(null),g=N({username:"",password:""}),R=p(null),a=N({phone:"",code:""}),r=p(null),U={username:[{validator:(d,e,l)=>{e?se(e)?l():l(new Error("用户名为3-20位字母、数字或下划线")):l(new Error("请输入用户名"))},trigger:"blur"}],password:[{validator:(d,e,l)=>{e?le(e)?l():l(new Error("密码长度为6-20位")):l(new Error("请输入密码"))},trigger:"blur"}]},D={phone:[{validator:(d,e,l)=>{e?P(e)?l():l(new Error("请输入正确的手机号")):l(new Error("请输入手机号"))},trigger:"blur"}],code:[{validator:(d,e,l)=>{e?/^\d{6}$/.test(e)?l():l(new Error("请输入6位数字验证码")):l(new Error("请输入验证码"))},trigger:"blur"}]},F=()=>{y.value.validate(async d=>{if(d){i.value=!0;try{await _.login(g),u.success("登录成功"),h.push("/")}catch(e){console.error("登录失败",e)}finally{i.value=!1}}})},K=async()=>{var d;if(!a.phone){u.warning("请输入手机号");return}if(!P(a.phone)){u.warning("请输入正确的手机号");return}w.value=!0;try{const e=await re({phone:a.phone,type:"login"});e.code===200?(u.success("验证码已发送,请注意查收"),(d=r.value)==null||d.startCountdown()):u.error(e.message||"发送验证码失败")}catch(e){console.error("发送验证码失败:",e),u.error("发送验证码失败,请稍后重试")}finally{w.value=!1}},B=()=>{R.value.validate(async d=>{if(d){i.value=!0;try{const e=await ae({phone:a.phone,code:a.code});if(e.code===200){const{token:l,user:v}=e.data;_.setToken(l),_.setUserInfo(v),u.success("登录成功"),h.push("/")}else u.error(e.message||"登录失败")}catch(e){console.error("手机登录失败:",e),u.error("登录失败,请检查验证码是否正确")}finally{i.value=!1}}})},M=()=>{m.value=!0},j=d=>{const{token:e,user:l}=d;_.setToken(e),_.setUserInfo(l),u.success("微信登录成功"),h.push("/")},Q=()=>{h.push("/register")};return(d,e)=>{const l=f("el-input"),v=f("el-form-item"),S=f("el-button"),q=f("el-form"),I=f("el-tab-pane"),G=f("el-tabs"),H=f("el-link");return V(),C("div",ve,[t("div",_e,[e[12]||(e[12]=t("h1",{class:"title"},"篮球馆管理系统",-1)),o(G,{modelValue:x.value,"onUpdate:modelValue":e[4]||(e[4]=c=>x.value=c),class:"login-tabs"},{default:s(()=>[o(I,{label:"账号登录",name:"account"},{default:s(()=>[o(q,{ref_key:"accountFormRef",ref:y,model:g,rules:U,class:"login-form"},{default:s(()=>[o(v,{prop:"username"},{default:s(()=>[o(l,{modelValue:g.username,"onUpdate:modelValue":e[0]||(e[0]=c=>g.username=c),placeholder:"请输入用户名",size:"large","prefix-icon":"User"},null,8,["modelValue"])]),_:1}),o(v,{prop:"password"},{default:s(()=>[o(l,{modelValue:g.password,"onUpdate:modelValue":e[1]||(e[1]=c=>g.password=c),type:"password",placeholder:"请输入密码",size:"large","prefix-icon":"Lock","show-password":"",onKeyup:T(F,["enter"])},null,8,["modelValue"])]),_:1}),o(v,null,{default:s(()=>[o(S,{type:"primary",size:"large",loading:i.value,class:"login-btn",onClick:F},{default:s(()=>[...e[6]||(e[6]=[b(" 登录 ",-1)])]),_:1},8,["loading"])]),_:1})]),_:1},8,["model"])]),_:1}),o(I,{label:"手机登录",name:"phone"},{default:s(()=>[o(q,{ref_key:"phoneFormRef",ref:R,model:a,rules:D,class:"login-form"},{default:s(()=>[o(v,{prop:"phone"},{default:s(()=>[o(l,{modelValue:a.phone,"onUpdate:modelValue":e[2]||(e[2]=c=>a.phone=c),placeholder:"请输入手机号",size:"large","prefix-icon":"Iphone",maxlength:"11"},null,8,["modelValue"])]),_:1}),o(v,{prop:"code"},{default:s(()=>[t("div",we,[o(l,{modelValue:a.code,"onUpdate:modelValue":e[3]||(e[3]=c=>a.code=c),placeholder:"请输入验证码",size:"large","prefix-icon":"Message",maxlength:"6",onKeyup:T(B,["enter"])},null,8,["modelValue"]),o(te,{ref_key:"smsCountdownRef",ref:r,disabled:!a.phone||!E(P)(a.phone),loading:w.value,text:"发送验证码",class:"send-code-btn",onSend:K},null,8,["disabled","loading"])])]),_:1}),o(v,null,{default:s(()=>[o(S,{type:"primary",size:"large",loading:i.value,class:"login-btn",onClick:B},{default:s(()=>[...e[7]||(e[7]=[b(" 登录 ",-1)])]),_:1},8,["loading"])]),_:1})]),_:1},8,["model"])]),_:1})]),_:1},8,["modelValue"]),t("div",he,[e[9]||(e[9]=t("div",{class:"divider"},[t("span",null,"其他登录方式")],-1)),t("div",ye,[o(S,{circle:"",size:"large",class:"wechat-btn",onClick:M},{default:s(()=>[...e[8]||(e[8]=[t("svg",{class:"icon","aria-hidden":"true"},[t("use",{"xlink:href":"#icon-wechat"})],-1)])]),_:1})])]),t("div",Ve,[e[11]||(e[11]=t("span",null,"还没有账号?",-1)),o(H,{type:"primary",onClick:Q},{default:s(()=>[...e[10]||(e[10]=[b("立即注册",-1)])]),_:1})])]),o(ge,{modelValue:m.value,"onUpdate:modelValue":e[5]||(e[5]=c=>m.value=c),onSuccess:j},null,8,["modelValue"])])}}},Le=A(Ce,[["__scopeId","data-v-396a13a7"]]);export{Le as default};
