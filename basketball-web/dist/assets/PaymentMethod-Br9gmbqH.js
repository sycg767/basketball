import{_ as Fe,j as Pe,r as d,k as X,t as Se,a6 as Ue,E as f,d as Y,e as a,b as t,a as l,f as u,m as $e,a4 as Ie,o as c,c as y,g as x,B as p,z as M,u as z,a8 as Z,i as m,a3 as oe,N as Ee,F as qe,x as Re,ak as je,a9 as Le,M as ne}from"./index-zUzrFZpX.js";import{g as ie,p as Ae}from"./booking-CZxD_MNj.js";import{a as We}from"./member-DdAKiQtd.js";import{B as Oe}from"./BackButton-BCA-o-ra.js";const Ge={class:"payment-method-container"},He={class:"order-info"},Je={class:"info-item"},Ke={class:"value"},Qe={class:"info-item"},Xe={class:"value"},Ye={class:"info-item"},Ze={class:"value amount"},et={class:"payment-methods"},tt={class:"method-content"},at={class:"method-icon balance"},st={class:"method-info"},lt={class:"payment-actions"},ot={class:"records-header"},nt={class:"amount-text"},it={class:"manage-header"},ut={class:"payment-methods-list"},dt={class:"method-card balance-card"},rt={class:"method-header"},ct={class:"method-icon-wrapper"},pt={class:"method-info"},mt={class:"method-actions"},vt={class:"method-header"},yt={class:"method-info"},ft={class:"method-actions"},_t={class:"bills-header"},bt={class:"filter-group"},gt={class:"bill-summary"},ht={class:"summary-item"},kt={class:"summary-value expense"},wt={class:"summary-item"},xt={class:"summary-value income"},Ct={class:"summary-item"},Nt={class:"summary-value"},zt={class:"balance-text"},Tt={__name:"PaymentMethod",setup(Vt){const R=Ue(),T=$e(),ue=Pe(),F=d("records"),ee=d(!1),h=d(!1),_=d("wechat"),V=d("0.00"),i=X({orderNo:"",businessNo:"",businessName:"",businessType:"",amount:"0.00"}),P=d(!1),j=d([]),L=d(1),A=d(10),W=d(0),k=d([]),D=d(!1),r=X({type:"",account:"",isDefault:!1}),S=d(!1),C=d([]),O=d(1),G=d(10),H=d(0),te=d([]),N=X({totalExpense:0,totalIncome:0,totalCount:0});Se(()=>{const{orderNo:o,amount:e}=R.query;o&&e?(ee.value=!0,F.value="method",de(),me()):(F.value="records",U()),ge()});const de=()=>{const{orderNo:o,businessNo:e,businessName:n,businessType:v,amount:w}=R.query;!o||!w||(i.orderNo=o,i.businessNo=e||o,i.businessName=n||"篮球馆服务",i.businessType=v||"booking",i.amount=w)},U=async()=>{P.value=!0;try{const o=await ie({page:L.value,pageSize:A.value,status:1});o.code===200&&(j.value=o.data.records||[],W.value=o.data.total||0)}catch(o){console.error("获取支付记录失败:",o),f.error("获取支付记录失败")}finally{P.value=!1}},$=async()=>{S.value=!0;try{const o=await ie({page:O.value,pageSize:G.value});if(o.code===200){const e=o.data.records||[];C.value=e.map(n=>({createTime:n.payTime||n.createTime,description:`${n.venueName} - ${n.bookingDate} ${n.timeSlot}`,amount:n.actualPrice||0,type:"expense",balance:0})),H.value=o.data.total||0,N.totalExpense=C.value.reduce((n,v)=>v.type==="expense"?n+v.amount:n,0),N.totalIncome=C.value.reduce((n,v)=>v.type==="income"?n+v.amount:n,0),N.totalCount=C.value.length}}catch(o){console.error("获取账单失败:",o),f.error("获取账单失败")}finally{S.value=!1}},re=o=>{T.push(`/booking/detail/${o}`)},ce=o=>({0:"warning",1:"success",2:"info",3:"success",4:"danger",5:"info"})[o]||"info",pe=o=>({0:"待支付",1:"已支付",2:"已取消",3:"已完成",4:"已退款",5:"超时取消"})[o]||"未知",me=async()=>{var o;try{const e=await We();e.code===200&&(V.value=(e.data||0).toFixed(2))}catch(e){console.error("获取用户余额失败:",e);const n=((o=ue.userInfo)==null?void 0:o.balance)||0;V.value=n.toFixed(2)}},ve=()=>{if(!_.value){f.warning("请选择支付方式");return}switch(h.value=!0,_.value){case"wechat":ye();break;case"alipay":fe();break;case"balance":_e();break;default:f.error("不支持的支付方式"),h.value=!1}},ye=()=>{T.push({path:"/payment/wechat",query:{businessNo:i.businessNo,businessType:i.businessType,businessName:i.businessName,amount:i.amount}})},fe=()=>{T.push({path:"/payment/alipay",query:{businessNo:i.businessNo,businessType:i.businessType,businessName:i.businessName,amount:i.amount}})},_e=async()=>{try{const o=parseFloat(V.value),e=parseFloat(i.amount);if(o<e){f.error("余额不足，请充值后再试"),h.value=!1;return}if(await ne.confirm(`确认使用余额支付 ¥${i.amount} 吗？`,"确认支付",{confirmButtonText:"确认",cancelButtonText:"取消",type:"warning"}),i.businessType==="booking"){const n=be(i.businessNo),v=await Ae(n,{paymentMethod:2,paymentType:""});v.code===200?(f.success("支付成功！"),setTimeout(()=>{T.push({path:"/payment/result",query:{status:"success",orderNo:i.orderNo,amount:i.amount,paymentMethod:"余额支付"}})},500)):(f.error(v.message||"支付失败"),h.value=!1)}else f.info("该业务类型暂不支持余额支付"),h.value=!1}catch(o){if(o==="cancel"){h.value=!1;return}console.error("余额支付失败:",o),f.error(o.message||"支付失败，请稍后重试"),h.value=!1}},be=o=>R.query.bookingId||o.replace(/\D/g,""),ge=()=>{k.value=[{id:1,type:"wechat",name:"微信支付",account:"微信账号: wx***123",isDefault:!0},{id:2,type:"alipay",name:"支付宝支付",account:"支付宝账号: 138****5678",isDefault:!1}]},he=()=>{if(!r.type||!r.account){f.warning("请填写完整信息");return}const o={wechat:"微信支付",alipay:"支付宝支付",bankcard:"银行卡"},e={id:Date.now(),type:r.type,name:o[r.type],account:r.account,isDefault:r.isDefault};r.isDefault&&k.value.forEach(n=>n.isDefault=!1),k.value.push(e),f.success("添加成功"),D.value=!1,r.type="",r.account="",r.isDefault=!1},ke=o=>{k.value.forEach(e=>{e.isDefault=e.id===o}),f.success("已设为默认支付方式")},we=async o=>{try{await ne.confirm("确定要解绑此支付方式吗？","提示",{confirmButtonText:"确定",cancelButtonText:"取消",type:"warning"});const e=k.value.findIndex(n=>n.id===o);e>-1&&(k.value.splice(e,1),f.success("解绑成功"))}catch{}},xe=()=>{T.push("/member/balance-recharge")};return(o,e)=>{const n=u("el-divider"),v=u("el-radio"),w=u("el-icon"),Ce=u("el-radio-group"),b=u("el-button"),I=u("el-card"),E=u("el-tab-pane"),g=u("el-table-column"),q=u("el-tag"),ae=u("el-table"),se=u("el-pagination"),J=u("el-empty"),Ne=u("el-date-picker"),ze=u("el-tabs"),K=u("el-option"),Te=u("el-select"),Q=u("el-form-item"),Ve=u("el-input"),De=u("el-switch"),Be=u("el-form"),Me=u("el-dialog"),le=Ie("loading");return c(),Y("div",Ge,[a(Oe,{text:"返回"}),e[44]||(e[44]=t("h2",{class:"page-title"},"支付管理",-1)),a(ze,{modelValue:F.value,"onUpdate:modelValue":e[10]||(e[10]=s=>F.value=s),class:"payment-tabs"},{default:l(()=>[ee.value?(c(),y(E,{key:0,label:"支付方式",name:"method"},{default:l(()=>[a(I,{class:"payment-card"},{default:l(()=>[t("div",He,[e[19]||(e[19]=t("h2",{class:"section-title"},"订单信息",-1)),t("div",Je,[e[16]||(e[16]=t("span",{class:"label"},"订单编号:",-1)),t("span",Ke,p(i.orderNo||"-"),1)]),t("div",Qe,[e[17]||(e[17]=t("span",{class:"label"},"商品名称:",-1)),t("span",Xe,p(i.businessName||"-"),1)]),t("div",Ye,[e[18]||(e[18]=t("span",{class:"label"},"订单金额:",-1)),t("span",Ze,"¥"+p(i.amount||"0.00"),1)])]),a(n),t("div",et,[e[23]||(e[23]=t("h2",{class:"section-title"},"选择支付方式",-1)),a(Ce,{modelValue:_.value,"onUpdate:modelValue":e[3]||(e[3]=s=>_.value=s),class:"method-group"},{default:l(()=>[t("div",{class:M(["method-item",{active:_.value==="wechat"}]),onClick:e[0]||(e[0]=s=>_.value="wechat")},[a(v,{value:"wechat",size:"large"},{default:l(()=>[...e[20]||(e[20]=[t("div",{class:"method-content"},[t("div",{class:"method-icon wechat"},[t("svg",{class:"icon","aria-hidden":"true"},[t("use",{"xlink:href":"#icon-wechat"})])]),t("div",{class:"method-info"},[t("h4",null,"微信支付"),t("p",null,"推荐使用微信扫码支付")])],-1)])]),_:1})],2),t("div",{class:M(["method-item",{active:_.value==="alipay"}]),onClick:e[1]||(e[1]=s=>_.value="alipay")},[a(v,{value:"alipay",size:"large"},{default:l(()=>[...e[21]||(e[21]=[t("div",{class:"method-content"},[t("div",{class:"method-icon alipay"},[t("svg",{class:"icon","aria-hidden":"true"},[t("use",{"xlink:href":"#icon-alipay"})])]),t("div",{class:"method-info"},[t("h4",null,"支付宝支付"),t("p",null,"支持支付宝扫码或跳转支付")])],-1)])]),_:1})],2),t("div",{class:M(["method-item",{active:_.value==="balance"}]),onClick:e[2]||(e[2]=s=>_.value="balance")},[a(v,{value:"balance",size:"large"},{default:l(()=>[t("div",tt,[t("div",at,[a(w,{size:32},{default:l(()=>[a(z(Z))]),_:1})]),t("div",st,[e[22]||(e[22]=t("h4",null,"余额支付",-1)),t("p",null,"当前余额: ¥"+p(V.value),1)])])]),_:1})],2)]),_:1},8,["modelValue"])]),t("div",lt,[a(b,{size:"large",onClick:o.handleCancel},{default:l(()=>[...e[24]||(e[24]=[m("取消",-1)])]),_:1},8,["onClick"]),a(b,{type:"primary",size:"large",loading:h.value,disabled:!_.value,onClick:ve},{default:l(()=>[m(" 确认支付 ¥"+p(i.amount||"0.00"),1)]),_:1},8,["loading","disabled"])])]),_:1})]),_:1})):x("",!0),a(E,{label:"支付记录",name:"records"},{default:l(()=>[a(I,{class:"records-card"},{default:l(()=>[t("div",ot,[e[26]||(e[26]=t("h2",{class:"section-title"},"支付记录",-1)),a(b,{type:"primary",icon:z(Ee),onClick:U},{default:l(()=>[...e[25]||(e[25]=[m("刷新",-1)])]),_:1},8,["icon"])]),oe((c(),y(ae,{data:j.value,style:{width:"100%"},stripe:""},{default:l(()=>[a(g,{prop:"bookingNo",label:"订单号",width:"180"}),a(g,{prop:"venueName",label:"场地名称",width:"150"}),a(g,{prop:"actualPrice",label:"支付金额",width:"120"},{default:l(({row:s})=>{var B;return[t("span",nt,"¥"+p((B=s.actualPrice)==null?void 0:B.toFixed(2)),1)]}),_:1}),a(g,{prop:"payMethodName",label:"支付方式",width:"120"}),a(g,{prop:"payTime",label:"支付时间",width:"180"}),a(g,{prop:"status",label:"状态",width:"100"},{default:l(({row:s})=>[a(q,{type:ce(s.status)},{default:l(()=>[m(p(pe(s.status)),1)]),_:2},1032,["type"])]),_:1}),a(g,{label:"操作",width:"150"},{default:l(({row:s})=>[a(b,{link:"",type:"primary",onClick:B=>re(s.id)},{default:l(()=>[...e[27]||(e[27]=[m("查看详情",-1)])]),_:1},8,["onClick"])]),_:1})]),_:1},8,["data"])),[[le,P.value]]),W.value>0?(c(),y(se,{key:0,"current-page":L.value,"onUpdate:currentPage":e[4]||(e[4]=s=>L.value=s),"page-size":A.value,"onUpdate:pageSize":e[5]||(e[5]=s=>A.value=s),total:W.value,"page-sizes":[10,20,50],layout:"total, sizes, prev, pager, next, jumper",onCurrentChange:U,onSizeChange:U,style:{"margin-top":"20px","justify-content":"center"}},null,8,["current-page","page-size","total"])):x("",!0),!P.value&&j.value.length===0?(c(),y(J,{key:1,description:"暂无支付记录"})):x("",!0)]),_:1})]),_:1}),a(E,{label:"支付方式管理",name:"manage"},{default:l(()=>[a(I,{class:"manage-card"},{default:l(()=>[t("div",it,[e[29]||(e[29]=t("h2",{class:"section-title"},"我的支付方式",-1)),a(b,{type:"primary",onClick:e[6]||(e[6]=s=>D.value=!0)},{default:l(()=>[...e[28]||(e[28]=[m("添加支付方式",-1)])]),_:1})]),t("div",ut,[t("div",dt,[t("div",rt,[t("div",ct,[a(w,{size:32,color:"#F56C6C"},{default:l(()=>[a(z(Z))]),_:1})]),t("div",pt,[e[30]||(e[30]=t("h4",null,"余额支付",-1)),t("p",null,"当前余额: ¥"+p(V.value),1)]),a(q,{type:"success"},{default:l(()=>[...e[31]||(e[31]=[m("已启用",-1)])]),_:1})]),t("div",mt,[a(b,{link:"",type:"primary",onClick:xe},{default:l(()=>[...e[32]||(e[32]=[m("充值",-1)])]),_:1})])]),(c(!0),Y(qe,null,Re(k.value,s=>(c(),Y("div",{class:"method-card",key:s.id},[t("div",vt,[t("div",{class:M(["method-icon-wrapper",s.type])},[s.type==="wechat"?(c(),y(w,{key:0,size:32,color:"#07C160"},{default:l(()=>[a(z(je))]),_:1})):s.type==="alipay"?(c(),y(w,{key:1,size:32,color:"#1677FF"},{default:l(()=>[a(z(Z))]),_:1})):(c(),y(w,{key:2,size:32,color:"#409EFF"},{default:l(()=>[a(z(Le))]),_:1}))],2),t("div",yt,[t("h4",null,p(s.name),1),t("p",null,p(s.account),1)]),s.isDefault?(c(),y(q,{key:0,type:"success"},{default:l(()=>[...e[33]||(e[33]=[m("默认",-1)])]),_:1})):(c(),y(q,{key:1,type:"info"},{default:l(()=>[...e[34]||(e[34]=[m("备用",-1)])]),_:1}))]),t("div",ft,[s.isDefault?x("",!0):(c(),y(b,{key:0,link:"",type:"primary",onClick:B=>ke(s.id)},{default:l(()=>[...e[35]||(e[35]=[m(" 设为默认 ",-1)])]),_:1},8,["onClick"])),a(b,{link:"",type:"danger",onClick:B=>we(s.id)},{default:l(()=>[...e[36]||(e[36]=[m("解绑",-1)])]),_:1},8,["onClick"])])]))),128)),k.value.length===0?(c(),y(J,{key:0,description:"暂无绑定的支付方式"})):x("",!0)])]),_:1})]),_:1}),a(E,{label:"账单管理",name:"bills"},{default:l(()=>[a(I,{class:"bills-card"},{default:l(()=>[t("div",_t,[e[38]||(e[38]=t("h2",{class:"section-title"},"账单管理",-1)),t("div",bt,[a(Ne,{modelValue:te.value,"onUpdate:modelValue":e[7]||(e[7]=s=>te.value=s),type:"daterange","range-separator":"至","start-placeholder":"开始日期","end-placeholder":"结束日期",onChange:$},null,8,["modelValue"]),a(b,{type:"primary",onClick:$},{default:l(()=>[...e[37]||(e[37]=[m("查询",-1)])]),_:1})])]),t("div",gt,[t("div",ht,[e[39]||(e[39]=t("div",{class:"summary-label"},"总支出",-1)),t("div",kt,"¥"+p(N.totalExpense.toFixed(2)),1)]),t("div",wt,[e[40]||(e[40]=t("div",{class:"summary-label"},"总收入",-1)),t("div",xt,"¥"+p(N.totalIncome.toFixed(2)),1)]),t("div",Ct,[e[41]||(e[41]=t("div",{class:"summary-label"},"交易笔数",-1)),t("div",Nt,p(N.totalCount),1)])]),oe((c(),y(ae,{data:C.value,style:{width:"100%","margin-top":"20px"},stripe:""},{default:l(()=>[a(g,{prop:"createTime",label:"交易时间",width:"180"}),a(g,{prop:"description",label:"交易说明","min-width":"200"}),a(g,{prop:"amount",label:"金额",width:"150"},{default:l(({row:s})=>[t("span",{class:M(["amount-text",s.type==="expense"?"expense":"income"])},p(s.type==="expense"?"-":"+")+"¥"+p(s.amount.toFixed(2)),3)]),_:1}),a(g,{prop:"balance",label:"余额",width:"150"},{default:l(({row:s})=>[t("span",zt,"¥"+p(s.balance.toFixed(2)),1)]),_:1})]),_:1},8,["data"])),[[le,S.value]]),H.value>0?(c(),y(se,{key:0,"current-page":O.value,"onUpdate:currentPage":e[8]||(e[8]=s=>O.value=s),"page-size":G.value,"onUpdate:pageSize":e[9]||(e[9]=s=>G.value=s),total:H.value,"page-sizes":[10,20,50],layout:"total, sizes, prev, pager, next, jumper",onCurrentChange:$,onSizeChange:$,style:{"margin-top":"20px","justify-content":"center"}},null,8,["current-page","page-size","total"])):x("",!0),!S.value&&C.value.length===0?(c(),y(J,{key:1,description:"暂无账单记录"})):x("",!0)]),_:1})]),_:1})]),_:1},8,["modelValue"]),a(Me,{modelValue:D.value,"onUpdate:modelValue":e[15]||(e[15]=s=>D.value=s),title:"添加支付方式",width:"500px"},{footer:l(()=>[a(b,{onClick:e[14]||(e[14]=s=>D.value=!1)},{default:l(()=>[...e[42]||(e[42]=[m("取消",-1)])]),_:1}),a(b,{type:"primary",onClick:he},{default:l(()=>[...e[43]||(e[43]=[m("确定",-1)])]),_:1})]),default:l(()=>[a(Be,{model:r,"label-width":"100px"},{default:l(()=>[a(Q,{label:"支付方式"},{default:l(()=>[a(Te,{modelValue:r.type,"onUpdate:modelValue":e[11]||(e[11]=s=>r.type=s),placeholder:"请选择支付方式"},{default:l(()=>[a(K,{label:"微信支付",value:"wechat"}),a(K,{label:"支付宝支付",value:"alipay"}),a(K,{label:"银行卡",value:"bankcard"})]),_:1},8,["modelValue"])]),_:1}),a(Q,{label:"账号信息"},{default:l(()=>[a(Ve,{modelValue:r.account,"onUpdate:modelValue":e[12]||(e[12]=s=>r.account=s),placeholder:"请输入账号"},null,8,["modelValue"])]),_:1}),a(Q,{label:"设为默认"},{default:l(()=>[a(De,{modelValue:r.isDefault,"onUpdate:modelValue":e[13]||(e[13]=s=>r.isDefault=s)},null,8,["modelValue"])]),_:1})]),_:1},8,["model"])]),_:1},8,["modelValue"])])}}},Pt=Fe(Tt,[["__scopeId","data-v-3fc7bb42"]]);export{Pt as default};
