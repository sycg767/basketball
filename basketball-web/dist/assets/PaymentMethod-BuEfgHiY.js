import{_ as Ue,j as Ee,r as y,k as Z,t as $e,a7 as qe,E as c,d as W,e as a,b as t,a as o,f as p,m as Re,a5 as Ae,o as m,c as h,g as z,v as f,O as U,u as V,a9 as ee,i as g,a4 as ue,G as je,F as Le,N as Oe,ad as We,aa as Ge,D as re}from"./index-BU1z93KZ.js";import{g as de,p as He}from"./booking-B6-L4TYR.js";import{p as te}from"./course-a8-PN5Sg.js";import{i as ce,a as Je}from"./member-Cz1wm3WK.js";import{B as Ke}from"./BackButton-CN15_tN6.js";const Qe={class:"payment-method-container"},Xe={class:"order-info"},Ye={class:"info-item"},Ze={class:"value"},et={class:"info-item"},tt={class:"value"},at={class:"info-item"},st={class:"value amount"},ot={class:"payment-methods"},lt={class:"method-content"},nt={class:"method-icon balance"},it={class:"method-info"},ut={class:"payment-actions"},rt={class:"records-header"},dt={class:"amount-text"},ct={key:1,style:{color:"#909399"}},pt={class:"manage-header"},mt={class:"payment-methods-list"},yt={class:"method-card balance-card"},vt={class:"method-header"},ft={class:"method-icon-wrapper"},bt={class:"method-info"},gt={class:"method-actions"},_t={class:"method-header"},ht={class:"method-info"},kt={class:"method-actions"},Tt={class:"bills-header"},wt={class:"filter-group"},Nt={class:"bill-summary"},xt={class:"summary-item"},Ct={class:"summary-value expense"},Mt={class:"summary-item"},zt={class:"summary-value income"},Bt={class:"summary-item"},Dt={class:"summary-value"},Vt={class:"balance-text"},Ft={__name:"PaymentMethod",setup(It){const G=qe(),N=Re(),pe=Ee(),E=y("records"),ae=y(!1),_=y(!1),T=y("wechat"),F=y("0.00"),i=Z({orderNo:"",businessNo:"",businessName:"",businessType:"",amount:"0.00"}),$=y(!1),H=y([]),q=y(1),R=y(10),J=y(0),x=y([]),I=y(!1),v=Z({type:"",account:"",isDefault:!1}),A=y(!1),B=y([]),j=y(1),L=y(10),K=y(0),se=y([]),D=Z({totalExpense:0,totalIncome:0,totalCount:0});$e(()=>{const{type:l,enrollmentId:e,orderNo:u,amount:r}=G.query;l==="course"&&e&&r||u&&r?(ae.value=!0,E.value="method",me(),oe()):(E.value="records",O()),Te()});const me=()=>{const{type:l,enrollmentId:e,orderNo:u,businessNo:r,businessName:w,businessType:C,amount:d}=G.query;d&&(l==="course"&&e?(i.orderNo=`ENR${e}`,i.businessNo=e,i.businessName="课程报名",i.businessType="course",i.amount=d):u&&(i.orderNo=u,i.businessNo=r||u,i.businessName=w||"篮球馆服务",i.businessType=C||"booking",i.amount=d))},O=async()=>{var l,e;$.value=!0;try{const u=await de({page:q.value,pageSize:R.value,status:1});let r=null;try{r=await ce({page:q.value,pageSize:R.value})}catch{console.warn("余额充值记录API暂未实现，跳过")}const w=(u.code===200?u.data.records||[]:[]).map(n=>({id:n.id,orderNo:n.bookingNo,businessType:"booking",businessName:n.venueName,amount:n.actualPrice,payMethodName:n.payMethodName||"未知",payTime:n.payTime,status:n.status})),C=((r==null?void 0:r.code)===200?r.data.records||[]:[]).map(n=>({id:n.id,orderNo:n.paymentNo||n.orderNo,businessType:"balance_recharge",businessName:"账户余额充值",amount:n.amount,payMethodName:n.payMethodName||"在线支付",payTime:n.payTime||n.createTime,status:n.status})),d=[...w,...C];d.sort((n,k)=>{const b=new Date(n.payTime||0).getTime();return new Date(k.payTime||0).getTime()-b}),H.value=d,J.value=(((l=u.data)==null?void 0:l.total)||0)+(((e=r==null?void 0:r.data)==null?void 0:e.total)||0)}catch(u){console.error("获取支付记录失败:",u),c.error("获取支付记录失败")}finally{$.value=!1}},P=async()=>{var l,e;A.value=!0;try{const u=await de({page:j.value,pageSize:L.value,status:1});let r=null;try{r=await ce({page:j.value,pageSize:L.value})}catch{console.warn("余额充值记录API暂未实现，跳过")}const w=(u.code===200?u.data.records||[]:[]).map(n=>({createTime:n.payTime||n.createTime,description:`场地预订 - ${n.venueName}`,amount:n.actualPrice||0,type:"expense",balance:0})),C=((r==null?void 0:r.code)===200?r.data.records||[]:[]).filter(n=>n.status===2).map(n=>({createTime:n.payTime||n.createTime,description:"账户余额充值",amount:n.amount||0,type:"income",balance:0})),d=[...w,...C];d.sort((n,k)=>{const b=new Date(n.createTime||0).getTime();return new Date(k.createTime||0).getTime()-b}),B.value=d,K.value=(((l=u.data)==null?void 0:l.total)||0)+(((e=r==null?void 0:r.data)==null?void 0:e.total)||0),D.totalExpense=B.value.reduce((n,k)=>k.type==="expense"?n+k.amount:n,0),D.totalIncome=B.value.reduce((n,k)=>k.type==="income"?n+k.amount:n,0),D.totalCount=B.value.length}catch(u){console.error("获取账单失败:",u),c.error("获取账单失败")}finally{A.value=!1}},ye=l=>{l.businessType==="booking"&&N.push(`/booking/detail/${l.id}`)},ve=(l,e)=>e==="balance_recharge"?{0:"warning",1:"info",2:"success",3:"danger",4:"info",5:"warning"}[l]||"info":{0:"warning",1:"success",2:"info",3:"success",4:"warning",5:"info"}[l]||"info",fe=(l,e)=>e==="balance_recharge"?{0:"待支付",1:"支付中",2:"支付成功",3:"支付失败",4:"已取消",5:"已退款"}[l]||"未知":{0:"待支付",1:"已支付",2:"已取消",3:"已完成",4:"已退款",5:"超时取消"}[l]||"未知",oe=async()=>{var l;try{const e=await Je();e.code===200&&(F.value=(e.data||0).toFixed(2))}catch(e){console.error("获取用户余额失败:",e);const u=((l=pe.userInfo)==null?void 0:l.balance)||0;F.value=u.toFixed(2)}},be=()=>{if(!T.value){c.warning("请选择支付方式");return}switch(_.value=!0,T.value){case"wechat":ge();break;case"alipay":_e();break;case"balance":he();break;default:c.error("不支持的支付方式"),_.value=!1}},ge=async()=>{if(i.businessType==="course"){_.value=!0;try{const l=i.businessNo,e=await te(l,{paymentMethod:1,paymentType:"wechat"});e.code===200?(c.success("支付成功！"),setTimeout(()=>{N.push({path:"/payment/result",query:{status:"success",orderNo:i.orderNo,amount:i.amount,paymentMethod:"微信支付",type:"course"}})},500)):(c.error(e.message||"支付失败"),_.value=!1)}catch(l){c.error(l.message||"支付失败"),_.value=!1}return}N.push({path:"/payment/wechat",query:{businessNo:i.businessNo,businessType:i.businessType,businessName:i.businessName,amount:i.amount}})},_e=async()=>{if(i.businessType==="course"){_.value=!0;try{const l=i.businessNo,e=await te(l,{paymentMethod:1,paymentType:"alipay"});e.code===200?(c.success("支付成功！"),setTimeout(()=>{N.push({path:"/payment/result",query:{status:"success",orderNo:i.orderNo,amount:i.amount,paymentMethod:"支付宝支付",type:"course"}})},500)):(c.error(e.message||"支付失败"),_.value=!1)}catch(l){c.error(l.message||"支付失败"),_.value=!1}return}N.push({path:"/payment/alipay",query:{businessNo:i.businessNo,businessType:i.businessType,businessName:i.businessName,amount:i.amount}})},he=async()=>{try{const l=parseFloat(F.value),e=parseFloat(i.amount);if(l<e){c.error("余额不足，请充值后再试"),_.value=!1;return}if(await re.confirm(`确认使用余额支付 ¥${i.amount} 吗？`,"确认支付",{confirmButtonText:"确认",cancelButtonText:"取消",type:"warning"}),i.businessType==="booking"){const u=ke(i.businessNo),r=await He(u,{paymentMethod:2,paymentType:""});r.code===200?(c.success("支付成功！"),setTimeout(()=>{N.push({path:"/payment/result",query:{status:"success",orderNo:i.orderNo,amount:i.amount,paymentMethod:"余额支付"}})},500)):(c.error(r.message||"支付失败"),_.value=!1)}else if(i.businessType==="course"){const u=i.businessNo,r=await te(u,{paymentMethod:2,paymentType:""});r.code===200?(c.success("支付成功！"),setTimeout(()=>{N.push({path:"/payment/result",query:{status:"success",orderNo:i.orderNo,amount:i.amount,paymentMethod:"余额支付",type:"course"}})},500)):(c.error(r.message||"支付失败"),_.value=!1)}else c.info("该业务类型暂不支持余额支付"),_.value=!1}catch(l){if(l==="cancel"){_.value=!1;return}console.error("余额支付失败:",l),c.error(l.message||"支付失败，请稍后重试"),_.value=!1}},ke=l=>G.query.bookingId||l.replace(/\D/g,""),Te=()=>{x.value=[{id:1,type:"wechat",name:"微信支付",account:"微信账号: wx***123",isDefault:!0},{id:2,type:"alipay",name:"支付宝支付",account:"支付宝账号: 138****5678",isDefault:!1}]},we=()=>{if(!v.type||!v.account){c.warning("请填写完整信息");return}const l={wechat:"微信支付",alipay:"支付宝支付",bankcard:"银行卡"},e={id:Date.now(),type:v.type,name:l[v.type],account:v.account,isDefault:v.isDefault};v.isDefault&&x.value.forEach(u=>u.isDefault=!1),x.value.push(e),c.success("添加成功"),I.value=!1,v.type="",v.account="",v.isDefault=!1},Ne=l=>{x.value.forEach(e=>{e.isDefault=e.id===l}),c.success("已设为默认支付方式")},xe=async l=>{try{await re.confirm("确定要解绑此支付方式吗？","提示",{confirmButtonText:"确定",cancelButtonText:"取消",type:"warning"});const e=x.value.findIndex(u=>u.id===l);e>-1&&(x.value.splice(e,1),c.success("解绑成功"))}catch{}},Ce=()=>{N.push("/member/balance-recharge")},Me=()=>{N.back()},ze=l=>{l==="manage"?oe():l==="bills"&&P()};return(l,e)=>{const u=p("el-divider"),r=p("el-radio"),w=p("el-icon"),C=p("el-radio-group"),d=p("el-button"),n=p("el-card"),k=p("el-tab-pane"),b=p("el-table-column"),M=p("el-tag"),le=p("el-table"),ne=p("el-pagination"),Q=p("el-empty"),Be=p("el-date-picker"),De=p("el-tabs"),X=p("el-option"),Ve=p("el-select"),Y=p("el-form-item"),Fe=p("el-input"),Ie=p("el-switch"),Pe=p("el-form"),Se=p("el-dialog"),ie=Ae("loading");return m(),W("div",Qe,[a(Ke,{text:"返回"}),e[44]||(e[44]=t("h2",{class:"page-title"},"支付管理",-1)),a(De,{modelValue:E.value,"onUpdate:modelValue":e[10]||(e[10]=s=>E.value=s),class:"payment-tabs",onTabChange:ze},{default:o(()=>[ae.value?(m(),h(k,{key:0,label:"支付方式",name:"method"},{default:o(()=>[a(n,{class:"payment-card"},{default:o(()=>[t("div",Xe,[e[19]||(e[19]=t("h2",{class:"section-title"},"订单信息",-1)),t("div",Ye,[e[16]||(e[16]=t("span",{class:"label"},"订单编号:",-1)),t("span",Ze,f(i.orderNo||"-"),1)]),t("div",et,[e[17]||(e[17]=t("span",{class:"label"},"商品名称:",-1)),t("span",tt,f(i.businessName||"-"),1)]),t("div",at,[e[18]||(e[18]=t("span",{class:"label"},"订单金额:",-1)),t("span",st,"¥"+f(i.amount||"0.00"),1)])]),a(u),t("div",ot,[e[23]||(e[23]=t("h2",{class:"section-title"},"选择支付方式",-1)),a(C,{modelValue:T.value,"onUpdate:modelValue":e[3]||(e[3]=s=>T.value=s),class:"method-group"},{default:o(()=>[t("div",{class:U(["method-item",{active:T.value==="wechat"}]),onClick:e[0]||(e[0]=s=>T.value="wechat")},[a(r,{value:"wechat",size:"large"},{default:o(()=>[...e[20]||(e[20]=[t("div",{class:"method-content"},[t("div",{class:"method-icon wechat"},[t("svg",{class:"icon","aria-hidden":"true"},[t("use",{"xlink:href":"#icon-wechat"})])]),t("div",{class:"method-info"},[t("h4",null,"微信支付"),t("p",null,"推荐使用微信扫码支付")])],-1)])]),_:1})],2),t("div",{class:U(["method-item",{active:T.value==="alipay"}]),onClick:e[1]||(e[1]=s=>T.value="alipay")},[a(r,{value:"alipay",size:"large"},{default:o(()=>[...e[21]||(e[21]=[t("div",{class:"method-content"},[t("div",{class:"method-icon alipay"},[t("svg",{class:"icon","aria-hidden":"true"},[t("use",{"xlink:href":"#icon-alipay"})])]),t("div",{class:"method-info"},[t("h4",null,"支付宝支付"),t("p",null,"支持支付宝扫码或跳转支付")])],-1)])]),_:1})],2),t("div",{class:U(["method-item",{active:T.value==="balance"}]),onClick:e[2]||(e[2]=s=>T.value="balance")},[a(r,{value:"balance",size:"large"},{default:o(()=>[t("div",lt,[t("div",nt,[a(w,{size:32},{default:o(()=>[a(V(ee))]),_:1})]),t("div",it,[e[22]||(e[22]=t("h4",null,"余额支付",-1)),t("p",null,"当前余额: ¥"+f(F.value),1)])])]),_:1})],2)]),_:1},8,["modelValue"])]),t("div",ut,[a(d,{size:"large",onClick:Me},{default:o(()=>[...e[24]||(e[24]=[g("取消",-1)])]),_:1}),a(d,{type:"primary",size:"large",loading:_.value,disabled:!T.value,onClick:be},{default:o(()=>[g(" 确认支付 ¥"+f(i.amount||"0.00"),1)]),_:1},8,["loading","disabled"])])]),_:1})]),_:1})):z("",!0),a(k,{label:"支付记录",name:"records"},{default:o(()=>[a(n,{class:"records-card"},{default:o(()=>[t("div",rt,[e[26]||(e[26]=t("h2",{class:"section-title"},"支付记录",-1)),a(d,{type:"primary",icon:V(je),onClick:O},{default:o(()=>[...e[25]||(e[25]=[g("刷新",-1)])]),_:1},8,["icon"])]),ue((m(),h(le,{data:H.value,style:{width:"100%"},stripe:""},{default:o(()=>[a(b,{prop:"orderNo",label:"订单号",width:"180"}),a(b,{label:"业务类型",width:"120"},{default:o(({row:s})=>[a(M,{type:s.businessType==="balance_recharge"?"warning":"primary"},{default:o(()=>[g(f(s.businessType==="balance_recharge"?"余额充值":"场地预订"),1)]),_:2},1032,["type"])]),_:1}),a(b,{prop:"businessName",label:"业务名称",width:"150"}),a(b,{prop:"amount",label:"支付金额",width:"120"},{default:o(({row:s})=>{var S;return[t("span",dt,"¥"+f((S=s.amount)==null?void 0:S.toFixed(2)),1)]}),_:1}),a(b,{prop:"payMethodName",label:"支付方式",width:"120"}),a(b,{prop:"payTime",label:"支付时间",width:"180"}),a(b,{prop:"status",label:"状态",width:"100"},{default:o(({row:s})=>[a(M,{type:ve(s.status,s.businessType)},{default:o(()=>[g(f(fe(s.status,s.businessType)),1)]),_:2},1032,["type"])]),_:1}),a(b,{label:"操作",width:"150"},{default:o(({row:s})=>[s.businessType!=="balance_recharge"?(m(),h(d,{key:0,link:"",type:"primary",onClick:S=>ye(s)},{default:o(()=>[...e[27]||(e[27]=[g(" 查看详情 ",-1)])]),_:1},8,["onClick"])):(m(),W("span",ct,"-"))]),_:1})]),_:1},8,["data"])),[[ie,$.value]]),J.value>0?(m(),h(ne,{key:0,"current-page":q.value,"onUpdate:currentPage":e[4]||(e[4]=s=>q.value=s),"page-size":R.value,"onUpdate:pageSize":e[5]||(e[5]=s=>R.value=s),total:J.value,"page-sizes":[10,20,50],layout:"total, sizes, prev, pager, next, jumper",onCurrentChange:O,onSizeChange:O,style:{"margin-top":"20px","justify-content":"center"}},null,8,["current-page","page-size","total"])):z("",!0),!$.value&&H.value.length===0?(m(),h(Q,{key:1,description:"暂无支付记录"})):z("",!0)]),_:1})]),_:1}),a(k,{label:"支付方式管理",name:"manage"},{default:o(()=>[a(n,{class:"manage-card"},{default:o(()=>[t("div",pt,[e[29]||(e[29]=t("h2",{class:"section-title"},"我的支付方式",-1)),a(d,{type:"primary",onClick:e[6]||(e[6]=s=>I.value=!0)},{default:o(()=>[...e[28]||(e[28]=[g("添加支付方式",-1)])]),_:1})]),t("div",mt,[t("div",yt,[t("div",vt,[t("div",ft,[a(w,{size:32,color:"#F56C6C"},{default:o(()=>[a(V(ee))]),_:1})]),t("div",bt,[e[30]||(e[30]=t("h4",null,"余额支付",-1)),t("p",null,"当前余额: ¥"+f(F.value),1)]),a(M,{type:"success"},{default:o(()=>[...e[31]||(e[31]=[g("已启用",-1)])]),_:1})]),t("div",gt,[a(d,{link:"",type:"primary",onClick:Ce},{default:o(()=>[...e[32]||(e[32]=[g("充值",-1)])]),_:1})])]),(m(!0),W(Le,null,Oe(x.value,s=>(m(),W("div",{class:"method-card",key:s.id},[t("div",_t,[t("div",{class:U(["method-icon-wrapper",s.type])},[s.type==="wechat"?(m(),h(w,{key:0,size:32,color:"#07C160"},{default:o(()=>[a(V(We))]),_:1})):s.type==="alipay"?(m(),h(w,{key:1,size:32,color:"#1677FF"},{default:o(()=>[a(V(ee))]),_:1})):(m(),h(w,{key:2,size:32,color:"#409EFF"},{default:o(()=>[a(V(Ge))]),_:1}))],2),t("div",ht,[t("h4",null,f(s.name),1),t("p",null,f(s.account),1)]),s.isDefault?(m(),h(M,{key:0,type:"success"},{default:o(()=>[...e[33]||(e[33]=[g("默认",-1)])]),_:1})):(m(),h(M,{key:1,type:"info"},{default:o(()=>[...e[34]||(e[34]=[g("备用",-1)])]),_:1}))]),t("div",kt,[s.isDefault?z("",!0):(m(),h(d,{key:0,link:"",type:"primary",onClick:S=>Ne(s.id)},{default:o(()=>[...e[35]||(e[35]=[g(" 设为默认 ",-1)])]),_:1},8,["onClick"])),a(d,{link:"",type:"danger",onClick:S=>xe(s.id)},{default:o(()=>[...e[36]||(e[36]=[g("解绑",-1)])]),_:1},8,["onClick"])])]))),128)),x.value.length===0?(m(),h(Q,{key:0,description:"暂无绑定的支付方式"})):z("",!0)])]),_:1})]),_:1}),a(k,{label:"账单管理",name:"bills"},{default:o(()=>[a(n,{class:"bills-card"},{default:o(()=>[t("div",Tt,[e[38]||(e[38]=t("h2",{class:"section-title"},"账单管理",-1)),t("div",wt,[a(Be,{modelValue:se.value,"onUpdate:modelValue":e[7]||(e[7]=s=>se.value=s),type:"daterange","range-separator":"至","start-placeholder":"开始日期","end-placeholder":"结束日期",onChange:P},null,8,["modelValue"]),a(d,{type:"primary",onClick:P},{default:o(()=>[...e[37]||(e[37]=[g("查询",-1)])]),_:1})])]),t("div",Nt,[t("div",xt,[e[39]||(e[39]=t("div",{class:"summary-label"},"总支出",-1)),t("div",Ct,"¥"+f(D.totalExpense.toFixed(2)),1)]),t("div",Mt,[e[40]||(e[40]=t("div",{class:"summary-label"},"总收入",-1)),t("div",zt,"¥"+f(D.totalIncome.toFixed(2)),1)]),t("div",Bt,[e[41]||(e[41]=t("div",{class:"summary-label"},"交易笔数",-1)),t("div",Dt,f(D.totalCount),1)])]),ue((m(),h(le,{data:B.value,style:{width:"100%","margin-top":"20px"},stripe:""},{default:o(()=>[a(b,{prop:"createTime",label:"交易时间",width:"180"}),a(b,{prop:"description",label:"交易说明","min-width":"200"}),a(b,{prop:"amount",label:"金额",width:"150"},{default:o(({row:s})=>[t("span",{class:U(["amount-text",s.type==="expense"?"expense":"income"])},f(s.type==="expense"?"-":"+")+"¥"+f(s.amount.toFixed(2)),3)]),_:1}),a(b,{prop:"balance",label:"余额",width:"150"},{default:o(({row:s})=>[t("span",Vt,"¥"+f(s.balance.toFixed(2)),1)]),_:1})]),_:1},8,["data"])),[[ie,A.value]]),K.value>0?(m(),h(ne,{key:0,"current-page":j.value,"onUpdate:currentPage":e[8]||(e[8]=s=>j.value=s),"page-size":L.value,"onUpdate:pageSize":e[9]||(e[9]=s=>L.value=s),total:K.value,"page-sizes":[10,20,50],layout:"total, sizes, prev, pager, next, jumper",onCurrentChange:P,onSizeChange:P,style:{"margin-top":"20px","justify-content":"center"}},null,8,["current-page","page-size","total"])):z("",!0),!A.value&&B.value.length===0?(m(),h(Q,{key:1,description:"暂无账单记录"})):z("",!0)]),_:1})]),_:1})]),_:1},8,["modelValue"]),a(Se,{modelValue:I.value,"onUpdate:modelValue":e[15]||(e[15]=s=>I.value=s),title:"添加支付方式",width:"500px"},{footer:o(()=>[a(d,{onClick:e[14]||(e[14]=s=>I.value=!1)},{default:o(()=>[...e[42]||(e[42]=[g("取消",-1)])]),_:1}),a(d,{type:"primary",onClick:we},{default:o(()=>[...e[43]||(e[43]=[g("确定",-1)])]),_:1})]),default:o(()=>[a(Pe,{model:v,"label-width":"100px"},{default:o(()=>[a(Y,{label:"支付方式"},{default:o(()=>[a(Ve,{modelValue:v.type,"onUpdate:modelValue":e[11]||(e[11]=s=>v.type=s),placeholder:"请选择支付方式"},{default:o(()=>[a(X,{label:"微信支付",value:"wechat"}),a(X,{label:"支付宝支付",value:"alipay"}),a(X,{label:"银行卡",value:"bankcard"})]),_:1},8,["modelValue"])]),_:1}),a(Y,{label:"账号信息"},{default:o(()=>[a(Fe,{modelValue:v.account,"onUpdate:modelValue":e[12]||(e[12]=s=>v.account=s),placeholder:"请输入账号"},null,8,["modelValue"])]),_:1}),a(Y,{label:"设为默认"},{default:o(()=>[a(Ie,{modelValue:v.isDefault,"onUpdate:modelValue":e[13]||(e[13]=s=>v.isDefault=s)},null,8,["modelValue"])]),_:1})]),_:1},8,["model"])]),_:1},8,["modelValue"])])}}},qt=Ue(Ft,[["__scopeId","data-v-1c9df319"]]);export{qt as default};
