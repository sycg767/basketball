import{_ as Se,r,k as Y,t as $e,S as be,d as h,b as t,e as s,a3 as Be,c as y,g as u,a as l,f,a4 as De,F as qe,x as Fe,E as c,m as Re,o as i,i as d,B as p,u as _,a1 as Ne,K as Ue,T as Ie,a7 as Le,z as H,s as I,a8 as Ee,R as Oe,h as Qe}from"./index-DU9PCbH8.js";import{g as je,c as He,p as se,a as Ke}from"./booking-K964GJ6h.js";const We={class:"booking-list-container"},Ae={class:"booking-list"},Ge={class:"booking-header"},Je={class:"order-info"},Xe={class:"order-no"},Ye={class:"order-time"},Ze={class:"booking-content"},et={class:"venue-info"},tt={class:"location"},at={class:"booking-details"},st={class:"detail-item"},lt={class:"detail-item"},nt={class:"detail-item"},ot={class:"price-info"},it={class:"price-value"},dt={class:"booking-actions"},ut={class:"payment-amount-section"},rt={class:"amount-value"},ct={class:"payment-methods-section"},pt={class:"method-check"},vt={class:"method-check"},mt={class:"method-icon balance-icon"},yt={class:"method-check"},ft={class:"method-icon onsite-icon"},_t={class:"method-check"},gt={key:0,class:"qr-code-container"},ht={class:"qr-code-header"},kt={class:"qr-code-content"},Ct=["src"],wt={key:1,class:"qr-code-placeholder"},Mt={class:"qr-code-status"},zt={key:0,class:"expire-time"},xt={class:"mock-scan-area"},Tt={class:"mock-scan-buttons"},Vt={key:1,class:"payment-status"},Pt={key:0,class:"status-paying"},St={key:1,class:"status-success"},$t={key:2,class:"status-failed"},bt={class:"dialog-footer"},Bt={__name:"List",setup(Dt){const le=Re(),L=r(!1),E=r(""),$=r([]),b=r(null),k=Y({page:1,pageSize:10,total:0}),C=r(!1),K=r(!1),w=r(null),o=Y({paymentMethod:1,paymentType:"wechat_native"}),x=r(!1),V=r(""),W=r(!1),T=r(null),M=r(null),v=r(""),ne=()=>o.paymentMethod===1,oe=()=>v.value&&v.value!=="",B=r(!1),O=r(!1),P=Y({cancelReason:""}),z=async()=>{L.value=!0;try{const a={page:k.page,pageSize:k.pageSize,status:E.value!==""?E.value:void 0},e=await je(a);$.value=e.data.records,k.total=e.data.total}catch(a){c.error(a.message||"获取预订列表失败")}finally{L.value=!1}},ie=()=>{k.page=1,z()},de=a=>({0:"warning",1:"success",2:"info",3:"success",4:"info",5:"danger"})[a]||"info",ue=a=>({0:"待支付",1:"已支付",2:"已取消",3:"已完成",4:"已退款",5:"超时取消"})[a]||"未知",A=a=>a?new Date(a)<=new Date:!1,re=a=>{if(!a)return"";const e=new Date,D=new Date(a)-e;if(D<=0)return"已过期";const q=Math.floor(D/6e4),F=Math.floor(D%6e4/1e3);return q>0?`${q}分${F}秒后过期`:`${F}秒后过期`},ce=()=>{b.value&&clearInterval(b.value),b.value=setInterval(()=>{$.value=[...$.value]},1e3)},pe=a=>{le.push(`/booking/detail/${a}`)},ve=a=>{if(A(a.expireTime)){c.error("订单已过期，无法支付");return}w.value=a,o.paymentMethod=1,o.paymentType="wechat_native",x.value=!1,V.value="",T.value=null,v.value="",C.value=!0},Q=a=>{x.value=!1,V.value="",T.value=null,v.value="",a==="wechat_native"?(o.paymentMethod=1,o.paymentType="wechat_native"):a==="alipay_page"?(o.paymentMethod=1,o.paymentType="alipay_page"):a==="balance"?(o.paymentMethod=2,o.paymentType=""):a==="onsite"&&(o.paymentMethod=4,o.paymentType="")},me=()=>{o.paymentMethod===1?G():Ce()},ye=a=>a?new Date(a).toLocaleString("zh-CN",{year:"numeric",month:"2-digit",day:"2-digit",hour:"2-digit",minute:"2-digit"}):"",fe=()=>{M.value&&clearInterval(M.value),v.value="paying",M.value=setInterval(async()=>{try{const a=await Ke(w.value.id);a.data.status===1?(v.value="success",clearInterval(M.value),C.value=!1,z(),c.success("支付成功！")):a.data.status===5&&(v.value="failed",clearInterval(M.value),c.error("支付超时，请重新尝试"))}catch{}},3e3)},G=async()=>{W.value=!0;try{const a=await se(w.value.id,{paymentMethod:o.paymentMethod,paymentType:o.paymentType});T.value=a.data,o.paymentMethod===1&&a.data.qrCodeUrl?(a.data.qrCodeUrl.startsWith("data:")?V.value=a.data.qrCodeUrl:V.value=`https://api.qrserver.com/v1/create-qr-code/?size=200x200&data=${a.data.paymentNo}`,x.value=!0,fe()):o.paymentMethod===2?(v.value="success",C.value=!1,z()):o.paymentMethod===4&&(c.success("现场支付订单已确认"),C.value=!1,z())}catch(a){c.error(a.message||"生成支付二维码失败"),x.value=!1}finally{W.value=!1}},_e=async()=>{await G()},ge=()=>{M.value&&clearInterval(M.value),C.value=!1,x.value=!1,v.value=""},he=async()=>{try{await fetch(`http://localhost:8080/api/mock/payment/scan-success/${T.value.paymentNo}`,{method:"POST"}),c.success("模拟支付成功！支付状态已更新")}catch(a){c.error("模拟支付失败: "+a.message)}},ke=async()=>{try{await fetch(`http://localhost:8080/api/mock/payment/scan-fail/${T.value.paymentNo}`,{method:"POST"}),c.success("模拟支付失败！支付状态已更新")}catch(a){c.error("模拟支付失败: "+a.message)}},Ce=async()=>{if(ne())await G();else{K.value=!0;try{await se(w.value.id,{paymentMethod:o.paymentMethod}),c.success("支付成功"),C.value=!1,z()}catch(a){c.error(a.message||"支付失败")}finally{K.value=!1}}},we=a=>{w.value=a,P.cancelReason="",B.value=!0},Me=async()=>{if(!P.cancelReason.trim()){c.warning("请输入取消原因");return}O.value=!0;try{await He(w.value.id,{cancelReason:P.cancelReason}),c.success("取消成功"),B.value=!1,z()}catch(a){c.error(a.message||"取消失败")}finally{O.value=!1}};return $e(()=>{z(),ce()}),be(()=>{M.value&&clearInterval(M.value),b.value&&clearInterval(b.value)}),(a,e)=>{const S=f("el-radio-button"),D=f("el-radio-group"),q=f("el-card"),F=f("el-empty"),J=f("el-tag"),j=f("el-divider"),m=f("el-icon"),g=f("el-button"),ze=f("el-pagination"),Z=f("el-dialog"),xe=f("el-input"),Te=f("el-form-item"),Ve=f("el-form"),Pe=De("loading");return i(),h("div",We,[e[43]||(e[43]=t("h2",{class:"page-title"},"我的预订",-1)),s(q,{class:"filter-card"},{default:l(()=>[s(D,{modelValue:E.value,"onUpdate:modelValue":e[0]||(e[0]=n=>E.value=n),onChange:ie},{default:l(()=>[s(S,{label:""},{default:l(()=>[...e[12]||(e[12]=[d("全部",-1)])]),_:1}),s(S,{label:0},{default:l(()=>[...e[13]||(e[13]=[d("待支付",-1)])]),_:1}),s(S,{label:1},{default:l(()=>[...e[14]||(e[14]=[d("已支付",-1)])]),_:1}),s(S,{label:2},{default:l(()=>[...e[15]||(e[15]=[d("已取消",-1)])]),_:1}),s(S,{label:3},{default:l(()=>[...e[16]||(e[16]=[d("已完成",-1)])]),_:1})]),_:1},8,["modelValue"])]),_:1}),Be((i(),h("div",Ae,[$.value.length===0?(i(),y(F,{key:0,description:"暂无预订记录"})):u("",!0),(i(!0),h(qe,null,Fe($.value,n=>(i(),y(q,{key:n.id,class:"booking-card"},{default:l(()=>{var R,N;return[t("div",Ge,[t("div",Je,[t("span",Xe,"订单号: "+p(n.bookingNo),1),s(J,{type:de(n.status),size:"small"},{default:l(()=>[d(p(ue(n.status)),1)]),_:2},1032,["type"]),n.status===0&&n.expireTime?(i(),y(J,{key:0,type:"danger",size:"small",effect:"dark"},{default:l(()=>[d(p(re(n.expireTime)),1)]),_:2},1024)):u("",!0)]),t("div",Ye,p(n.createTime),1)]),s(j),t("div",Ze,[t("div",et,[t("h3",null,p(n.venueName),1),t("p",tt,[s(m,null,{default:l(()=>[s(_(Ne))]),_:1}),d(" "+p(n.venueLocation),1)])]),t("div",at,[t("div",st,[s(m,null,{default:l(()=>[s(_(Ue))]),_:1}),t("span",null,p(n.bookingDate),1)]),t("div",lt,[s(m,null,{default:l(()=>[s(_(Ie))]),_:1}),t("span",null,p(n.timeSlot),1)]),t("div",nt,[s(m,null,{default:l(()=>[s(_(Le))]),_:1}),t("span",null,p(n.duration)+"小时",1)])]),t("div",ot,[e[17]||(e[17]=t("div",{class:"price-label"},"实付金额",-1)),t("div",it,"¥"+p(((R=n.actualPrice)==null?void 0:R.toFixed(2))||((N=n.totalPrice)==null?void 0:N.toFixed(2))),1)])]),s(j),t("div",dt,[s(g,{type:"primary",link:"",onClick:U=>pe(n.id)},{default:l(()=>[...e[18]||(e[18]=[d(" 查看详情 ",-1)])]),_:1},8,["onClick"]),n.status===0&&!A(n.expireTime)?(i(),y(g,{key:0,type:"success",onClick:U=>ve(n)},{default:l(()=>[...e[19]||(e[19]=[d(" 立即支付 ",-1)])]),_:1},8,["onClick"])):u("",!0),n.status===0&&A(n.expireTime)?(i(),y(J,{key:1,type:"info",size:"large"},{default:l(()=>[...e[20]||(e[20]=[d(" 订单已过期 ",-1)])]),_:1})):u("",!0),n.status===0||n.status===1?(i(),y(g,{key:2,type:"danger",onClick:U=>we(n)},{default:l(()=>[...e[21]||(e[21]=[d(" 取消预订 ",-1)])]),_:1},8,["onClick"])):u("",!0)])]}),_:2},1024))),128))])),[[Pe,L.value]]),k.total>0?(i(),y(ze,{key:0,"current-page":k.page,"onUpdate:currentPage":e[1]||(e[1]=n=>k.page=n),"page-size":k.pageSize,"onUpdate:pageSize":e[2]||(e[2]=n=>k.pageSize=n),total:k.total,"page-sizes":[5,10,20],layout:"total, sizes, prev, pager, next, jumper",onSizeChange:z,onCurrentChange:z,class:"pagination"},null,8,["current-page","page-size","total"])):u("",!0),s(Z,{modelValue:C.value,"onUpdate:modelValue":e[8]||(e[8]=n=>C.value=n),title:"选择支付方式",width:"600px","close-on-click-modal":!1},{footer:l(()=>[t("div",bt,[s(g,{size:"large",onClick:e[7]||(e[7]=n=>C.value=!1)},{default:l(()=>[...e[38]||(e[38]=[d("取消",-1)])]),_:1}),x.value?u("",!0):(i(),y(g,{key:0,type:"primary",size:"large",onClick:me,loading:K.value,disabled:!o.paymentType&&o.paymentMethod!==2&&o.paymentMethod!==4},{default:l(()=>[...e[39]||(e[39]=[d(" 确认支付 ",-1)])]),_:1},8,["loading","disabled"])),x.value?(i(),y(g,{key:1,type:"danger",size:"large",onClick:ge,loading:O.value},{default:l(()=>[...e[40]||(e[40]=[d(" 取消支付 ",-1)])]),_:1},8,["loading"])):u("",!0)])]),default:l(()=>{var n,R,N,U,ee,te,ae;return[t("div",ut,[e[22]||(e[22]=t("div",{class:"amount-label"},"订单金额",-1)),t("div",rt,"¥"+p(((R=(n=w.value)==null?void 0:n.actualPrice)==null?void 0:R.toFixed(2))||((U=(N=w.value)==null?void 0:N.totalPrice)==null?void 0:U.toFixed(2))),1)]),s(j),t("div",ct,[e[29]||(e[29]=t("div",{class:"section-title"},"请选择支付方式",-1)),t("div",{class:H(["payment-method-card",{active:o.paymentType==="wechat_native"}]),onClick:e[3]||(e[3]=X=>Q("wechat_native"))},[e[23]||(e[23]=t("div",{class:"method-icon wechat-icon"},[t("svg",{viewBox:"0 0 1024 1024",width:"32",height:"32"},[t("path",{d:"M664.250054 368.541681c10.015098 0 19.892049 0.732687 29.67281 1.795902-26.647917-122.810047-159.358451-214.077703-310.826188-214.077703-169.353083 0-308.085774 114.232694-308.085774 259.274068 0 83.708494 46.165436 152.460344 123.281791 205.78483l-30.80868 91.730191 107.688651-53.455469c38.558178 7.53665 69.459978 15.308661 107.924012 15.308661 9.66308 0 19.230993-0.470721 28.752858-1.225921-6.025227-20.36584-9.521864-41.723264-9.521864-63.862493C402.328693 476.632491 517.908058 368.541681 664.250054 368.541681zM498.62897 285.87389c23.200398 0 38.557154 15.120372 38.557154 38.061874 0 22.846334-15.356756 38.156018-38.557154 38.156018-23.107277 0-46.260603-15.309684-46.260603-38.156018C452.368366 300.994262 475.522716 285.87389 498.62897 285.87389zM283.016307 362.090758c-23.107277 0-46.402843-15.309684-46.402843-38.156018 0-22.941502 23.295566-38.061874 46.402843-38.061874 23.081695 0 38.46301 15.120372 38.46301 38.061874C321.479317 346.782098 306.098002 362.090758 283.016307 362.090758zM945.448458 606.151333c0-121.888048-123.258255-221.236753-261.683954-221.236753-146.57838 0-262.015505 99.348706-262.015505 221.236753 0 122.06508 115.437126 221.200938 262.015505 221.200938 30.66644 0 61.617359-7.609305 92.423993-15.262612l84.513836 45.786813-23.178909-76.17082C899.379213 735.776599 945.448458 674.90216 945.448458 606.151333zM598.803483 567.994292c-15.332197 0-30.807656-15.096836-30.807656-30.501688 0-15.190981 15.47546-30.477129 30.807656-30.477129 23.295566 0 38.558178 15.286148 38.558178 30.477129C637.361661 552.897456 622.099049 567.994292 598.803483 567.994292zM768.25071 567.994292c-15.213493 0-30.594809-15.096836-30.594809-30.501688 0-15.190981 15.381315-30.477129 30.594809-30.477129 23.107277 0 38.558178 15.286148 38.558178 30.477129C806.808888 552.897456 791.357987 567.994292 768.25071 567.994292z",fill:"#00C800"})])],-1)),e[24]||(e[24]=t("div",{class:"method-info"},[t("div",{class:"method-name"},"微信支付"),t("div",{class:"method-desc"},"推荐使用微信扫码支付")],-1)),t("div",pt,[o.paymentType==="wechat_native"?(i(),y(m,{key:0,color:"#07C160",size:24},{default:l(()=>[s(_(I))]),_:1})):u("",!0)])],2),t("div",{class:H(["payment-method-card",{active:o.paymentType==="alipay_page"}]),onClick:e[4]||(e[4]=X=>Q("alipay_page"))},[e[25]||(e[25]=t("div",{class:"method-icon alipay-icon"},[t("svg",{viewBox:"0 0 1024 1024",width:"32",height:"32"},[t("path",{d:"M1024 701.9v162.8c0 88.5-71.7 160.2-160.2 160.2H160.2C71.7 1024.9 0 953.2 0 864.7V159.9C0 71.4 71.7-0.3 160.2-0.3h703.6c88.5 0 160.2 71.7 160.2 160.2v390.8c-51.8-23.8-155.9-67.8-289.8-67.8-228.9 0-378.1 112.1-430.5 210.5l-0.5 0.9 490.4 199.3c47.6-63.3 118.8-127.1 230.4-151.6z m-514.4-68.9c-0.3 0-0.5 0-0.8 0.1-0.3 0-0.5 0.1-0.8 0.1-44.2 8.2-89.3 22.6-134.4 42.8-9.5 4.3-19 8.9-28.4 13.8-52.2-88.7-152.9-148.3-267.3-148.3-15.7 0-31.1 1.2-46.2 3.4V232.3h585.6v401.6c-35.6-0.3-71.7 0-107.7 0.1z m-278.8-236c-51.7 0-93.6 41.9-93.6 93.6s41.9 93.6 93.6 93.6 93.6-41.9 93.6-93.6-41.9-93.6-93.6-93.6z",fill:"#1296DB"})])],-1)),e[26]||(e[26]=t("div",{class:"method-info"},[t("div",{class:"method-name"},"支付宝支付"),t("div",{class:"method-desc"},"支持支付宝扫码或跳转支付")],-1)),t("div",vt,[o.paymentType==="alipay_page"?(i(),y(m,{key:0,color:"#1677FF",size:24},{default:l(()=>[s(_(I))]),_:1})):u("",!0)])],2),t("div",{class:H(["payment-method-card",{active:o.paymentMethod===2}]),onClick:e[5]||(e[5]=X=>Q("balance"))},[t("div",mt,[s(m,{size:32},{default:l(()=>[s(_(Ee))]),_:1})]),e[27]||(e[27]=t("div",{class:"method-info"},[t("div",{class:"method-name"},"余额支付"),t("div",{class:"method-desc"},"当前余额: ¥0.00")],-1)),t("div",yt,[o.paymentMethod===2?(i(),y(m,{key:0,color:"#F56C6C",size:24},{default:l(()=>[s(_(I))]),_:1})):u("",!0)])],2),t("div",{class:H(["payment-method-card",{active:o.paymentMethod===4}]),onClick:e[6]||(e[6]=X=>Q("onsite"))},[t("div",ft,[s(m,{size:32},{default:l(()=>[s(_(Oe))]),_:1})]),e[28]||(e[28]=t("div",{class:"method-info"},[t("div",{class:"method-name"},"现场支付"),t("div",{class:"method-desc"},"到场后现金或刷卡支付")],-1)),t("div",_t,[o.paymentMethod===4?(i(),y(m,{key:0,color:"#909399",size:24},{default:l(()=>[s(_(I))]),_:1})):u("",!0)])],2)]),x.value?(i(),h("div",gt,[t("div",ht,[t("span",null,"请使用"+p(o.paymentType==="wechat_native"?"微信":"支付宝")+"扫码支付",1),s(g,{type:"text",onClick:_e,loading:W.value},{default:l(()=>[...e[30]||(e[30]=[d(" 刷新二维码 ",-1)])]),_:1},8,["loading"])]),t("div",kt,[V.value?(i(),h("img",{key:0,src:V.value,alt:"支付二维码",class:"qr-code-img"},null,8,Ct)):(i(),h("div",wt,[s(F,{description:"生成二维码中..."})]))]),t("div",Mt,[t("p",null,"支付单号: "+p((ee=T.value)==null?void 0:ee.paymentNo),1),t("p",null,"订单号: "+p((te=w.value)==null?void 0:te.bookingNo),1),(ae=T.value)!=null&&ae.expireTime?(i(),h("p",zt," 二维码有效期至: "+p(ye(T.value.expireTime)),1)):u("",!0)]),t("div",xt,[s(j,null,{default:l(()=>[...e[31]||(e[31]=[d("开发环境模拟功能",-1)])]),_:1}),t("div",Tt,[s(g,{type:"success",onClick:he,disabled:v.value==="success"},{default:l(()=>[...e[32]||(e[32]=[d(" 模拟扫码支付成功 ",-1)])]),_:1},8,["disabled"]),s(g,{type:"danger",onClick:ke,disabled:v.value==="failed"},{default:l(()=>[...e[33]||(e[33]=[d(" 模拟扫码支付失败 ",-1)])]),_:1},8,["disabled"])]),e[34]||(e[34]=t("p",{class:"mock-tip"},"点击按钮模拟用户扫码支付结果",-1))])])):u("",!0),oe?(i(),h("div",Vt,[v.value==="paying"?(i(),h("div",Pt,[s(m,{class:"status-icon is-loading"},{default:l(()=>[s(_(L))]),_:1}),e[35]||(e[35]=t("span",null,"等待支付完成...",-1))])):v.value==="success"?(i(),h("div",St,[s(m,{class:"status-icon"},{default:l(()=>[s(_(I))]),_:1}),e[36]||(e[36]=t("span",null,"支付成功！",-1))])):v.value==="failed"?(i(),h("div",$t,[s(m,{class:"status-icon"},{default:l(()=>[s(_(Qe))]),_:1}),e[37]||(e[37]=t("span",null,"支付失败，请重试",-1))])):u("",!0)])):u("",!0)]}),_:1},8,["modelValue"]),s(Z,{modelValue:B.value,"onUpdate:modelValue":e[11]||(e[11]=n=>B.value=n),title:"取消预订",width:"400px"},{footer:l(()=>[s(g,{onClick:e[10]||(e[10]=n=>B.value=!1)},{default:l(()=>[...e[41]||(e[41]=[d("取消",-1)])]),_:1}),s(g,{type:"danger",onClick:Me,loading:O.value},{default:l(()=>[...e[42]||(e[42]=[d("确认取消",-1)])]),_:1},8,["loading"])]),default:l(()=>[s(Ve,{model:P,"label-width":"100px"},{default:l(()=>[s(Te,{label:"取消原因",required:""},{default:l(()=>[s(xe,{modelValue:P.cancelReason,"onUpdate:modelValue":e[9]||(e[9]=n=>P.cancelReason=n),type:"textarea",rows:4,placeholder:"请输入取消原因"},null,8,["modelValue"])]),_:1})]),_:1},8,["model"])]),_:1},8,["modelValue"])])}}},Rt=Se(Bt,[["__scopeId","data-v-769e018d"]]);export{Rt as default};
