import{_ as Ce,r as f,j as X,n as Me,X as we,d as b,e as l,Q as xe,a,f as _,R as Te,b as t,c as m,g as r,U as ze,E as y,k as Pe,o as d,x as Ve,y as u,i,v as U,u as M,s as z,Y as Ne,Z as Re,h as Q,A as De,V as Y}from"./index-DfALJeeI.js";import{a as Z,c as Fe,p as G}from"./booking-AgLH9Eox.js";import"./request-CZtBzr0V.js";const qe={class:"booking-detail-container"},Be={class:"detail-content"},Se={class:"status-content"},Ue={class:"status-info"},$e={class:"order-no"},Ie={class:"price-highlight"},Ae={class:"action-buttons"},Ee={class:"payment-amount-section"},Qe={class:"amount-value"},Oe={class:"payment-methods-section"},Le={class:"method-check"},je={class:"method-check"},He={class:"method-icon balance-icon"},We={class:"method-check"},Xe={class:"method-icon onsite-icon"},Ye={class:"method-check"},Ze={key:0,class:"qr-code-container"},Ge={class:"qr-code-header"},Je={class:"qr-code-content"},Ke=["src"],ea={key:1,class:"qr-code-placeholder"},aa={class:"qr-code-status"},ta={key:0,class:"expire-time"},la={class:"mock-scan-area"},sa={class:"mock-scan-buttons"},oa={key:1,class:"payment-status"},na={key:0,class:"status-paying"},ia={key:1,class:"status-success"},da={key:2,class:"status-failed"},ua={class:"dialog-footer"},ca={__name:"Detail",setup(ra){const J=ze(),O=Pe(),F=f(!1),s=f({}),g=f(!1),$=f(!1),n=X({paymentMethod:2,paymentType:"wechat_native"}),w=f(!1),P=f(""),I=f(!1),x=f(null),C=f(null),p=f(""),K=()=>n.paymentMethod===1,ee=()=>p.value&&p.value!=="",N=f(!1),q=f(!1),V=X({cancelReason:""}),T=async()=>{F.value=!0;try{const o=await Z(J.params.id);s.value=o.data}catch(o){y.error(o.message||"获取预订详情失败"),O.back()}finally{F.value=!1}},ae=()=>{O.back()},te=o=>({0:Y,1:z,2:Q,3:z,4:Q,5:De})[o]||Y,le=o=>({0:"#E6A23C",1:"#67C23A",2:"#909399",3:"#67C23A",4:"#909399",5:"#F56C6C"})[o]||"#909399",se=o=>({0:"待支付",1:"已支付",2:"已取消",3:"已完成",4:"已退款",5:"超时取消"})[o]||"未知",oe=()=>{n.paymentMethod=1,n.paymentType="wechat_native",w.value=!1,P.value="",x.value=null,p.value="",g.value=!0},B=o=>{w.value=!1,P.value="",x.value=null,p.value="",o==="wechat_native"?(n.paymentMethod=1,n.paymentType="wechat_native"):o==="alipay_page"?(n.paymentMethod=1,n.paymentType="alipay_page"):o==="balance"?(n.paymentMethod=2,n.paymentType=""):o==="onsite"&&(n.paymentMethod=4,n.paymentType="")},ne=()=>{n.paymentMethod===1?A():me()},ie=o=>o?new Date(o).toLocaleString("zh-CN",{year:"numeric",month:"2-digit",day:"2-digit",hour:"2-digit",minute:"2-digit"}):"",de=()=>{C.value&&clearInterval(C.value),p.value="paying",C.value=setInterval(async()=>{try{const o=await Z(s.value.id);o.data.status===1?(p.value="success",clearInterval(C.value),g.value=!1,T(),y.success("支付成功！")):o.data.status===5&&(p.value="failed",clearInterval(C.value),y.error("支付超时，请重新尝试"))}catch{}},3e3)},A=async()=>{I.value=!0;try{const o=await G(s.value.id,{paymentMethod:n.paymentMethod,paymentType:n.paymentType});x.value=o.data,n.paymentMethod===1&&o.data.qrCodeUrl?(o.data.qrCodeUrl.startsWith("data:")?P.value=o.data.qrCodeUrl:P.value=`https://api.qrserver.com/v1/create-qr-code/?size=200x200&data=${o.data.paymentNo}`,w.value=!0,de()):n.paymentMethod===2||n.paymentMethod===3?(p.value="success",g.value=!1,T()):n.paymentMethod===4&&(y.success("现场支付订单已确认"),g.value=!1,T())}catch(o){y.error(o.message||"生成支付二维码失败"),w.value=!1}finally{I.value=!1}},ue=async()=>{await A()},ce=()=>{C.value&&clearInterval(C.value),g.value=!1,w.value=!1,p.value=""},re=async()=>{try{await fetch(`http://localhost:8080/api/mock/payment/scan-success/${x.value.paymentNo}`,{method:"POST"}),y.success("模拟支付成功！支付状态已更新")}catch(o){y.error("模拟支付失败: "+o.message)}},ve=async()=>{try{await fetch(`http://localhost:8080/api/mock/payment/scan-fail/${x.value.paymentNo}`,{method:"POST"}),y.success("模拟支付失败！支付状态已更新")}catch(o){y.error("模拟支付失败: "+o.message)}},me=async()=>{if(K())await A();else{$.value=!0;try{await G(s.value.id,{paymentMethod:n.paymentMethod}),y.success("支付成功"),g.value=!1,T()}catch(o){y.error(o.message||"支付失败")}finally{$.value=!1}}},pe=()=>{V.cancelReason="",N.value=!0},ye=async()=>{if(!V.cancelReason.trim()){y.warning("请输入取消原因");return}q.value=!0;try{await Fe(s.value.id,{cancelReason:V.cancelReason}),y.success("取消成功"),N.value=!1,T()}catch(o){y.error(o.message||"取消失败")}finally{q.value=!1}};return Me(()=>{T()}),we(()=>{C.value&&clearInterval(C.value)}),(o,e)=>{const fe=_("el-page-header"),h=_("el-icon"),R=_("el-card"),v=_("el-descriptions-item"),S=_("el-descriptions"),k=_("el-button"),L=_("el-divider"),_e=_("el-empty"),j=_("el-dialog"),ge=_("el-input"),he=_("el-form-item"),ke=_("el-form"),be=Te("loading");return d(),b("div",qe,[l(fe,{onBack:ae,title:"返回"},{content:a(()=>[...e[9]||(e[9]=[t("span",{class:"page-title"},"预订详情",-1)])]),_:1}),xe((d(),b("div",Be,[l(R,{class:"status-card"},{default:a(()=>[t("div",Se,[l(h,{size:48,color:le(s.value.status)},{default:a(()=>[(d(),m(Ve(te(s.value.status))))]),_:1},8,["color"]),t("div",Ue,[t("h2",null,u(se(s.value.status)),1),t("p",$e,"订单号: "+u(s.value.bookingNo),1)])])]),_:1}),l(R,{class:"info-card"},{header:a(()=>[...e[10]||(e[10]=[t("div",{class:"card-header"},[t("span",null,"场地信息")],-1)])]),default:a(()=>[l(S,{column:2,border:""},{default:a(()=>[l(v,{label:"场地名称"},{default:a(()=>[i(u(s.value.venueName),1)]),_:1}),l(v,{label:"场地位置"},{default:a(()=>[i(u(s.value.venueLocation),1)]),_:1})]),_:1})]),_:1}),l(R,{class:"info-card"},{header:a(()=>[...e[11]||(e[11]=[t("div",{class:"card-header"},[t("span",null,"预订信息")],-1)])]),default:a(()=>[l(S,{column:2,border:""},{default:a(()=>[l(v,{label:"预订日期"},{default:a(()=>[i(u(s.value.bookingDate),1)]),_:1}),l(v,{label:"时间段"},{default:a(()=>[i(u(s.value.timeSlot),1)]),_:1}),l(v,{label:"时长"},{default:a(()=>[i(u(s.value.duration)+" 小时 ",1)]),_:1}),l(v,{label:"预订类型"},{default:a(()=>[i(u(s.value.bookingType===1?"按时段":"包场"),1)]),_:1}),s.value.contactName?(d(),m(v,{key:0,label:"联系人"},{default:a(()=>[i(u(s.value.contactName),1)]),_:1})):r("",!0),s.value.contactPhone?(d(),m(v,{key:1,label:"联系电话"},{default:a(()=>[i(u(s.value.contactPhone),1)]),_:1})):r("",!0),s.value.peopleCount?(d(),m(v,{key:2,label:"人数"},{default:a(()=>[i(u(s.value.peopleCount)+" 人 ",1)]),_:1})):r("",!0),s.value.remark?(d(),m(v,{key:3,label:"备注",span:2},{default:a(()=>[i(u(s.value.remark),1)]),_:1})):r("",!0)]),_:1})]),_:1}),l(R,{class:"info-card"},{header:a(()=>[...e[12]||(e[12]=[t("div",{class:"card-header"},[t("span",null,"费用信息")],-1)])]),default:a(()=>[l(S,{column:2,border:""},{default:a(()=>[l(v,{label:"单价"},{default:a(()=>{var c;return[i(" ¥"+u((c=s.value.price)==null?void 0:c.toFixed(2))+"/小时 ",1)]}),_:1}),l(v,{label:"总价"},{default:a(()=>{var c;return[i(" ¥"+u((c=s.value.totalPrice)==null?void 0:c.toFixed(2)),1)]}),_:1}),l(v,{label:"优惠金额"},{default:a(()=>{var c;return[i(" ¥"+u(((c=s.value.discountAmount)==null?void 0:c.toFixed(2))||"0.00"),1)]}),_:1}),l(v,{label:"实付金额"},{default:a(()=>{var c,D;return[t("span",Ie,"¥"+u(((c=s.value.actualPrice)==null?void 0:c.toFixed(2))||((D=s.value.totalPrice)==null?void 0:D.toFixed(2))),1)]}),_:1}),s.value.payMethodName?(d(),m(v,{key:0,label:"支付方式"},{default:a(()=>[i(u(s.value.payMethodName),1)]),_:1})):r("",!0)]),_:1})]),_:1}),l(R,{class:"info-card"},{header:a(()=>[...e[13]||(e[13]=[t("div",{class:"card-header"},[t("span",null,"时间信息")],-1)])]),default:a(()=>[l(S,{column:2,border:""},{default:a(()=>[l(v,{label:"创建时间"},{default:a(()=>[i(u(s.value.createTime),1)]),_:1}),s.value.payTime?(d(),m(v,{key:0,label:"支付时间"},{default:a(()=>[i(u(s.value.payTime),1)]),_:1})):r("",!0),s.value.cancelTime?(d(),m(v,{key:1,label:"取消时间"},{default:a(()=>[i(u(s.value.cancelTime),1)]),_:1})):r("",!0),s.value.cancelReason?(d(),m(v,{key:2,label:"取消原因",span:2},{default:a(()=>[i(u(s.value.cancelReason),1)]),_:1})):r("",!0),s.value.expireTime&&s.value.status===0?(d(),m(v,{key:3,label:"过期时间"},{default:a(()=>[i(u(s.value.expireTime),1)]),_:1})):r("",!0)]),_:1})]),_:1}),t("div",Ae,[s.value.status===0?(d(),m(k,{key:0,type:"success",size:"large",onClick:oe},{default:a(()=>[...e[14]||(e[14]=[i(" 立即支付 ",-1)])]),_:1})):r("",!0),s.value.status===0||s.value.status===1?(d(),m(k,{key:1,type:"danger",size:"large",onClick:pe},{default:a(()=>[...e[15]||(e[15]=[i(" 取消预订 ",-1)])]),_:1})):r("",!0)])])),[[be,F.value]]),l(j,{modelValue:g.value,"onUpdate:modelValue":e[5]||(e[5]=c=>g.value=c),title:"选择支付方式",width:"600px","close-on-click-modal":!1},{footer:a(()=>[t("div",ua,[l(k,{size:"large",onClick:e[4]||(e[4]=c=>g.value=!1)},{default:a(()=>[...e[32]||(e[32]=[i("取消",-1)])]),_:1}),w.value?r("",!0):(d(),m(k,{key:0,type:"primary",size:"large",onClick:ne,loading:$.value,disabled:!n.paymentType&&n.paymentMethod!==2&&n.paymentMethod!==4},{default:a(()=>[...e[33]||(e[33]=[i(" 确认支付 ",-1)])]),_:1},8,["loading","disabled"])),w.value?(d(),m(k,{key:1,type:"danger",size:"large",onClick:ce,loading:q.value},{default:a(()=>[...e[34]||(e[34]=[i(" 取消支付 ",-1)])]),_:1},8,["loading"])):r("",!0)])]),default:a(()=>{var c,D,H,W;return[t("div",Ee,[e[16]||(e[16]=t("div",{class:"amount-label"},"订单金额",-1)),t("div",Qe,"¥"+u(((c=s.value.actualPrice)==null?void 0:c.toFixed(2))||((D=s.value.totalPrice)==null?void 0:D.toFixed(2))),1)]),l(L),t("div",Oe,[e[23]||(e[23]=t("div",{class:"section-title"},"请选择支付方式",-1)),t("div",{class:U(["payment-method-card",{active:n.paymentType==="wechat_native"}]),onClick:e[0]||(e[0]=E=>B("wechat_native"))},[e[17]||(e[17]=t("div",{class:"method-icon wechat-icon"},[t("svg",{viewBox:"0 0 1024 1024",width:"32",height:"32"},[t("path",{d:"M664.250054 368.541681c10.015098 0 19.892049 0.732687 29.67281 1.795902-26.647917-122.810047-159.358451-214.077703-310.826188-214.077703-169.353083 0-308.085774 114.232694-308.085774 259.274068 0 83.708494 46.165436 152.460344 123.281791 205.78483l-30.80868 91.730191 107.688651-53.455469c38.558178 7.53665 69.459978 15.308661 107.924012 15.308661 9.66308 0 19.230993-0.470721 28.752858-1.225921-6.025227-20.36584-9.521864-41.723264-9.521864-63.862493C402.328693 476.632491 517.908058 368.541681 664.250054 368.541681zM498.62897 285.87389c23.200398 0 38.557154 15.120372 38.557154 38.061874 0 22.846334-15.356756 38.156018-38.557154 38.156018-23.107277 0-46.260603-15.309684-46.260603-38.156018C452.368366 300.994262 475.522716 285.87389 498.62897 285.87389zM283.016307 362.090758c-23.107277 0-46.402843-15.309684-46.402843-38.156018 0-22.941502 23.295566-38.061874 46.402843-38.061874 23.081695 0 38.46301 15.120372 38.46301 38.061874C321.479317 346.782098 306.098002 362.090758 283.016307 362.090758zM945.448458 606.151333c0-121.888048-123.258255-221.236753-261.683954-221.236753-146.57838 0-262.015505 99.348706-262.015505 221.236753 0 122.06508 115.437126 221.200938 262.015505 221.200938 30.66644 0 61.617359-7.609305 92.423993-15.262612l84.513836 45.786813-23.178909-76.17082C899.379213 735.776599 945.448458 674.90216 945.448458 606.151333zM598.803483 567.994292c-15.332197 0-30.807656-15.096836-30.807656-30.501688 0-15.190981 15.47546-30.477129 30.807656-30.477129 23.295566 0 38.558178 15.286148 38.558178 30.477129C637.361661 552.897456 622.099049 567.994292 598.803483 567.994292zM768.25071 567.994292c-15.213493 0-30.594809-15.096836-30.594809-30.501688 0-15.190981 15.381315-30.477129 30.594809-30.477129 23.107277 0 38.558178 15.286148 38.558178 30.477129C806.808888 552.897456 791.357987 567.994292 768.25071 567.994292z",fill:"#00C800"})])],-1)),e[18]||(e[18]=t("div",{class:"method-info"},[t("div",{class:"method-name"},"微信支付"),t("div",{class:"method-desc"},"推荐使用微信扫码支付")],-1)),t("div",Le,[n.paymentType==="wechat_native"?(d(),m(h,{key:0,color:"#07C160",size:24},{default:a(()=>[l(M(z))]),_:1})):r("",!0)])],2),t("div",{class:U(["payment-method-card",{active:n.paymentType==="alipay_page"}]),onClick:e[1]||(e[1]=E=>B("alipay_page"))},[e[19]||(e[19]=t("div",{class:"method-icon alipay-icon"},[t("svg",{viewBox:"0 0 1024 1024",width:"32",height:"32"},[t("path",{d:"M1024 701.9v162.8c0 88.5-71.7 160.2-160.2 160.2H160.2C71.7 1024.9 0 953.2 0 864.7V159.9C0 71.4 71.7-0.3 160.2-0.3h703.6c88.5 0 160.2 71.7 160.2 160.2v390.8c-51.8-23.8-155.9-67.8-289.8-67.8-228.9 0-378.1 112.1-430.5 210.5l-0.5 0.9 490.4 199.3c47.6-63.3 118.8-127.1 230.4-151.6z m-514.4-68.9c-0.3 0-0.5 0-0.8 0.1-0.3 0-0.5 0.1-0.8 0.1-44.2 8.2-89.3 22.6-134.4 42.8-9.5 4.3-19 8.9-28.4 13.8-52.2-88.7-152.9-148.3-267.3-148.3-15.7 0-31.1 1.2-46.2 3.4V232.3h585.6v401.6c-35.6-0.3-71.7 0-107.7 0.1z m-278.8-236c-51.7 0-93.6 41.9-93.6 93.6s41.9 93.6 93.6 93.6 93.6-41.9 93.6-93.6-41.9-93.6-93.6-93.6z",fill:"#1296DB"})])],-1)),e[20]||(e[20]=t("div",{class:"method-info"},[t("div",{class:"method-name"},"支付宝支付"),t("div",{class:"method-desc"},"支持支付宝扫码或跳转支付")],-1)),t("div",je,[n.paymentType==="alipay_page"?(d(),m(h,{key:0,color:"#1677FF",size:24},{default:a(()=>[l(M(z))]),_:1})):r("",!0)])],2),t("div",{class:U(["payment-method-card",{active:n.paymentMethod===2}]),onClick:e[2]||(e[2]=E=>B("balance"))},[t("div",He,[l(h,{size:32},{default:a(()=>[l(M(Ne))]),_:1})]),e[21]||(e[21]=t("div",{class:"method-info"},[t("div",{class:"method-name"},"余额支付"),t("div",{class:"method-desc"},"当前余额: ¥0.00")],-1)),t("div",We,[n.paymentMethod===2?(d(),m(h,{key:0,color:"#F56C6C",size:24},{default:a(()=>[l(M(z))]),_:1})):r("",!0)])],2),t("div",{class:U(["payment-method-card",{active:n.paymentMethod===4}]),onClick:e[3]||(e[3]=E=>B("onsite"))},[t("div",Xe,[l(h,{size:32},{default:a(()=>[l(M(Re))]),_:1})]),e[22]||(e[22]=t("div",{class:"method-info"},[t("div",{class:"method-name"},"现场支付"),t("div",{class:"method-desc"},"到场后现金或刷卡支付")],-1)),t("div",Ye,[n.paymentMethod===4?(d(),m(h,{key:0,color:"#909399",size:24},{default:a(()=>[l(M(z))]),_:1})):r("",!0)])],2)]),w.value?(d(),b("div",Ze,[t("div",Ge,[t("span",null,"请使用"+u(n.paymentType==="wechat_native"?"微信":"支付宝")+"扫码支付",1),l(k,{type:"text",onClick:ue,loading:I.value},{default:a(()=>[...e[24]||(e[24]=[i(" 刷新二维码 ",-1)])]),_:1},8,["loading"])]),t("div",Je,[P.value?(d(),b("img",{key:0,src:P.value,alt:"支付二维码",class:"qr-code-img"},null,8,Ke)):(d(),b("div",ea,[l(_e,{description:"生成二维码中..."})]))]),t("div",aa,[t("p",null,"支付单号: "+u((H=x.value)==null?void 0:H.paymentNo),1),t("p",null,"订单号: "+u(s.value.bookingNo),1),(W=x.value)!=null&&W.expireTime?(d(),b("p",ta," 二维码有效期至: "+u(ie(x.value.expireTime)),1)):r("",!0)]),t("div",la,[l(L,null,{default:a(()=>[...e[25]||(e[25]=[i("开发环境模拟功能",-1)])]),_:1}),t("div",sa,[l(k,{type:"success",onClick:re,disabled:p.value==="success"},{default:a(()=>[...e[26]||(e[26]=[i(" 模拟扫码支付成功 ",-1)])]),_:1},8,["disabled"]),l(k,{type:"danger",onClick:ve,disabled:p.value==="failed"},{default:a(()=>[...e[27]||(e[27]=[i(" 模拟扫码支付失败 ",-1)])]),_:1},8,["disabled"])]),e[28]||(e[28]=t("p",{class:"mock-tip"},"点击按钮模拟用户扫码支付结果",-1))])])):r("",!0),ee?(d(),b("div",oa,[p.value==="paying"?(d(),b("div",na,[l(h,{class:"status-icon is-loading"},{default:a(()=>[l(M(F))]),_:1}),e[29]||(e[29]=t("span",null,"等待支付完成...",-1))])):p.value==="success"?(d(),b("div",ia,[l(h,{class:"status-icon"},{default:a(()=>[l(M(z))]),_:1}),e[30]||(e[30]=t("span",null,"支付成功！",-1))])):p.value==="failed"?(d(),b("div",da,[l(h,{class:"status-icon"},{default:a(()=>[l(M(Q))]),_:1}),e[31]||(e[31]=t("span",null,"支付失败，请重试",-1))])):r("",!0)])):r("",!0)]}),_:1},8,["modelValue"]),l(j,{modelValue:N.value,"onUpdate:modelValue":e[8]||(e[8]=c=>N.value=c),title:"取消预订",width:"400px"},{footer:a(()=>[l(k,{onClick:e[7]||(e[7]=c=>N.value=!1)},{default:a(()=>[...e[35]||(e[35]=[i("取消",-1)])]),_:1}),l(k,{type:"danger",onClick:ye,loading:q.value},{default:a(()=>[...e[36]||(e[36]=[i("确认取消",-1)])]),_:1},8,["loading"])]),default:a(()=>[l(ke,{model:V,"label-width":"100px"},{default:a(()=>[l(he,{label:"取消原因",required:""},{default:a(()=>[l(ge,{modelValue:V.cancelReason,"onUpdate:modelValue":e[6]||(e[6]=c=>V.cancelReason=c),type:"textarea",rows:4,placeholder:"请输入取消原因"},null,8,["modelValue"])]),_:1})]),_:1},8,["model"])]),_:1},8,["modelValue"])])}}},ya=Ce(ca,[["__scopeId","data-v-fcc90e50"]]);export{ya as default};
