import{_ as Y,r as E,t as X,M as Z,c as k,a,b as o,e as s,g as w,f as y,i as p,d as h,u as N,l as ee,N as q,F as Q,L as W,E as A,m as j,o as c,O as te,P as oe,v,Q as V,R as P,s as G,S as ne,T as se,H as ae,U as ie,V as le,W as re}from"./index-BU1z93KZ.js";import{g as ce,m as de,a as ue,b as _e}from"./notification-SycZCjrS.js";import{r as K}from"./request-CITddpnx.js";const fe={class:"notification-trigger"},pe={class:"notification-popover"},ve={class:"notification-header"},me={class:"notification-list"},ye={key:0,class:"notification-loading"},Ce=["onClick"],ge={class:"notification-icon"},he={class:"notification-content"},Ee={class:"notification-title"},Re={class:"notification-body"},Se={class:"notification-time"},ke={key:0,class:"notification-badge"},we={class:"notification-footer"},Ne={__name:"NotificationCenter",setup(J){const $=j(),m=E([]),_=E(0),d=E(!1);let R=null;X(()=>{S(),B()}),Z(()=>{I()});const S=async()=>{try{const n=await ce();n.code===200&&(_.value=n.data||0)}catch(n){console.error("获取未读数量失败:",n),_.value=0}},T=async()=>{d.value=!0;try{const n=await _e({page:1,size:10});n.code===200&&(m.value=n.data.records||[])}catch(n){console.error("获取通知列表失败:",n),A.error("获取通知列表失败")}finally{d.value=!1}},M=()=>{T()},D=async n=>{if(n.isRead===0)try{await ue(n.id),n.isRead=1,_.value=Math.max(0,_.value-1)}catch(r){console.error("标记已读失败:",r)}$.push(`/notification/${n.id}`)},O=async()=>{try{await de(),m.value.forEach(n=>{n.isRead=1}),_.value=0,A.success("已全部标记为已读")}catch(n){console.error("全部已读失败:",n),A.error("操作失败")}},U=()=>{$.push("/notification/list")},L=n=>({BOOKING_SUCCESS:G,BOOKING_CANCEL:P,COURSE_ENROLL_SUCCESS:G,COURSE_ENROLL_CANCEL:P,PAYMENT_SUCCESS:G,REFUND_SUCCESS:V,MEMBER_CARD_EXPIRE_SOON:P,COURSE_START_REMINDER:V,BOOKING_START_REMINDER:V})[n]||ne,x=n=>({BOOKING_SUCCESS:"#67C23A",BOOKING_CANCEL:"#E6A23C",COURSE_ENROLL_SUCCESS:"#67C23A",COURSE_ENROLL_CANCEL:"#E6A23C",PAYMENT_SUCCESS:"#67C23A",REFUND_SUCCESS:"#409EFF",MEMBER_CARD_EXPIRE_SOON:"#E6A23C",COURSE_START_REMINDER:"#409EFF",BOOKING_START_REMINDER:"#409EFF"})[n]||"#909399",z=n=>{if(!n)return"";const r=new Date,C=new Date(n),t=r-C,e=60*1e3,u=60*e,i=24*u;if(t<e)return"刚刚";if(t<u)return`${Math.floor(t/e)}分钟前`;if(t<i)return`${Math.floor(t/u)}小时前`;if(t<7*i)return`${Math.floor(t/i)}天前`;{const g=C.getFullYear(),f=String(C.getMonth()+1).padStart(2,"0"),b=String(C.getDate()).padStart(2,"0");return`${g}-${f}-${b}`}},B=()=>{R=setInterval(()=>{S()},3e4)},I=()=>{R&&(clearInterval(R),R=null)};return(n,r)=>{const C=y("el-icon"),t=y("el-badge"),e=y("el-button"),u=y("el-divider"),i=y("el-empty"),g=y("el-popover");return c(),k(g,{placement:"bottom-end",width:380,trigger:"click",onShow:M},{reference:a(()=>[o("div",fe,[s(t,{value:_.value,hidden:_.value===0},{default:a(()=>[s(C,{size:24},{default:a(()=>[s(N(W))]),_:1})]),_:1},8,["value","hidden"])])]),default:a(()=>[o("div",pe,[o("div",ve,[r[1]||(r[1]=o("h4",null,"通知消息",-1)),m.value.length>0?(c(),k(e,{key:0,type:"text",size:"small",onClick:O},{default:a(()=>[...r[0]||(r[0]=[p(" 全部已读 ",-1)])]),_:1})):w("",!0)]),s(u,{style:{margin:"8px 0"}}),o("div",me,[d.value?(c(),h("div",ye,[s(C,{class:"is-loading"},{default:a(()=>[s(N(ee))]),_:1}),r[2]||(r[2]=o("p",null,"加载中...",-1))])):m.value.length===0?(c(),k(i,{key:1,description:"暂无通知","image-size":80})):(c(!0),h(Q,{key:2},q(m.value,f=>(c(),h("div",{key:f.id,class:te(["notification-item",{"is-unread":f.isRead===0}]),onClick:b=>D(f)},[o("div",ge,[s(C,{size:20,color:x(f.type)},{default:a(()=>[(c(),k(oe(L(f.type))))]),_:2},1032,["color"])]),o("div",he,[o("div",Ee,v(f.title),1),o("div",Re,v(f.content),1),o("div",Se,v(z(f.sendTime)),1)]),f.isRead===0?(c(),h("div",ke)):w("",!0)],10,Ce))),128))]),s(u,{style:{margin:"8px 0"}}),o("div",we,[s(e,{type:"text",onClick:U},{default:a(()=>[...r[3]||(r[3]=[p("查看全部",-1)])]),_:1})])])]),_:1})}}},et=Y(Ne,[["__scopeId","data-v-0498034e"]]),Ae={class:"announcement-section"},Me={class:"section-header"},$e={class:"section-title"},Te={class:"announcement-list"},Oe={key:0,class:"empty-announcements"},Ue=["onClick"],xe={class:"announcement-content"},Ie={class:"announcement-type"},be=["title"],De=["title"],Le={class:"announcement-meta"},ze={class:"publish-time"},Be={class:"view-count"},Fe={class:"announcement-actions"},Ve={key:0,class:"announcement-detail"},Pe={class:"announcement-header"},Ge={class:"announcement-type-tag"},Ke={class:"announcement-time"},He={class:"announcement-content-detail"},Ye=["innerHTML"],Xe={class:"announcement-footer"},qe={class:"view-count"},Qe={class:"dialog-footer"},We={__name:"AnnouncementSection",setup(J){const $=j(),m=E([]),_=E(!1),d=E(null),R=E(!1),S=E(null),T={1:{text:"系统通知",tag:"danger"},2:{text:"维护通知",tag:"warning"},3:{text:"节日通知",tag:"success"},4:{text:"活动通知",tag:"primary"}},M=async()=>{try{R.value=!0;const t=await K.get("/api/announcement/page",{params:{current:1,size:5,status:1}});if(t.code===200){const e=t.data.records.map(i=>i.id),u=await D(e);m.value=t.data.records.map(i=>({...i,isRead:u[i.id]||!1}))}}catch(t){console.error("获取公告失败:",t),A.error("获取公告失败")}finally{R.value=!1}},D=async t=>{try{const e=await K.post("/api/announcement/read-status",{announcementIds:t});if(e.code===200)return e.data||{}}catch(e){console.error("获取已读状态失败:",e)}return{}},O=t=>{var e;return((e=T[t])==null?void 0:e.tag)||"info"},U=t=>{var e;return((e=T[t])==null?void 0:e.text)||"其他"},L=(t,e=60)=>t?t.length>e?t.substring(0,e)+"...":t:"",x=t=>{if(!t)return"";const e=new Date(t),i=new Date-e;return i<60*60*1e3?"刚刚":i<24*60*60*1e3?`${Math.floor(i/36e5)}小时前`:i<7*24*60*60*1e3?`${Math.floor(i/864e5)}天前`:e.toLocaleDateString()},z=t=>t?t.replace(/\n/g,"<br>"):"",B=t=>{d.value=t,_.value=!0,t.viewCount!==void 0&&t.viewCount++},I=async t=>{try{(await K.post(`/api/announcement/read/${t.id}`)).code===200&&(t.isRead=!0,A.success("已标记为已读"),await M())}catch(e){console.error("标记已读失败:",e),A.error("标记已读失败")}},n=()=>{$.push("/announcement/list")},r=()=>{S.value=setInterval(()=>{M()},5*60*1e3)},C=()=>{S.value&&(clearInterval(S.value),S.value=null)};return X(()=>{M(),r()}),se(()=>{C()}),(t,e)=>{var H;const u=y("el-icon"),i=y("el-tag"),g=y("el-button"),f=y("el-empty"),b=y("el-dialog");return c(),h("div",Ae,[o("div",Me,[o("h3",$e,[s(u,{color:"#f56c6c"},{default:a(()=>[s(N(W))]),_:1}),e[3]||(e[3]=p(" 系统公告 ",-1)),m.value.length>0?(c(),k(i,{key:0,type:"info",size:"small"},{default:a(()=>[p(v(m.value.length)+" 条 ",1)]),_:1})):w("",!0)]),s(g,{type:"primary",link:"",size:"small",onClick:n},{default:a(()=>[e[4]||(e[4]=p(" 查看全部 ",-1)),s(u,null,{default:a(()=>[s(N(ae))]),_:1})]),_:1})]),o("div",Te,[m.value.length===0?(c(),h("div",Oe,[s(f,{description:"暂无公告","image-size":80},{description:a(()=>[...e[5]||(e[5]=[o("span",{class:"empty-text"},"暂无系统公告",-1)])]),_:1})])):(c(!0),h(Q,{key:1},q(m.value,l=>(c(),h("div",{class:"announcement-item",key:l.id,onClick:F=>B(l)},[o("div",xe,[o("div",Ie,[s(i,{type:O(l.type),size:"small",effect:"plain"},{default:a(()=>[p(v(U(l.type)),1)]),_:2},1032,["type"])]),o("h4",{class:"announcement-title",title:l.title},v(l.title),9,be),o("p",{class:"announcement-desc",title:l.content},v(L(l.content)),9,De),o("div",Le,[o("span",ze,[s(u,null,{default:a(()=>[s(N(ie))]),_:1}),p(" "+v(x(l.publishTime)),1)]),o("span",Be,[s(u,null,{default:a(()=>[s(N(le))]),_:1}),p(" "+v(l.viewCount||0)+" 阅读 ",1)])])]),o("div",Fe,[l.isRead?w("",!0):(c(),k(g,{key:0,type:"primary",link:"",size:"small",onClick:re(F=>I(l),["stop"])},{default:a(()=>[...e[6]||(e[6]=[p(" 标记已读 ",-1)])]),_:1},8,["onClick"]))])],8,Ue))),128))]),s(b,{modelValue:_.value,"onUpdate:modelValue":e[2]||(e[2]=l=>_.value=l),title:(H=d.value)==null?void 0:H.title,width:"600px","destroy-on-close":""},{footer:a(()=>{var l;return[o("div",Qe,[s(g,{onClick:e[0]||(e[0]=F=>_.value=!1)},{default:a(()=>[...e[7]||(e[7]=[p("关闭",-1)])]),_:1}),(l=d.value)!=null&&l.isRead?w("",!0):(c(),k(g,{key:0,type:"primary",onClick:e[1]||(e[1]=F=>{I(d.value),_.value=!1})},{default:a(()=>[...e[8]||(e[8]=[p(" 标记已读 ",-1)])]),_:1}))])]}),default:a(()=>[d.value?(c(),h("div",Ve,[o("div",Pe,[o("div",Ge,[s(i,{type:O(d.value.type),size:"small"},{default:a(()=>[p(v(U(d.value.type)),1)]),_:1},8,["type"])]),o("div",Ke,[o("span",null,"发布时间："+v(x(d.value.publishTime)),1)])]),o("div",He,[o("div",{class:"content-text",innerHTML:z(d.value.content)},null,8,Ye)]),o("div",Xe,[o("span",qe,"阅读量："+v(d.value.viewCount||0),1)])])):w("",!0)]),_:1},8,["modelValue","title"])])}}},tt=Y(We,[["__scopeId","data-v-4409cd86"]]);export{tt as A,et as N};
