import{_ as E,r as g,k as M,t as S,a6 as A,E as o,m as V,d as y,e as a,a as l,f as c,o as d,b as t,B as I,u as f,l as h,c as j,g as H,C as R,i as _,h as U,M as D}from"./index-zUzrFZpX.js";import{a as L,P as G,q as x}from"./PaymentStatusPoller-x6rapwgt.js";const J={class:"alipay-page-container"},K={class:"payment-header"},O={class:"amount"},Q={class:"value"},W={key:0,class:"loading-box"},X={key:1,class:"payment-content"},Y={class:"info-box"},Z={class:"manual-jump"},$={class:"confirm-actions"},ee={key:2,class:"error-box"},se={__name:"AlipayPage",setup(te){const C=A(),m=V(),v=g(!1),u=g(""),r=g(""),n=M({businessNo:"",businessType:"",businessName:"",amount:"0.00"});S(()=>{w(),N()});const w=()=>{const{businessNo:s,businessType:e,businessName:b,amount:i}=C.query;if(!s||!i){o.error("支付信息不完整"),m.back();return}n.businessNo=s,n.businessType=e||"booking",n.businessName=b||"篮球馆服务",n.amount=i},N=async()=>{v.value=!0,u.value="",r.value="";try{const s=await L({businessNo:n.businessNo,businessType:n.businessType,businessName:n.businessName,amount:parseFloat(n.amount)});s.code===200?(u.value=s.data.paymentUrl||s.data.formHtml,r.value=s.data.paymentNo,o.success("支付订单已创建"),setTimeout(()=>{k()},2e3)):o.error(s.message||"创建支付失败")}catch(s){console.error("创建支付宝支付失败:",s),o.error("创建支付失败,请重试")}finally{v.value=!1}},k=()=>{if(!u.value){o.warning("支付地址无效");return}if(u.value.includes("<form")){const s=document.createElement("div");s.innerHTML=u.value,document.body.appendChild(s);const e=s.querySelector("form");e&&e.submit()}else window.open(u.value,"_blank")},P=s=>{o.success("支付成功"),m.replace({path:"/payment/result",query:{status:"success",paymentNo:r.value,amount:n.amount,businessName:n.businessName}})},T=s=>{o.error("支付失败"),m.replace({path:"/payment/result",query:{status:"failed",paymentNo:r.value,amount:n.amount}})},q=async()=>{if(!r.value){o.warning("支付订单不存在");return}try{const s=await x(r.value);s.code===200&&(s.data.status===2?P(s.data):o.warning("未检测到支付成功,请稍后再试"))}catch(s){console.error("查询支付状态失败:",s),o.error("查询失败,请稍后重试")}},B=async()=>{try{await D.confirm("确定要取消支付吗?","取消支付",{confirmButtonText:"确定",cancelButtonText:"继续支付",type:"warning"}),m.back()}catch{}};return(s,e)=>{const b=c("el-divider"),i=c("el-icon"),p=c("el-button"),z=c("el-alert"),F=c("el-card");return d(),y("div",J,[a(F,{class:"payment-card"},{default:l(()=>[t("div",K,[e[1]||(e[1]=t("h2",null,"支付宝支付",-1)),t("div",O,[e[0]||(e[0]=t("span",{class:"label"},"支付金额:",-1)),t("span",Q,"¥"+I(n.amount),1)])]),a(b),v.value?(d(),y("div",W,[a(i,{class:"is-loading",size:48},{default:l(()=>[a(f(h))]),_:1}),e[2]||(e[2]=t("p",null,"正在跳转到支付宝...",-1))])):u.value?(d(),y("div",X,[t("div",Y,[a(i,{size:64,color:"#1677FF"},{default:l(()=>[a(f(R))]),_:1}),e[6]||(e[6]=t("h3",null,"即将跳转到支付宝",-1)),e[7]||(e[7]=t("p",null,"页面将自动跳转到支付宝完成支付",-1)),t("div",Z,[e[4]||(e[4]=t("p",null,"如果页面没有自动跳转,请点击下方按钮:",-1)),a(p,{type:"primary",size:"large",onClick:k},{default:l(()=>[...e[3]||(e[3]=[_(" 立即跳转支付宝 ",-1)])]),_:1})]),a(z,{type:"info",closable:!1,"show-icon":"",class:"tips"},{title:l(()=>[...e[5]||(e[5]=[t("div",{class:"tips-content"},[t("p",null,"• 支付完成后请返回本页面"),t("p",null,"• 支付过程中请勿关闭浏览器")],-1)])]),_:1})]),r.value?(d(),j(G,{key:0,"payment-no":r.value,"query-fn":f(x),interval:3e3,"max-attempts":100,"auto-start":!0,onSuccess:P,onFailed:T},null,8,["payment-no","query-fn"])):H("",!0),t("div",$,[a(p,{size:"large",onClick:B},{default:l(()=>[...e[8]||(e[8]=[_("取消支付",-1)])]),_:1}),a(p,{type:"success",size:"large",onClick:q},{default:l(()=>[...e[9]||(e[9]=[_(" 我已完成支付 ",-1)])]),_:1})])])):(d(),y("div",ee,[a(i,{size:64,color:"#F56C6C"},{default:l(()=>[a(f(U))]),_:1}),e[11]||(e[11]=t("p",null,"创建支付失败",-1)),a(p,{type:"primary",onClick:N},{default:l(()=>[...e[10]||(e[10]=[_("重试",-1)])]),_:1})]))]),_:1})])}}},oe=E(se,[["__scopeId","data-v-27b561cf"]]);export{oe as default};
