import{_ as A,r as b,k as F,t as U,a7 as V,E as a,m as I,d as y,e as l,a as i,f as d,o as u,b as t,v as D,u as g,l as H,c as T,g as w,i as f,h as R,D as j}from"./index-BU1z93KZ.js";import{c as L,P as $,q as C,m as G}from"./PaymentStatusPoller-lxj2Cv0W.js";const J={class:"alipay-page-container"},K={class:"payment-header"},O={class:"amount"},Q={class:"value"},W={key:0,class:"loading-box"},X={key:1,class:"payment-content"},Y={class:"qrcode-box"},Z={class:"qrcode-image"},ee=["src"],se={class:"payment-actions"},te={key:2,class:"error-box"},ae={__name:"AlipayPage",setup(ne){const q=V(),m=I(),v=b(!1),r=b(""),o=b(""),n=F({businessNo:"",businessType:"",businessName:"",amount:"0.00"});U(()=>{x(),k()});const x=()=>{const{businessNo:e,businessType:s,businessName:_,amount:c}=q.query;if(!e||!c){a.error("支付信息不完整"),m.back();return}n.businessNo=e,n.businessType=s||"booking",n.businessName=_||"篮球馆服务",n.amount=c},k=async()=>{v.value=!0,r.value="",o.value="";try{const e=await L({businessNo:n.businessNo,businessType:n.businessType,paymentType:"alipay_page",amount:parseFloat(n.amount),description:n.businessName});e.code===200?(r.value=e.data.qrCodeUrl||e.data.paymentUrl||e.data.formHtml,o.value=e.data.paymentNo,a.success("支付订单已创建"),e.data.qrCodeUrl?a.info("请扫描二维码完成支付"):setTimeout(()=>{h()},2e3)):a.error(e.message||"创建支付失败")}catch(e){console.error("创建支付宝支付失败:",e),a.error("创建支付失败,请重试")}finally{v.value=!1}},h=()=>{if(!r.value){a.warning("支付地址无效");return}if(r.value.includes("<form")){const e=document.createElement("div");e.innerHTML=r.value,document.body.appendChild(e);const s=e.querySelector("form");s&&s.submit()}else window.open(r.value,"_blank")},N=e=>{a.success("支付成功"),m.replace({path:"/payment/result",query:{status:"success",paymentNo:o.value,amount:n.amount,businessName:n.businessName,type:n.businessType}})},B=e=>{a.error("支付失败"),m.replace({path:"/payment/result",query:{status:"failed",paymentNo:o.value,amount:n.amount,type:n.businessType}})},P=async()=>{if(!o.value){a.warning("支付订单不存在");return}try{const e=await C(o.value);e.code===200&&(e.data.status===2?N(e.data):a.warning("未检测到支付成功,请稍后再试"))}catch(e){console.error("查询支付状态失败:",e),a.error("查询失败,请稍后重试")}},S=async()=>{try{await j.confirm("确定要取消支付吗?","取消支付",{confirmButtonText:"确定",cancelButtonText:"继续支付",type:"warning"}),m.back()}catch{}},z=async()=>{if(!o.value){a.warning("支付订单不存在");return}try{const e=await G(o.value);e.code===200?(a.success("模拟支付成功"),setTimeout(()=>{P()},500)):a.error(e.message||"模拟支付失败")}catch(e){console.error("模拟支付失败:",e),a.error("模拟支付失败")}};return(e,s)=>{const _=d("el-divider"),c=d("el-icon"),E=d("el-alert"),p=d("el-button"),M=d("el-card");return u(),y("div",J,[l(M,{class:"payment-card"},{default:i(()=>[t("div",K,[s[1]||(s[1]=t("h2",null,"支付宝支付",-1)),t("div",O,[s[0]||(s[0]=t("span",{class:"label"},"支付金额:",-1)),t("span",Q,"¥"+D(n.amount),1)])]),l(_),v.value?(u(),y("div",W,[l(c,{class:"is-loading",size:48},{default:i(()=>[l(g(H))]),_:1}),s[2]||(s[2]=t("p",null,"正在生成支付二维码...",-1))])):r.value?(u(),y("div",X,[t("div",Y,[t("div",Z,[t("img",{src:r.value,alt:"支付宝支付二维码"},null,8,ee)]),s[4]||(s[4]=t("h3",null,"请使用支付宝扫码支付",-1)),s[5]||(s[5]=t("p",null,"打开支付宝APP，扫描二维码完成支付",-1)),l(E,{type:"info",closable:!1,"show-icon":"",class:"tips"},{title:i(()=>[...s[3]||(s[3]=[t("div",{class:"tips-content"},[t("p",null,"• 请在5分钟内完成支付"),t("p",null,"• 支付完成后会自动跳转")],-1)])]),_:1})]),o.value?(u(),T($,{key:0,"payment-no":o.value,"query-fn":g(C),interval:3e3,"max-attempts":100,"auto-start":!0,onSuccess:N,onFailed:B},null,8,["payment-no","query-fn"])):w("",!0),t("div",se,[l(p,{size:"large",onClick:S},{default:i(()=>[...s[6]||(s[6]=[f("取消支付",-1)])]),_:1}),l(p,{type:"primary",size:"large",onClick:P},{default:i(()=>[...s[7]||(s[7]=[f(" 支付遇到问题? ",-1)])]),_:1}),o.value?(u(),T(p,{key:0,type:"success",size:"large",onClick:z},{default:i(()=>[...s[8]||(s[8]=[f(" 模拟支付成功 ",-1)])]),_:1})):w("",!0)])])):(u(),y("div",te,[l(c,{size:64,color:"#F56C6C"},{default:i(()=>[l(g(R))]),_:1}),s[10]||(s[10]=t("p",null,"创建支付失败",-1)),l(p,{type:"primary",onClick:k},{default:i(()=>[...s[9]||(s[9]=[f("重试",-1)])]),_:1})]))]),_:1})])}}},re=A(ae,[["__scopeId","data-v-9c78ef09"]]);export{re as default};
