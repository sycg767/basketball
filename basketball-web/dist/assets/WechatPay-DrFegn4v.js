import{_ as E,r as w,w as I,v as F,f as q,d,o as c,e as l,b as s,a as m,u as x,l as W,B as g,g as b,a7 as z,ak as Q,c as V,h as j,i as U,k as A,t as G,a6 as H,E as u,m as J,M as $}from"./index-DU9PCbH8.js";import{c as K,P as L,q as M}from"./PaymentStatusPoller-DUwAHRt_.js";const O={class:"qrcode-container"},X={key:0,class:"qrcode-loading"},Y={key:1,class:"qrcode-content"},Z={class:"qrcode-box"},ee=["src","alt"],te={class:"qrcode-info"},oe={key:0,class:"qrcode-title"},se={key:1,class:"qrcode-description"},ae={key:2,class:"qrcode-timer"},ne={key:0,class:"qrcode-footer"},re={key:2,class:"qrcode-error"},le={__name:"QrCodeDisplay",props:{qrCodeUrl:{type:String,default:""},title:{type:String,default:"扫码支付"},description:{type:String,default:""},loading:{type:Boolean,default:!1},loadingText:{type:String,default:"正在生成二维码..."},errorText:{type:String,default:"二维码加载失败"},showTimer:{type:Boolean,default:!1},timeout:{type:Number,default:300},showRetry:{type:Boolean,default:!0}},emits:["timeout","retry"],setup(n,{expose:B,emit:_}){const i=n,v=_,a=w(0);let y=null;I(()=>i.qrCodeUrl,r=>{r&&i.showTimer?o():f()}),I(()=>i.showTimer,r=>{r&&i.qrCodeUrl?o():f()});const o=()=>{a.value=i.timeout,y=setInterval(()=>{a.value--,a.value<=0&&(f(),v("timeout"))},1e3)},f=()=>{y&&(clearInterval(y),y=null),a.value=0},T=r=>{const h=Math.floor(r/60),p=r%60;return`${h.toString().padStart(2,"0")}:${p.toString().padStart(2,"0")}`},C=()=>{v("retry")};return F(()=>{f()}),B({startCountdown:o,stopCountdown:f}),(r,h)=>{const p=q("el-icon"),k=q("el-button");return c(),d("div",O,[n.loading?(c(),d("div",X,[l(p,{class:"is-loading"},{default:m(()=>[l(x(W))]),_:1}),s("p",null,g(n.loadingText),1)])):n.qrCodeUrl?(c(),d("div",Y,[s("div",Z,[s("img",{src:n.qrCodeUrl,alt:n.title,class:"qrcode-image"},null,8,ee)]),s("div",te,[n.title?(c(),d("h3",oe,g(n.title),1)):b("",!0),n.description?(c(),d("p",se,g(n.description),1)):b("",!0),n.showTimer&&a.value>0?(c(),d("div",ae,[l(p,null,{default:m(()=>[l(x(z))]),_:1}),s("span",null,"剩余时间: "+g(T(a.value)),1)])):b("",!0)]),r.$slots.footer?(c(),d("div",ne,[Q(r.$slots,"footer",{},void 0,!0)])):b("",!0)])):(c(),d("div",re,[l(p,{color:"#F56C6C"},{default:m(()=>[l(x(j))]),_:1}),s("p",null,g(n.errorText),1),n.showRetry?(c(),V(k,{key:0,type:"primary",onClick:C},{default:m(()=>[...h[0]||(h[0]=[U(" 重新加载 ",-1)])]),_:1})):b("",!0)]))])}}},ce=E(le,[["__scopeId","data-v-73b784bb"]]),ie={class:"wechat-pay-container"},ue={class:"payment-header"},de={class:"amount"},me={class:"value"},ye={class:"payment-tips"},fe={class:"payment-actions"},pe={__name:"WechatPay",setup(n){const B=H(),_=J(),i=w(!1),v=w(""),a=w(""),y=w(null),o=A({businessNo:"",businessType:"",businessName:"",amount:"0.00"});G(()=>{f(),T()});const f=()=>{const{businessNo:e,businessType:t,businessName:P,amount:N}=B.query;if(!e||!N){u.error("支付信息不完整"),_.back();return}o.businessNo=e,o.businessType=t||"booking",o.businessName=P||"篮球馆服务",o.amount=N},T=async()=>{i.value=!0,v.value="",a.value="";try{const e=await K({businessNo:o.businessNo,businessType:o.businessType,businessName:o.businessName,amount:parseFloat(o.amount)});e.code===200?(v.value=e.data.qrCodeUrl||e.data.codeUrl,a.value=e.data.paymentNo,u.success("支付二维码已生成")):u.error(e.message||"创建支付失败")}catch(e){console.error("创建微信支付失败:",e),u.error("创建支付失败,请重试")}finally{i.value=!1}},C=e=>{u.success("支付成功"),_.replace({path:"/payment/result",query:{status:"success",paymentNo:a.value,amount:o.amount,businessName:o.businessName}})},r=e=>{u.error("支付失败"),_.replace({path:"/payment/result",query:{status:"failed",paymentNo:a.value,amount:o.amount}})},h=()=>{$.confirm("二维码已过期,是否重新生成?","提示",{confirmButtonText:"重新生成",cancelButtonText:"取消支付",type:"warning"}).then(()=>{T()}).catch(()=>{S()})},p=()=>{$.confirm("支付超时,请确认是否已完成支付","支付超时",{confirmButtonText:"已完成支付",cancelButtonText:"取消支付",type:"warning"}).then(()=>{k()}).catch(()=>{S()})},k=async()=>{if(!a.value){u.warning("支付订单不存在");return}try{const e=await M(a.value);if(e.code===200){const t=e.data.status;t===2?C(e.data):t===3||t===4||t===5?r(e.data):u.info("支付尚未完成,请继续扫码支付")}}catch(e){console.error("查询支付状态失败:",e),u.error("查询失败,请稍后重试")}},S=async()=>{try{await $.confirm("确定要取消支付吗?","取消支付",{confirmButtonText:"确定",cancelButtonText:"继续支付",type:"warning"}),_.back()}catch{}};return F(()=>{var e;(e=y.value)==null||e.stopCountdown()}),(e,t)=>{const P=q("el-divider"),N=q("el-alert"),R=q("el-button"),D=q("el-card");return c(),d("div",ie,[l(D,{class:"payment-card"},{default:m(()=>[s("div",ue,[t[1]||(t[1]=s("h2",null,"微信扫码支付",-1)),s("div",de,[t[0]||(t[0]=s("span",{class:"label"},"支付金额:",-1)),s("span",me,"¥"+g(o.amount),1)])]),l(P),l(ce,{ref_key:"qrCodeRef",ref:y,"qr-code-url":v.value,loading:i.value,"show-timer":!0,timeout:300,title:"请使用微信扫码支付",description:"打开微信，扫描二维码完成支付","loading-text":"正在生成支付二维码...",onTimeout:h,onRetry:T},{footer:m(()=>[s("div",ye,[l(N,{type:"info",closable:!1,"show-icon":""},{title:m(()=>[...t[2]||(t[2]=[s("div",{class:"tips-content"},[s("p",null,"• 请在5分钟内完成支付"),s("p",null,"• 支付完成后会自动跳转")],-1)])]),_:1})])]),_:1},8,["qr-code-url","loading"]),a.value?(c(),V(L,{key:0,"payment-no":a.value,"query-fn":x(M),interval:2e3,"max-attempts":150,"auto-start":!0,onSuccess:C,onFailed:r,onTimeout:p},null,8,["payment-no","query-fn"])):b("",!0),s("div",fe,[l(R,{size:"large",onClick:S},{default:m(()=>[...t[3]||(t[3]=[U("取消支付",-1)])]),_:1}),l(R,{type:"primary",size:"large",onClick:k},{default:m(()=>[...t[4]||(t[4]=[U(" 支付遇到问题? ",-1)])]),_:1})])]),_:1})])}}},he=E(pe,[["__scopeId","data-v-01024eca"]]);export{he as default};
