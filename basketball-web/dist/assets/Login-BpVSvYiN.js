import{_ as D,r as m,w as W,c as O,a as l,b as s,d as C,e as o,u as x,l as X,f as p,g as Y,s as Z,h as ee,i as R,o as V,E as u,j as oe,k as N,m as se,n as le,p as T}from"./index-DqRIPXSt.js";import{v as S,a as ne,b as te}from"./validate-CbFD6edE.js";import{g as ae,S as re,l as de,s as ie}from"./SmsCountdown-CEoZrlBO.js";const ue={class:"wechat-login-content"},ce={key:0,class:"loading-box"},pe={key:1,class:"qrcode-box"},me={class:"qrcode-wrapper"},fe=["src"],ge={key:0,class:"scan-status"},ve={key:2,class:"error-box"},_e={class:"dialog-footer"},he={__name:"WechatLoginDialog",props:{modelValue:{type:Boolean,default:!1}},emits:["update:modelValue","success"],setup($,{emit:v}){const f=$,U=v,i=m(!1),h=m(!1),g=m(""),w=m("");W(()=>f.modelValue,r=>{i.value=r,r&&_()}),W(i,r=>{U("update:modelValue",r)});const _=async()=>{h.value=!0,w.value="";try{const r=await ae();if(r.code===200){const t=r.data.authUrl;g.value=`https://api.qrserver.com/v1/create-qr-code/?size=200x200&data=${encodeURIComponent(t)}`,k()}else u.error(r.message||"获取二维码失败"),g.value=""}catch(r){console.error("获取微信授权URL失败:",r),u.error("获取二维码失败"),g.value=""}finally{h.value=!1}},k=()=>{},a=()=>{g.value="",w.value=""};return(r,t)=>{const z=p("el-icon"),E=p("el-button"),P=p("el-dialog");return V(),O(P,{modelValue:i.value,"onUpdate:modelValue":t[1]||(t[1]=L=>i.value=L),title:"微信扫码登录",width:"420px","close-on-click-modal":!1,class:"wechat-login-dialog",onClose:a},{footer:l(()=>[s("div",_e,[o(E,{onClick:t[0]||(t[0]=L=>i.value=!1),class:"cancel-btn"},{default:l(()=>[...t[7]||(t[7]=[R("取消",-1)])]),_:1})])]),default:l(()=>[s("div",ue,[h.value?(V(),C("div",ce,[o(z,{class:"is-loading",size:48},{default:l(()=>[o(x(X))]),_:1}),t[2]||(t[2]=s("p",null,"正在加载二维码...",-1))])):g.value?(V(),C("div",pe,[s("div",me,[s("img",{src:g.value,alt:"微信扫码登录",class:"qrcode-image"},null,8,fe)]),t[4]||(t[4]=s("p",{class:"qrcode-tip"},"请使用微信扫描二维码登录",-1)),w.value==="scanned"?(V(),C("div",ge,[o(z,{color:"#34C759",size:20},{default:l(()=>[o(x(Z))]),_:1}),t[3]||(t[3]=s("p",null,"扫码成功，请在手机上确认登录",-1))])):Y("",!0)])):(V(),C("div",ve,[o(z,{color:"#FF3B30",size:48},{default:l(()=>[o(x(ee))]),_:1}),t[6]||(t[6]=s("p",null,"二维码加载失败",-1)),o(E,{type:"primary",onClick:_,class:"reload-btn"},{default:l(()=>[...t[5]||(t[5]=[R("重新加载",-1)])]),_:1})]))])]),_:1},8,["modelValue"])}}},we=D(he,[["__scopeId","data-v-587337c5"]]),ye={class:"login-container"},be={class:"login-box"},Ve={class:"logo-section"},Ce={class:"logo-icon"},xe={class:"code-input-wrapper"},Re={class:"login-footer"},Ue={__name:"Login",setup($){const v=se(),f=oe(),U=m("account"),i=m(!1),h=m(!1),g=m(!1),w=m(null),_=N({username:"",password:""}),k=m(null),a=N({phone:"",code:""}),r=m(null),E={username:[{validator:(d,e,n)=>{e?te(e)?n():n(new Error("用户名为3-20位字母、数字或下划线")):n(new Error("请输入用户名"))},trigger:"blur"}],password:[{validator:(d,e,n)=>{e?ne(e)?n():n(new Error("密码长度为6-20位")):n(new Error("请输入密码"))},trigger:"blur"}]},K={phone:[{validator:(d,e,n)=>{e?S(e)?n():n(new Error("请输入正确的手机号")):n(new Error("请输入手机号"))},trigger:"blur"}],code:[{validator:(d,e,n)=>{e?/^\d{6}$/.test(e)?n():n(new Error("请输入6位数字验证码")):n(new Error("请输入验证码"))},trigger:"blur"}]},F=()=>{w.value.validate(async d=>{if(d){i.value=!0;try{await f.login(_),u.success("登录成功"),f.isAdmin?v.push("/admin/dashboard"):v.push("/user-center")}catch(e){console.error("登录失败",e)}finally{i.value=!1}}})},M=async()=>{var d;if(!a.phone){u.warning("请输入手机号");return}if(!S(a.phone)){u.warning("请输入正确的手机号");return}h.value=!0;try{const e=await ie({phone:a.phone,type:"login"});e.code===200?(u.success("验证码已发送"),(d=r.value)==null||d.startCountdown()):u.error(e.message||"发送验证码失败")}catch(e){console.error("发送验证码失败:",e),u.error("发送验证码失败")}finally{h.value=!1}},q=()=>{k.value.validate(async d=>{if(d){i.value=!0;try{const e=await de({phone:a.phone,code:a.code});if(e.code===200){const{token:n,user:y}=e.data;f.setToken(n),f.setUserInfo(y),u.success("登录成功"),f.isAdmin?v.push("/admin/dashboard"):v.push("/user-center")}else u.error(e.message||"登录失败")}catch(e){console.error("手机登录失败:",e),u.error("登录失败")}finally{i.value=!1}}})},j=()=>{g.value=!0},Q=d=>{const{token:e,user:n}=d;f.setToken(e),f.setUserInfo(n),u.success("微信登录成功"),f.isAdmin?v.push("/admin/dashboard"):v.push("/user-center")},G=()=>{v.push("/register")};return(d,e)=>{const n=p("el-icon"),y=p("el-input"),b=p("el-form-item"),B=p("el-button"),I=p("el-form"),A=p("el-tab-pane"),H=p("el-tabs"),J=p("el-link");return V(),C("div",ye,[s("div",be,[s("div",Ve,[s("div",Ce,[o(n,{size:48},{default:l(()=>[o(x(le))]),_:1})]),e[6]||(e[6]=s("h1",{class:"title"},"篮球馆场地预约",-1)),e[7]||(e[7]=s("p",{class:"subtitle"},"欢迎回来",-1))]),o(H,{modelValue:U.value,"onUpdate:modelValue":e[4]||(e[4]=c=>U.value=c),class:"login-tabs"},{default:l(()=>[o(A,{label:"账号登录",name:"account"},{default:l(()=>[o(I,{ref_key:"accountFormRef",ref:w,model:_,rules:E,class:"login-form"},{default:l(()=>[o(b,{prop:"username"},{default:l(()=>[o(y,{modelValue:_.username,"onUpdate:modelValue":e[0]||(e[0]=c=>_.username=c),placeholder:"用户名",size:"large","prefix-icon":"User"},null,8,["modelValue"])]),_:1}),o(b,{prop:"password"},{default:l(()=>[o(y,{modelValue:_.password,"onUpdate:modelValue":e[1]||(e[1]=c=>_.password=c),type:"password",placeholder:"密码",size:"large","prefix-icon":"Lock","show-password":"",onKeyup:T(F,["enter"])},null,8,["modelValue"])]),_:1}),o(b,null,{default:l(()=>[o(B,{type:"primary",size:"large",loading:i.value,class:"login-btn",onClick:F},{default:l(()=>[...e[8]||(e[8]=[R(" 登录 ",-1)])]),_:1},8,["loading"])]),_:1})]),_:1},8,["model"])]),_:1}),o(A,{label:"手机登录",name:"phone"},{default:l(()=>[o(I,{ref_key:"phoneFormRef",ref:k,model:a,rules:K,class:"login-form"},{default:l(()=>[o(b,{prop:"phone"},{default:l(()=>[o(y,{modelValue:a.phone,"onUpdate:modelValue":e[2]||(e[2]=c=>a.phone=c),placeholder:"手机号",size:"large","prefix-icon":"Iphone",maxlength:"11"},null,8,["modelValue"])]),_:1}),o(b,{prop:"code"},{default:l(()=>[s("div",xe,[o(y,{modelValue:a.code,"onUpdate:modelValue":e[3]||(e[3]=c=>a.code=c),placeholder:"验证码",size:"large","prefix-icon":"Message",maxlength:"6",onKeyup:T(q,["enter"])},null,8,["modelValue"]),o(re,{ref_key:"smsCountdownRef",ref:r,disabled:!a.phone||!x(S)(a.phone),loading:h.value,text:"获取验证码",class:"send-code-btn",onSend:M},null,8,["disabled","loading"])])]),_:1}),o(b,null,{default:l(()=>[o(B,{type:"primary",size:"large",loading:i.value,class:"login-btn",onClick:q},{default:l(()=>[...e[9]||(e[9]=[R(" 登录 ",-1)])]),_:1},8,["loading"])]),_:1})]),_:1},8,["model"])]),_:1})]),_:1},8,["modelValue"]),s("div",{class:"oauth-login"},[e[11]||(e[11]=s("div",{class:"divider"},[s("span",null,"其他方式")],-1)),s("div",{class:"oauth-buttons"},[s("button",{class:"wechat-btn",onClick:j},[...e[10]||(e[10]=[s("svg",{class:"icon","aria-hidden":"true"},[s("use",{"xlink:href":"#icon-wechat"})],-1)])])])]),s("div",Re,[e[13]||(e[13]=s("span",null,"还没有账号？",-1)),o(J,{type:"primary",onClick:G},{default:l(()=>[...e[12]||(e[12]=[R("立即注册",-1)])]),_:1})])]),o(we,{modelValue:g.value,"onUpdate:modelValue":e[5]||(e[5]=c=>g.value=c),onSuccess:Q},null,8,["modelValue"])])}}},Le=D(Ue,[["__scopeId","data-v-5c7cc093"]]);export{Le as default};
