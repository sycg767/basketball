import{_ as ue,j as de,r as d,k as ce,a7 as me,a0 as g,t as $,T as pe,d as b,e as l,b as o,a as n,f as r,E as P,m as ve,o as c,g as k,v as i,i as x,u as _e,a2 as fe,c as A}from"./index-DqRIPXSt.js";import{a as ge}from"./venue-DQeNl160.js";import{b as be,d as ke,e as he}from"./booking-DYj8vmzh.js";import{B as ye}from"./BackButton-CB8aFD-N.js";const Pe={class:"booking-create-container"},Ve={class:"create-content"},Te={key:0,class:"venue-info"},Ce=["src"],xe={class:"venue-details"},De={class:"location"},we={key:0,class:"price"},Ue={class:"price-value"},Ne={key:0,class:"availability-tip"},Ie={class:"points-section"},Ae={key:1,class:"points-input"},Be={class:"points-info"},He={class:"deduct-amount"},Me={class:"price-summary"},Fe={class:"price-item"},Ye={class:"price-item"},Re={key:0,class:"price-item"},qe={class:"member-price"},Ee={key:1,class:"price-item"},Se={class:"discount-price"},Le={key:2,class:"price-item"},ze={class:"points-deduct"},je={class:"price-item total"},$e={class:"total-price"},Ge={class:"action-buttons"},Je={__name:"Create",setup(Ke){const B=me(),H=ve(),M=de(),D=d(null),w=d(!1),h=d(null),T=d(!1),V=d(!1),F=d(!1),u=d({duration:0,pricePerHour:0,totalPrice:0,actualPrice:0,discountAmount:0,hasCard:!1,cardName:"",discount:1}),p=d(!1),y=d(0),v=d(100),_=d(0),a=ce({venueId:B.params.venueId,bookingDate:"",startTime:"",endTime:"",bookingType:1,contactName:"",contactPhone:"",peopleCount:1,remark:""}),G={bookingDate:[{required:!0,message:"请选择预订日期",trigger:"change"}],startTime:[{required:!0,message:"请选择开始时间",trigger:"change"}],endTime:[{required:!0,message:"请选择结束时间",trigger:"change"}],contactPhone:[{pattern:/^1[3-9]\d{9}$/,message:"请输入正确的手机号",trigger:"blur"}]},J=g(()=>u.value.duration||0),Y=g(()=>{const t=u.value.standardPricePerHour||0;return console.log("[前端计算] 标准价格 standardPrice:",t),t}),K=g(()=>{const t=u.value.discount||1;return console.log("[前端计算] 会员折扣 memberDiscount:",t),t}),O=g(()=>{const t=u.value.pricePerHour||0;return console.log("[前端计算] 会员单价 memberPrice:",t),t}),f=g(()=>u.value.actualPrice||0),C=g(()=>y.value>=100),R=g(()=>{if(!f.value||f.value===0)return 0;const t=f.value*.5,e=Math.floor(t*100);return Math.min(e,y.value)}),Q=g(()=>p.value&&_.value>0?Math.max(0,f.value-_.value):f.value),W=t=>t<new Date(new Date().setHours(0,0,0,0)),U=async()=>{if(!a.bookingDate||!a.startTime||!a.endTime){T.value=!1,u.value={duration:0,standardPricePerHour:0,pricePerHour:0,totalPrice:0,actualPrice:0,discountAmount:0,hasCard:!1,cardName:"",discount:1};return}F.value=!0;try{const[t,e]=await Promise.all([be({venueId:a.venueId,bookingDate:a.bookingDate,startTime:a.startTime,endTime:a.endTime}),ke({venueId:a.venueId,bookingDate:a.bookingDate,startTime:a.startTime,endTime:a.endTime})]);V.value=t.data,T.value=!0,e.data&&(console.log("=== 价格计算结果 ==="),console.log("后端返回完整数据:",e.data),console.log("标准单价 (standardPricePerHour):",e.data.standardPricePerHour),console.log("会员单价 (pricePerHour):",e.data.pricePerHour),console.log("时长 (duration):",e.data.duration),console.log("总价 (totalPrice):",e.data.totalPrice),console.log("实付价格 (actualPrice):",e.data.actualPrice),console.log("会员等级 (memberLevel):",e.data.memberLevel),console.log("是否有会员卡 (hasCard):",e.data.hasCard),e.data.hasCard&&(console.log("会员卡名称 (cardName):",e.data.cardName),console.log("会员卡折扣 (discount):",e.data.discount),console.log("折扣金额 (discountAmount):",e.data.discountAmount)),console.log("=================="),u.value=e.data)}catch(t){P.error(t.message||"检查可用性失败"),V.value=!1,T.value=!1}finally{F.value=!1}},X=t=>{if(!t)_.value=0,v.value=100;else{if(!C.value){p.value=!1,P.warning("积分不足，最少需要 100 积分才能使用抵扣功能");return}q()}},q=()=>{if(!p.value||v.value<100){_.value=0;return}let t=v.value/100;const e=f.value*.5;t>e&&(t=e),_.value=t},E=async()=>{try{await M.getUserInfo(),y.value=M.points||0,console.log("用户积分:",y.value)}catch(t){console.error("获取用户积分失败:",t),y.value=0}},Z=async()=>{try{const t=await ge(B.params.venueId);h.value=t.data}catch(t){P.error(t.message||"获取场地信息失败"),H.back()}},ee=async()=>{if(D.value)try{if(await D.value.validate(),!V.value){P.warning("该时段不可预订,请重新选择");return}w.value=!0;const t=await he({venueId:parseInt(a.venueId),bookingDate:a.bookingDate,startTime:a.startTime,endTime:a.endTime,bookingType:a.bookingType,contactName:a.contactName,contactPhone:a.contactPhone,peopleCount:a.peopleCount,remark:a.remark});P.success("预订成功");const e={};p.value&&v.value>0&&(e.pointsToUse=v.value),H.push({path:`/booking/detail/${t.data}`,query:e})}catch(t){P.error(t.message||"预订失败")}finally{w.value=!1}};return $(()=>{Z(),E()}),$(()=>{const t=()=>{document.visibilityState==="visible"&&E()};document.addEventListener("visibilitychange",t),pe(()=>{document.removeEventListener("visibilitychange",t)})}),(t,e)=>{const te=r("el-icon"),S=r("el-card"),ae=r("el-date-picker"),m=r("el-form-item"),L=r("el-time-select"),z=r("el-col"),oe=r("el-row"),N=r("el-alert"),I=r("el-input"),le=r("el-input-number"),ne=r("el-checkbox"),se=r("el-slider"),re=r("el-form"),j=r("el-button");return c(),b("div",Pe,[l(ye,{text:"返回"}),o("div",Ve,[l(S,{class:"venue-card"},{header:n(()=>[...e[9]||(e[9]=[o("div",{class:"card-header"},[o("span",null,"场地信息")],-1)])]),default:n(()=>[h.value?(c(),b("div",Te,[o("img",{src:h.value.imageUrl||"/default-venue.jpg",alt:"场地图片",class:"venue-image"},null,8,Ce),o("div",xe,[o("h2",null,i(h.value.venueName),1),o("p",De,[l(te,null,{default:n(()=>[l(_e(fe))]),_:1}),x(" "+i(h.value.location),1)]),Y.value>0?(c(),b("p",we,[e[10]||(e[10]=o("span",{class:"price-label"},"价格:",-1)),o("span",Ue,"¥"+i(Y.value.toFixed(2))+"/小时",1)])):k("",!0)])])):k("",!0)]),_:1}),l(S,{class:"form-card"},{header:n(()=>[...e[11]||(e[11]=[o("div",{class:"card-header"},[o("span",null,"预订信息")],-1)])]),default:n(()=>[l(re,{ref_key:"formRef",ref:D,model:a,rules:G,"label-width":"100px"},{default:n(()=>[l(m,{label:"预订日期",prop:"bookingDate",required:""},{default:n(()=>[l(ae,{modelValue:a.bookingDate,"onUpdate:modelValue":e[0]||(e[0]=s=>a.bookingDate=s),type:"date",placeholder:"选择预订日期","disabled-date":W,format:"YYYY-MM-DD","value-format":"YYYY-MM-DD",style:{width:"100%"},onChange:U},null,8,["modelValue"])]),_:1}),l(m,{label:"预订时段",required:""},{default:n(()=>[l(oe,{gutter:16},{default:n(()=>[l(z,{span:12},{default:n(()=>[l(m,{prop:"startTime"},{default:n(()=>[l(L,{modelValue:a.startTime,"onUpdate:modelValue":e[1]||(e[1]=s=>a.startTime=s),placeholder:"开始时间",start:"06:00",end:"22:00",step:"01:00",onChange:U,style:{width:"100%"}},null,8,["modelValue"])]),_:1})]),_:1}),l(z,{span:12},{default:n(()=>[l(m,{prop:"endTime"},{default:n(()=>[l(L,{modelValue:a.endTime,"onUpdate:modelValue":e[2]||(e[2]=s=>a.endTime=s),placeholder:"结束时间",start:"07:00",end:"23:00",step:"01:00","min-time":a.startTime,onChange:U,style:{width:"100%"}},null,8,["modelValue","min-time"])]),_:1})]),_:1})]),_:1}),T.value?(c(),b("div",Ne,[V.value?(c(),A(N,{key:0,title:"该时段可预订",type:"success",closable:!1,"show-icon":""})):(c(),A(N,{key:1,title:"该时段已被预订,请选择其他时间",type:"error",closable:!1,"show-icon":""}))])):k("",!0)]),_:1}),l(m,{label:"联系人",prop:"contactName"},{default:n(()=>[l(I,{modelValue:a.contactName,"onUpdate:modelValue":e[3]||(e[3]=s=>a.contactName=s),placeholder:"请输入联系人姓名"},null,8,["modelValue"])]),_:1}),l(m,{label:"联系电话",prop:"contactPhone"},{default:n(()=>[l(I,{modelValue:a.contactPhone,"onUpdate:modelValue":e[4]||(e[4]=s=>a.contactPhone=s),placeholder:"请输入联系电话"},null,8,["modelValue"])]),_:1}),l(m,{label:"人数",prop:"peopleCount"},{default:n(()=>{var s;return[l(le,{modelValue:a.peopleCount,"onUpdate:modelValue":e[5]||(e[5]=ie=>a.peopleCount=ie),min:1,max:((s=h.value)==null?void 0:s.capacity)||100,placeholder:"请输入人数"},null,8,["modelValue","max"])]}),_:1}),l(m,{label:"备注",prop:"remark"},{default:n(()=>[l(I,{modelValue:a.remark,"onUpdate:modelValue":e[6]||(e[6]=s=>a.remark=s),type:"textarea",rows:4,placeholder:"请输入备注信息"},null,8,["modelValue"])]),_:1}),l(m,{label:"使用积分"},{default:n(()=>[o("div",Ie,[l(ne,{modelValue:p.value,"onUpdate:modelValue":e[7]||(e[7]=s=>p.value=s),onChange:X,disabled:!C.value},{default:n(()=>[x(" 使用积分抵扣（可用积分："+i(y.value)+"） ",1)]),_:1},8,["modelValue","disabled"]),C.value?k("",!0):(c(),A(N,{key:0,type:"warning",closable:!1,"show-icon":"",style:{"margin-top":"8px"}},{title:n(()=>[...e[12]||(e[12]=[o("span",{style:{"font-size":"13px"}}," 积分不足，最少需要 100 积分才能使用抵扣功能 ",-1)])]),_:1})),p.value&&C.value&&R.value>=100?(c(),b("div",Ae,[l(se,{modelValue:v.value,"onUpdate:modelValue":e[8]||(e[8]=s=>v.value=s),min:100,max:Math.max(100,R.value),step:100,disabled:!f.value||f.value===0,onChange:q},null,8,["modelValue","max","disabled"]),o("div",Be,[o("span",null,"使用 "+i(v.value)+" 积分",1),o("span",He,"抵扣 ¥"+i(_.value.toFixed(2)),1)])])):k("",!0)])]),_:1}),l(m,{label:"预计费用"},{default:n(()=>[o("div",Me,[o("div",Fe,[e[13]||(e[13]=o("span",null,"时长:",-1)),o("span",null,i(J.value)+" 小时",1)]),o("div",Ye,[e[14]||(e[14]=o("span",null,"单价:",-1)),o("span",null,"¥"+i(O.value.toFixed(2))+"/小时",1)]),u.value.hasCard?(c(),b("div",Re,[e[15]||(e[15]=o("span",null,"会员卡:",-1)),o("span",qe,i(u.value.cardName)+" ("+i((K.value*10).toFixed(1))+"折)",1)])):k("",!0),u.value.discountAmount>0?(c(),b("div",Ee,[e[16]||(e[16]=o("span",null,"优惠金额:",-1)),o("span",Se,"-¥"+i(u.value.discountAmount.toFixed(2)),1)])):k("",!0),p.value&&_.value>0?(c(),b("div",Le,[e[17]||(e[17]=o("span",null,"积分抵扣:",-1)),o("span",ze,"-¥"+i(_.value.toFixed(2)),1)])):k("",!0),o("div",je,[e[18]||(e[18]=o("span",null,"总计:",-1)),o("span",$e,"¥"+i(Q.value.toFixed(2)),1)])])]),_:1})]),_:1},8,["model"])]),_:1}),o("div",Ge,[l(j,{onClick:t.goBack,size:"large"},{default:n(()=>[...e[19]||(e[19]=[x("取消",-1)])]),_:1},8,["onClick"]),l(j,{type:"primary",size:"large",onClick:ee,loading:w.value,disabled:!V.value},{default:n(()=>[...e[20]||(e[20]=[x(" 确认预订 ",-1)])]),_:1},8,["loading","disabled"])])])])}}},Ze=ue(Je,[["__scopeId","data-v-df9772cc"]]);export{Ze as default};
