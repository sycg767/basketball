import{_ as X,r as g,j as T,w as J,c as y,o as w,a as l,e as o,f as m,b as r,u as Y,i as f,E as p,n as se,d as R,g as te,y as L,L as re,K as Q}from"./index-DfALJeeI.js";import{u as de}from"./user-6l3YhxiV.js";import{u as ie,a as ue}from"./user-D_OnkJXJ.js";import{s as O}from"./request-CZtBzr0V.js";import{v as K,c as me,a as pe}from"./validate-CbFD6edE.js";import{S as fe,s as ce}from"./SmsCountdown-nzEWJ3w-.js";function we(B){return O({url:"/api/user/bind/phone",method:"post",data:B})}function _e(){return O({url:"/api/user/bind/phone",method:"delete"})}function ve(){return O({url:"/api/wechat/unbind",method:"delete"})}const ge={class:"code-input-wrapper"},be={__name:"BindPhoneDialog",props:{modelValue:{type:Boolean,default:!1}},emits:["update:modelValue","success"],setup(B,{emit:E}){const N=B,x=E,b=g(!1),P=g(!1),h=g(!1),C=g(null),k=g(null),i=T({phone:"",code:""});J(()=>N.modelValue,t=>{b.value=t,t||D()}),J(b,t=>{x("update:modelValue",t)});const A={phone:[{validator:(t,n,v)=>{n?K(n)?v():v(new Error("请输入正确的手机号")):v(new Error("请输入手机号"))},trigger:"blur"}],code:[{validator:(t,n,v)=>{n?/^\d{6}$/.test(n)?v():v(new Error("请输入6位数字验证码")):v(new Error("请输入验证码"))},trigger:"blur"}]},$=async()=>{var t;if(!i.phone){p.warning("请输入手机号");return}if(!K(i.phone)){p.warning("请输入正确的手机号");return}h.value=!0;try{const n=await ce({phone:i.phone,type:"bind"});n.code===200?(p.success("验证码已发送,请注意查收"),(t=k.value)==null||t.startCountdown()):p.error(n.message||"发送验证码失败")}catch(n){console.error("发送验证码失败:",n),p.error("发送验证码失败,请稍后重试")}finally{h.value=!1}},G=()=>{C.value.validate(async t=>{if(t){P.value=!0;try{const n=await we({phone:i.phone,code:i.code});n.code===200?(p.success("手机号绑定成功"),x("success"),b.value=!1):p.error(n.message||"绑定失败")}catch(n){console.error("绑定手机号失败:",n),p.error("绑定失败,请检查验证码是否正确")}finally{P.value=!1}}})},D=()=>{var t,n;i.phone="",i.code="",(t=C.value)==null||t.clearValidate(),(n=k.value)==null||n.stopCountdown()},M=()=>{D()};return(t,n)=>{const v=m("el-input"),S=m("el-form-item"),z=m("el-form"),I=m("el-button"),W=m("el-dialog");return w(),y(W,{modelValue:b.value,"onUpdate:modelValue":n[3]||(n[3]=V=>b.value=V),title:"绑定手机号",width:"450px","close-on-click-modal":!1,onClose:M},{footer:l(()=>[o(I,{onClick:n[2]||(n[2]=V=>b.value=!1)},{default:l(()=>[...n[4]||(n[4]=[f("取消",-1)])]),_:1}),o(I,{type:"primary",loading:P.value,onClick:G},{default:l(()=>[...n[5]||(n[5]=[f("确认绑定",-1)])]),_:1},8,["loading"])]),default:l(()=>[o(z,{ref_key:"formRef",ref:C,model:i,rules:A,"label-width":"0"},{default:l(()=>[o(S,{prop:"phone"},{default:l(()=>[o(v,{modelValue:i.phone,"onUpdate:modelValue":n[0]||(n[0]=V=>i.phone=V),placeholder:"请输入手机号",size:"large","prefix-icon":"Iphone",maxlength:"11"},null,8,["modelValue"])]),_:1}),o(S,{prop:"code"},{default:l(()=>[r("div",ge,[o(v,{modelValue:i.code,"onUpdate:modelValue":n[1]||(n[1]=V=>i.code=V),placeholder:"请输入验证码",size:"large","prefix-icon":"Message",maxlength:"6"},null,8,["modelValue"]),o(fe,{ref_key:"smsCountdownRef",ref:k,disabled:!i.phone||!Y(K)(i.phone),loading:h.value,text:"发送验证码",class:"send-code-btn",onSend:$},null,8,["disabled","loading"])])]),_:1})]),_:1},8,["model"])]),_:1},8,["modelValue"])}}},ye=X(be,[["__scopeId","data-v-2faab6ce"]]),Ve={class:"profile-container"},Pe={class:"binding-section"},he={class:"binding-item"},Ce={class:"binding-info"},ke={class:"binding-icon"},Ue={class:"binding-content"},xe={key:0,class:"binding-value"},Re={key:1,class:"binding-placeholder"},Be={class:"binding-action"},Ee={class:"binding-item"},Ne={class:"binding-info"},Se={class:"binding-content"},Ie={key:0,class:"binding-value"},Fe={key:1,class:"binding-placeholder"},Le={class:"binding-action"},Te={__name:"Profile",setup(B){const E=de(),N=g("info"),x=g(null),b=g(null),P=g(!1),h=g(!1),C=g(!1),k=g(!1),i=T({nickname:"",avatar:""}),a=T({username:"",realName:"",phone:"",email:"",gender:0,memberLevel:0,points:0,balance:0}),c=T({oldPassword:"",newPassword:"",confirmPassword:""}),$={email:[{validator:(s,e,u)=>{e&&!me(e)?u(new Error("请输入正确的邮箱格式")):u()},trigger:"blur"}]},M={oldPassword:[{required:!0,message:"请输入原密码",trigger:"blur"}],newPassword:[{validator:(s,e,u)=>{e?pe(e)?u():u(new Error("密码长度为6-20位")):u(new Error("请输入新密码"))},trigger:"blur"}],confirmPassword:[{validator:(s,e,u)=>{e?e!==c.newPassword?u(new Error("两次输入的密码不一致")):u():u(new Error("请确认密码"))},trigger:"blur"}]},t=async()=>{try{await E.getUserInfo(),Object.assign(a,E.userInfo)}catch(s){console.error("获取用户信息失败",s)}},n=()=>{x.value.validate(async s=>{if(s){P.value=!0;try{await ie({realName:a.realName,email:a.email,gender:a.gender}),p.success("保存成功"),await t()}catch(e){console.error("保存失败",e)}finally{P.value=!1}}})},v=()=>{b.value.validate(async s=>{if(s){h.value=!0;try{await ue({oldPassword:c.oldPassword,newPassword:c.newPassword}),p.success("密码修改成功"),c.oldPassword="",c.newPassword="",c.confirmPassword="",b.value.resetFields()}catch(e){console.error("密码修改失败",e)}finally{h.value=!1}}})},S=s=>s?s.replace(/(\d{3})\d{4}(\d{4})/,"$1****$2"):"",z=()=>{C.value=!0},I=()=>{t()},W=async()=>{try{await Q.confirm("解绑后将无法使用手机号登录,确定要解绑吗?","确认解绑",{confirmButtonText:"确定",cancelButtonText:"取消",type:"warning"});const s=await _e();s.code===200?(p.success("手机号解绑成功"),await t()):p.error(s.message||"解绑失败")}catch(s){s!=="cancel"&&(console.error("解绑手机号失败:",s),p.error("解绑失败,请稍后重试"))}},V=()=>{p.info("微信绑定功能开发中")},Z=async()=>{try{await Q.confirm("确定要解绑微信账号吗?","确认解绑",{confirmButtonText:"确定",cancelButtonText:"取消",type:"warning"});const s=await ve();s.code===200?(p.success("微信解绑成功"),k.value=!1,i.nickname="",i.avatar=""):p.error(s.message||"解绑失败")}catch(s){s!=="cancel"&&(console.error("解绑微信失败:",s),p.error("解绑失败,请稍后重试"))}};return se(()=>{t()}),(s,e)=>{const u=m("el-input"),_=m("el-form-item"),j=m("el-radio"),ee=m("el-radio-group"),F=m("el-tag"),U=m("el-button"),H=m("el-form"),q=m("el-tab-pane"),oe=m("el-icon"),le=m("el-divider"),ne=m("el-tabs"),ae=m("el-card");return w(),R("div",Ve,[e[26]||(e[26]=r("div",{class:"profile-header"},[r("h2",null,"个人中心")],-1)),o(ae,{class:"profile-card"},{default:l(()=>[o(ne,{modelValue:N.value,"onUpdate:modelValue":e[8]||(e[8]=d=>N.value=d)},{default:l(()=>[o(q,{label:"基本信息",name:"info"},{default:l(()=>[o(H,{ref_key:"infoFormRef",ref:x,model:a,rules:$,"label-width":"100px"},{default:l(()=>[o(_,{label:"用户名"},{default:l(()=>[o(u,{modelValue:a.username,"onUpdate:modelValue":e[0]||(e[0]=d=>a.username=d),disabled:""},null,8,["modelValue"])]),_:1}),o(_,{label:"真实姓名",prop:"realName"},{default:l(()=>[o(u,{modelValue:a.realName,"onUpdate:modelValue":e[1]||(e[1]=d=>a.realName=d),placeholder:"请输入真实姓名"},null,8,["modelValue"])]),_:1}),o(_,{label:"手机号"},{default:l(()=>[o(u,{modelValue:a.phone,"onUpdate:modelValue":e[2]||(e[2]=d=>a.phone=d),disabled:""},null,8,["modelValue"])]),_:1}),o(_,{label:"邮箱",prop:"email"},{default:l(()=>[o(u,{modelValue:a.email,"onUpdate:modelValue":e[3]||(e[3]=d=>a.email=d),placeholder:"请输入邮箱"},null,8,["modelValue"])]),_:1}),o(_,{label:"性别"},{default:l(()=>[o(ee,{modelValue:a.gender,"onUpdate:modelValue":e[4]||(e[4]=d=>a.gender=d)},{default:l(()=>[o(j,{label:0},{default:l(()=>[...e[10]||(e[10]=[f("未知",-1)])]),_:1}),o(j,{label:1},{default:l(()=>[...e[11]||(e[11]=[f("男",-1)])]),_:1}),o(j,{label:2},{default:l(()=>[...e[12]||(e[12]=[f("女",-1)])]),_:1})]),_:1},8,["modelValue"])]),_:1}),o(_,{label:"会员等级"},{default:l(()=>[a.memberLevel===0?(w(),y(F,{key:0},{default:l(()=>[...e[13]||(e[13]=[f("普通会员",-1)])]),_:1})):a.memberLevel===1?(w(),y(F,{key:1,type:"info"},{default:l(()=>[...e[14]||(e[14]=[f("银卡会员",-1)])]),_:1})):a.memberLevel===2?(w(),y(F,{key:2,type:"warning"},{default:l(()=>[...e[15]||(e[15]=[f("金卡会员",-1)])]),_:1})):a.memberLevel===3?(w(),y(F,{key:3,type:"danger"},{default:l(()=>[...e[16]||(e[16]=[f("钻石会员",-1)])]),_:1})):te("",!0)]),_:1}),o(_,{label:"积分"},{default:l(()=>[r("span",null,L(a.points||0),1)]),_:1}),o(_,{label:"余额"},{default:l(()=>[r("span",null,"¥"+L(a.balance||0),1)]),_:1}),o(_,null,{default:l(()=>[o(U,{type:"primary",loading:P.value,onClick:n},{default:l(()=>[...e[17]||(e[17]=[f(" 保存修改 ",-1)])]),_:1},8,["loading"])]),_:1})]),_:1},8,["model"])]),_:1}),o(q,{label:"修改密码",name:"password"},{default:l(()=>[o(H,{ref_key:"passwordFormRef",ref:b,model:c,rules:M,"label-width":"100px"},{default:l(()=>[o(_,{label:"原密码",prop:"oldPassword"},{default:l(()=>[o(u,{modelValue:c.oldPassword,"onUpdate:modelValue":e[5]||(e[5]=d=>c.oldPassword=d),type:"password",placeholder:"请输入原密码","show-password":""},null,8,["modelValue"])]),_:1}),o(_,{label:"新密码",prop:"newPassword"},{default:l(()=>[o(u,{modelValue:c.newPassword,"onUpdate:modelValue":e[6]||(e[6]=d=>c.newPassword=d),type:"password",placeholder:"请输入新密码（6-20位）","show-password":""},null,8,["modelValue"])]),_:1}),o(_,{label:"确认密码",prop:"confirmPassword"},{default:l(()=>[o(u,{modelValue:c.confirmPassword,"onUpdate:modelValue":e[7]||(e[7]=d=>c.confirmPassword=d),type:"password",placeholder:"请再次输入新密码","show-password":""},null,8,["modelValue"])]),_:1}),o(_,null,{default:l(()=>[o(U,{type:"primary",loading:h.value,onClick:v},{default:l(()=>[...e[18]||(e[18]=[f(" 修改密码 ",-1)])]),_:1},8,["loading"])]),_:1})]),_:1},8,["model"])]),_:1}),o(q,{label:"账号绑定",name:"binding"},{default:l(()=>[r("div",Pe,[r("div",he,[r("div",Ce,[r("div",ke,[o(oe,{size:24},{default:l(()=>[o(Y(re))]),_:1})]),r("div",Ue,[e[19]||(e[19]=r("h4",null,"手机号",-1)),a.phone?(w(),R("p",xe,L(S(a.phone)),1)):(w(),R("p",Re,"未绑定"))])]),r("div",Be,[a.phone?(w(),y(U,{key:0,type:"danger",plain:"",onClick:W},{default:l(()=>[...e[20]||(e[20]=[f(" 解绑 ",-1)])]),_:1})):(w(),y(U,{key:1,type:"primary",onClick:z},{default:l(()=>[...e[21]||(e[21]=[f(" 绑定 ",-1)])]),_:1}))])]),o(le),r("div",Ee,[r("div",Ne,[e[23]||(e[23]=r("div",{class:"binding-icon wechat"},[r("svg",{class:"icon","aria-hidden":"true"},[r("use",{"xlink:href":"#icon-wechat"})])],-1)),r("div",Se,[e[22]||(e[22]=r("h4",null,"微信账号",-1)),k.value?(w(),R("p",Ie,L(i.nickname||"已绑定"),1)):(w(),R("p",Fe,"未绑定"))])]),r("div",Le,[k.value?(w(),y(U,{key:0,type:"danger",plain:"",onClick:Z},{default:l(()=>[...e[24]||(e[24]=[f(" 解绑 ",-1)])]),_:1})):(w(),y(U,{key:1,type:"success",onClick:V},{default:l(()=>[...e[25]||(e[25]=[f(" 绑定 ",-1)])]),_:1}))])])])]),_:1})]),_:1},8,["modelValue"])]),_:1}),o(ye,{modelValue:C.value,"onUpdate:modelValue":e[9]||(e[9]=d=>C.value=d),onSuccess:I},null,8,["modelValue"])])}}},qe=X(Te,[["__scopeId","data-v-fb55e5db"]]);export{qe as default};
